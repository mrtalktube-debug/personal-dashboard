<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Dashboard - Michael</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --p-blue: #0073b1; --bg: linear-gradient(135deg, #001a33 0%, #000a14 100%); }
        body { background: var(--bg); min-height: 100vh; font-family: 'Inter', sans-serif; margin: 0; color: #1a1a1a; }
        .widget { background: rgba(255,255,255,0.98); border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .settings-panel { position: fixed; right: 0; top: 0; height: 100vh; width: 100%; max-width: 480px; background: white; z-index: 100; box-shadow: -10px 0 30px rgba(0,0,0,0.5); transform: translateX(100%); transition: 0.3s ease; overflow-y: auto; }
        .settings-panel.open { transform: translateX(0); }
        .sparkline-bg { position: absolute; bottom: 0; left: 0; right: 0; height: 40px; opacity: 0.08; background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 30" xmlns="http://www.w3.org/2000/svg"><path d="M0 30 L10 20 L20 25 L30 15 L40 18 L50 5 L60 10 L70 2 L80 12 L90 5 L100 0 L100 30 Z" fill="%230073b1"/></svg>'); background-size: cover; background-position: bottom; pointer-events: none; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--p-blue); border-radius: 4px; }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

// ----- AUTH & CONFIG -----
const GOOGLE_CLIENT_ID = "196901777247-3ak09abjpa3dm5908a5f8m08d4o7gqj8.apps.googleusercontent.com";
const ALLOWED_EMAIL = "diabaas3@gmail.com"; 
// -------------------------

const S = {
    load: (k, d) => { try { const v = localStorage.getItem('d_'+k); return v ? JSON.parse(v) : d; } catch(e) { return d; } },
    save: (k, v) => localStorage.setItem('d_'+k, JSON.stringify(v)),
    remove: (k) => localStorage.removeItem('d_'+k)
};

const Ico = {
    Set: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
    Lock: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/></svg>,
    Cal: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>,
    Cry: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
    Bot: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>,
    Nws: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
};

// --- AI WIDGET ---
function AIWidget() {
    const [msg, setMsg] = useState('');
    const [hist, setHist] = useState(S.load('ai_hist', [{r: 'ai', t: 'Welkom Michael. Hoe kan ik helpen?'} ]));
    const send = async () => {
        if(!msg) return; const n = [...hist, {r: 'usr', t: msg}]; setHist(n); S.save('ai_hist', n); setMsg('');
        const key = (S.load('api_keys_dyn', []).find(a => a.name.toLowerCase().includes('openai')) || {}).val;
        if (key) {
            try {
                const res = await fetch('https://api.openai.com/v1/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` }, body: JSON.stringify({ model: 'gpt-3.5-turbo', messages: [{role: 'user', content: msg}] }) });
                const data = await res.json();
                if(data.choices) { const r = [...n, {r: 'ai', t: data.choices[0].message.content}]; setHist(r); S.save('ai_hist', r); }
            } catch(e) { setHist([...n, {r: 'ai', t: 'API Error.'}]); }
        } else { setHist([...n, {r: 'ai', t: 'Geen OpenAI key ingesteld.'}]); }
    };
    return (
        <div className="widget h-[300px] p-4 bg-white">
            <div className="flex items-center gap-2 text-slate-500 mb-4"><Ico.Bot/><h3 className="text-[10px] font-black uppercase">AI Assistent</h3></div>
            <div className="flex-1 overflow-y-auto mb-4 space-y-2 hide-scroll">{hist.map((m,i)=><div key={i} className={`text-xs p-2 rounded ${m.r==='ai'?'bg-gray-100':'bg-blue-600 text-white self-end'}`}>{m.t}</div>)}</div>
            <div className="flex gap-2"><input value={msg} onChange={e=>setMsg(e.target.value)} onKeyPress={e=>e.key==='Enter'&&send()} className="flex-1 border-b text-xs outline-none p-1" placeholder="Vraag iets..."/><button onClick={send} className="text-blue-600 font-bold text-xs">VERZEND</button></div>
        </div>
    );
}

// --- AGENDA WIDGET ---
function AgendaWidget() {
    const rawCals = S.load('icals_dyn', [{name: 'Ryan', val: ''}, {name: 'Yaron', val: ''}, {name: 'Michael', val: ''}, {name: 'Fam-Sch', val: ''}]);
    const cals = rawCals.map(c => c.name).filter(Boolean);
    const [d, setD] = useState(new Date().toISOString().split('T')[0]); 
    const [f, setF] = useState(cals);
    const [searchTerm, setSearchTerm] = useState('');
    const [showJump, setShowJump] = useState(false);
    const [items, setItems] = useState([]);

    const getWeekNumber = (date) => {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        return Math.ceil((((d - new Date(Date.UTC(d.getUTCFullYear(),0,1))) / 86400000) + 1) / 7);
    };

    const getFullDateString = (dateStr) => {
        const date = new Date(dateStr);
        return `${date.toLocaleDateString('nl-NL', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })} (Week ${getWeekNumber(date)})`;
    };

    useEffect(() => {
        const fetchCals = async () => {
            let allEvs = [];
            for(let c of rawCals) {
                if(!c.val) continue;
                try {
                    const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(c.val)}`);
                    const txt = await res.text();
                    let cur = {}; const lines = txt.split(/\r?\n/);
                    for(let l of lines) {
                        if(l.startsWith('BEGIN:VEVENT')) cur = {};
                        else if(l.startsWith('SUMMARY:')) cur.t = l.substring(8);
                        else if(l.startsWith('DTSTART')) { 
                            const m = l.match(/:(\d{4})(\d{2})(\d{2})T?(\d{2})?(\d{2})?/); 
                            if(m) { cur.date = `${m[1]}-${m[2]}-${m[3]}`; cur.time = m[4] ? `${m[4]}:${m[5]}` : '00:00'; } 
                        }
                        else if(l.startsWith('END:VEVENT') && cur.t && cur.date) allEvs.push({...cur, p: c.name, source: (c.name==='Michael'?'Outlook':'Magister')});
                    }
                } catch(e) {}
            }
            if(allEvs.length === 0) allEvs = [{ t: 'Wiskunde', p: 'Ryan', date: '2026-02-19', time: '09:00', source: 'Magister' }];
            setItems(allEvs);
        };
        fetchCals();
    }, [JSON.stringify(rawCals)]);

    const filteredItems = items.filter(i => f.includes(i.p) && i.date === d && i.t.toLowerCase().includes(searchTerm.toLowerCase())).sort((a,b) => a.time.localeCompare(b.time));

    return (
        <div className="widget h-full p-5 bg-white">
            <div className="flex justify-between items-center mb-5">
                <div className="flex items-center gap-2 text-slate-500"><Ico.Cal/><h3 className="text-[10px] font-black uppercase tracking-widest">Familie Agenda</h3></div>
                <div className="flex gap-2">
                    <button onClick={() => setShowJump(!showJump)} className="bg-gray-100 text-gray-600 px-3 py-1.5 rounded text-[9px] font-black uppercase">Kies Datum</button>
                    <button onClick={() => setD(new Date().toISOString().split('T')[0])} className="bg-blue-600 text-white px-3 py-1.5 rounded text-[9px] font-black uppercase">Vandaag</button>
                </div>
            </div>
            {showJump && <div className="mb-4 p-3 bg-gray-50 rounded border flex gap-2"><input type="date" value={d} onChange={e=>setD(e.target.value)} className="flex-1 p-2 rounded text-xs border outline-none"/><button onClick={()=>setShowJump(false)} className="px-3 py-2 bg-gray-800 text-white rounded text-[10px] font-black">OK</button></div>}
            <div className="text-center mb-6">
                <div className="flex items-center justify-between text-blue-600 font-black text-xs uppercase mb-1">
                    <button onClick={() => {const nd=new Date(d); nd.setDate(nd.getDate()-1); setD(nd.toISOString().split('T')[0])}}>‹</button>
                    <span>{getFullDateString(new Date(d))}</span>
                    <button onClick={() => {const nd=new Date(d); nd.setDate(nd.getDate()+1); setD(nd.toISOString().split('T')[0])}}>›</button>
                </div>
                <input type="text" placeholder="Zoeken..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full mt-3 p-2 border-b text-xs outline-none focus:border-blue-400 bg-transparent" />
            </div>
            <div className="flex gap-2 overflow-x-auto pb-4 hide-scroll">
                {['Ryan', 'Yaron', 'Michael', 'Fam-Sch'].map((name, i) => (
                    <button key={name} onClick={() => setF(f.includes(name)?f.filter(x=>x!==name):[...f, name])} className={`px-3 py-1 rounded-full border text-[9px] font-black uppercase ${f.includes(name)?'border-blue-400 text-blue-600 bg-white':'border-gray-100 text-gray-300'}`}>{name}</button>
                ))}
            </div>
            <div className="space-y-4 max-h-[300px] overflow-y-auto pr-2 mb-6">
                {filteredItems.map((i, idx) => (
                    <div key={idx} className="flex items-start gap-3 py-1">
                        <div className={`w-1 h-10 rounded-full shrink-0 ${i.p==='Ryan'?'bg-red-400':i.p==='Yaron'?'bg-blue-400':i.p==='Michael'?'bg-green-400':'bg-purple-400'}`}></div>
                        <div className="flex-1">
                            <h4 className="font-bold text-slate-800 text-xs">{i.t}</h4>
                            <p className="text-gray-400 text-[9px] font-black uppercase">{i.time} · {i.p}</p>
                        </div>
                    </div>
                ))}
            </div>
            <div className="mt-auto pt-4 border-t">
                <p className="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-3">Schooltijden Vandaag</p>
                <div className="grid grid-cols-2 gap-3">
                    <div className="bg-red-50 p-2 rounded border border-red-100"><p className="text-red-600 font-black text-[10px]">RYAN</p><p className="text-slate-700 font-bold text-xs">8:10 – 16:30</p></div>
                    <div className="bg-blue-50 p-2 rounded border border-blue-100"><p className="text-blue-600 font-black text-[10px]">YARON</p><p className="text-slate-700 font-bold text-xs">9:45 – 12:30</p></div>
                </div>
            </div>
        </div>
    );
}

// --- BITVAVO WIDGET ---
function CryptoWidget() {
    const [portfolio, setPortfolio] = useState([]);
    const [total, setTotal] = useState(0);
    const [loading, setLoading] = useState(true);
    useEffect(() => {
        const fetchBitvavo = async () => {
            const bvKeys = S.load('bitvavo_keys', {pub: '', sec: ''});
            if(!bvKeys.pub || !bvKeys.sec) { setLoading(false); return; }
            try {
                const res = await fetch('/api/bitvavo', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ key: bvKeys.pub, secret: bvKeys.sec }) });
                const data = await res.json();
                let calcTotal = 0;
                const combined = data.balances.map(b => {
                    const amount = parseFloat(b.available) + parseFloat(b.inOrder);
                    const price = data.prices.find(p => p.market === `${b.symbol}-EUR`)?.price || 0;
                    calcTotal += amount * price;
                    return { sym: b.symbol, val: amount * price };
                }).filter(x=>x.val>1).sort((a,b)=>b.val-a.val);
                setPortfolio(combined); setTotal(calcTotal);
            } catch (e) {}
            setLoading(false);
        };
        fetchBitvavo();
    }, []);
    return (
        <div className="widget h-full p-6 bg-white">
            <div className="flex items-center gap-2 mb-6 text-slate-500"><Ico.Cry/><h3 className="text-[10px] font-black uppercase tracking-widest">Live Portfolio</h3></div>
            <div className="mb-6"><span className="text-[10px] font-bold text-gray-400 block mb-1 uppercase">Totaal</span><div className="text-3xl font-black text-slate-800">€{total.toLocaleString('nl-NL', {maximumFractionDigits:0})}</div></div>
            <div className="space-y-2 overflow-y-auto flex-1 hide-scroll">{portfolio.map((c,i)=>(<div key={i} className="flex justify-between items-center p-2 bg-gray-50 rounded"><span className="font-black text-xs">{c.sym}</span><span className="font-bold text-xs">€{c.val.toLocaleString('nl-NL',{maximumFractionDigits:0})}</span></div>))}</div>
        </div>
    );
}

// --- NIEUWS WIDGET ---
function NewsWidget() {
    return (
        <div className="widget h-[300px] p-4 bg-white">
            <div className="flex items-center gap-2 text-slate-500 mb-4"><Ico.Nws/><h3 className="text-[10px] font-black uppercase">Nieuws & Updates</h3></div>
            <div className="space-y-4 overflow-y-auto hide-scroll">
                <div className="border-b pb-2"><p className="text-xs font-bold">Bitcoin breekt recordhoogte.</p><span className="text-[9px] text-gray-400 uppercase">Crypto · 1u geleden</span></div>
                <div className="border-b pb-2"><p className="text-xs font-bold">Nieuwe AI-wetgeving in EU.</p><span className="text-[9px] text-gray-400 uppercase">Tech · 3u geleden</span></div>
            </div>
        </div>
    );
}

function Settings({ isOpen, onClose }) {
    const [bvKeys, setBvKeys] = useState(S.load('bitvavo_keys', {pub: '', sec: ''}));
    const [apis, setApis] = useState(S.load('api_keys_dyn', [{name: 'OpenAI', val: ''}]));
    const [icals, setIcals] = useState(S.load('icals_dyn', [{name: 'Ryan', val: ''}, {name: 'Yaron', val: ''}, {name: 'Michael', val: ''}, {name: 'Fam-Sch', val: ''}]));
    const saveAll = () => { S.save('bitvavo_keys', bvKeys); S.save('api_keys_dyn', apis); S.save('icals_dyn', icals); onClose(); window.location.reload(); };
    return (
        <div className={`settings-panel p-8 ${isOpen ? 'open' : ''}`}>
            <h2 className="text-2xl font-black mb-8 border-b pb-4 uppercase tracking-tighter">Instellingen</h2>
            <div className="space-y-8">
                <section><h3 className="text-[10px] font-black text-blue-600 uppercase mb-2">Bitvavo API</h3><input type="text" placeholder="API Key" value={bvKeys.pub} onChange={e=>setBvKeys({...bvKeys, pub: e.target.value})} className="w-full p-2 border rounded mb-2 text-xs"/><input type="password" placeholder="API Secret" value={bvKeys.sec} onChange={e=>setBvKeys({...bvKeys, sec: e.target.value})} className="w-full p-2 border rounded text-xs"/></section>
                <section><h3 className="text-[10px] font-black text-blue-600 uppercase mb-2">OpenAI Key</h3><input type="password" value={apis[0].val} onChange={e=>{const n=[...apis]; n[0].val=e.target.value; setApis(n);}} className="w-full p-2 border rounded text-xs"/></section>
                <section><h3 className="text-[10px] font-black text-blue-600 uppercase mb-2">Agenda Links</h3>{icals.map((c, i) => (<div key={i} className="flex gap-2 mb-2"><input placeholder="Naam" value={c.name} onChange={e=>{const n=[...icals]; n[i].name=e.target.value; setIcals(n);}} className="w-1/4 p-2 border rounded text-[10px] font-black"/><input placeholder="https://..." value={c.val} onChange={e=>{const n=[...icals]; n[i].val=e.target.value; setIcals(n);}} className="flex-1 p-2 border rounded text-[10px] font-mono"/></div>))}</section>
            </div>
            <button onClick={saveAll} className="mt-10 w-full bg-slate-900 text-white py-4 text-[10px] font-black uppercase rounded shadow-xl hover:bg-black">Opslaan & Herladen</button>
        </div>
    );
}

function App() {
    const [isAuth, setIsAuth] = useState(S.load('auth_status', false));
    const [settingsOpen, setSettingsOpen] = useState(false);
    useEffect(() => { if (!isAuth && window.google) { window.google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse }); window.google.accounts.id.renderButton(document.getElementById("google-btn"), { theme: "filled_blue", size: "large", shape: "pill" }); } }, [isAuth]);
    const handleCredentialResponse = (response) => {
        const payload = JSON.parse(atob(response.credential.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
        if(payload.email.toLowerCase() === ALLOWED_EMAIL.toLowerCase()) { setIsAuth(true); S.save('auth_status', true); } 
        else { alert("Geen toegang."); }
    };
    if (!isAuth) return <div className="min-h-screen flex items-center justify-center bg-[#000a14]"><div className="bg-white/5 p-12 rounded-2xl border border-white/10 flex flex-col items-center"><Ico.Lock /><h1 className="text-xl font-black mt-6 mb-8 text-white uppercase tracking-widest">Michael Dashboard</h1><div id="google-btn"></div></div></div>;
    return (
        <div className="flex flex-col min-h-screen pb-20">
            <header className="px-6 py-10 max-w-[1600px] mx-auto w-full flex justify-between items-end border-b border-white/10 mb-10">
                <div><h1 className="text-2xl font-black text-white tracking-tighter uppercase leading-none">Michael Dashboard</h1><p className="text-blue-400 text-[9px] font-black uppercase tracking-[0.5em] mt-3">Live Intelligence System</p></div>
                <div className="flex gap-3"><button onClick={() => {setIsAuth(false); S.remove('auth_status'); window.location.reload();}} className="p-3 bg-red-500/10 text-red-500 rounded hover:bg-red-500/20 transition"><Ico.Lock /></button><button onClick={() => setSettingsOpen(true)} className="p-3 bg-white/10 text-white rounded hover:bg-white/20 transition"><Ico.Set /></button></div>
            </header>
            <main className="px-6 max-w-[1600px] mx-auto w-full grid grid-cols-12 gap-6">
                <div className="col-span-12 lg:col-span-8 h-fit"><AgendaWidget /></div>
                <div className="col-span-12 lg:col-span-4 space-y-6"><CryptoWidget /><AIWidget /><NewsWidget /></div>
            </main>
            <Settings isOpen={settingsOpen} onClose={() => setSettingsOpen(false)} />
        </div>
    );
}
ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>