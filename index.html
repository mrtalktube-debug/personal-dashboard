<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Dashboard - Michael</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --p-blue: #0073b1; --bg: linear-gradient(135deg, #001a33 0%, #000a14 100%); }
        body { background: var(--bg); min-height: 100vh; font-family: 'Inter', sans-serif; margin: 0; color: #1a1a1a; }
        .widget { background: rgba(255,255,255,0.98); border-radius: 6px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .tab-btn { font-size: 0.65rem; font-weight: 800; padding: 10px; color: #666; border-bottom: 2px solid transparent; text-transform: uppercase; flex: 1; transition: 0.2s; text-align: center; cursor: pointer; }
        .tab-btn.active { color: var(--p-blue); border-bottom-color: var(--p-blue); background: rgba(0,115,177,0.05); }
        .sudoku-container { width: 100%; max-width: 320px; aspect-ratio: 1/1; margin: 0 auto; display: grid; grid-template-columns: repeat(9, 1fr); border: 2px solid #1a1a1a; background: white; }
        .sudoku-cell { width: 100%; height: 100%; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.1s; position: relative; user-select: none; }
        .sudoku-cell.selected { background: #e0f2fe; border-color: var(--p-blue); z-index: 10; }
        .sudoku-cell.fixed { background: #f8fafc; font-weight: 900; color: #1e293b; font-size: 1.1rem; }
        .sudoku-cell.input { font-weight: 700; color: var(--p-blue); font-size: 1.2rem; }
        .sudoku-candidates { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); width: 100%; height: 100%; font-size: 0.45rem; line-height: 1; color: #64748b; padding: 1px; }
        .border-r-thick { border-right: 2px solid #1a1a1a !important; }
        .border-b-thick { border-bottom: 2px solid #1a1a1a !important; }
        .settings-panel { position: fixed; right: 0; top: 0; height: 100vh; width: 100%; max-width: 480px; background: white; z-index: 100; box-shadow: -10px 0 30px rgba(0,0,0,0.5); transform: translateX(100%); transition: 0.3s ease; overflow-y: auto; }
        .settings-panel.open { transform: translateX(0); }
        .sparkline-bg { position: absolute; bottom: 0; left: 0; right: 0; height: 40px; opacity: 0.08; background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 30" xmlns="http://www.w3.org/2000/svg"><path d="M0 30 L10 20 L20 25 L30 15 L40 18 L50 5 L60 10 L70 2 L80 12 L90 5 L100 0 L100 30 Z" fill="%230073b1"/></svg>'); background-size: cover; background-position: bottom; pointer-events: none; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--p-blue); border-radius: 4px; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .ai-transition { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useMemo } = React;

const GOOGLE_CLIENT_ID = "196901777247-3ak09abjpa3dm5908a5f8m08d4o7gqj8.apps.googleusercontent.com";
const ALLOWED_EMAIL = "diabaas3@gmail.com"; 

const S = {
    load: (k, d) => { try { const v = localStorage.getItem('d_'+k); return v ? JSON.parse(v) : d; } catch(e) { return d; } },
    save: (k, v) => localStorage.setItem('d_'+k, JSON.stringify(v)),
    remove: (k) => localStorage.removeItem('d_'+k)
};

const emitCmd = (type, payload) => window.dispatchEvent(new CustomEvent('dashCmd', { detail: { type, payload } }));
const fmtDate = (dStr) => { const p = dStr.split('-'); return p.length===3 ? `${p[2]}-${p[1]}-${p[0]}` : dStr; };

const T = {
    nl: { port: 'Portfolio', ag: 'Agenda', nws: 'Nieuws', rad: 'Investeringen', deal: 'Pepper Deals', rec: 'Recepten', lang: 'Talen', day: 'DAG', wk: 'WEEK', src: 'BRON', blk: 'BLOCK', cal: 'Kalender', std: 'Stand', lst: 'Laatste', new: 'Nieuw Spel' },
    en: { port: 'Portfolio', ag: 'Schedule', nws: 'News', rad: 'Investments', deal: 'Deals', rec: 'Recipes', lang: 'Languages', day: 'DAY', wk: 'WEEK', src: 'SOURCE', blk: 'BLOCK', cal: 'Calendar', std: 'Standings', lst: 'Latest', new: 'New Game' }
};

const Ico = {
    Set: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
    Wea: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>,
    Loc: () => <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
    Bot: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>,
    Cry: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
    Cal: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>,
    Nws: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>,
    Rad: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>,
    Tag: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>,
    F1: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/></svg>,
    Glf: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path strokeWidth="2" d="M12 18a6 6 0 100-12 6 6 0 000 12z"/></svg>,
    Trp: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 4v2a4 4 0 01-8 0V4m12 4v2a4 4 0 01-1 2.652M4 8v2a4 4 0 001 2.652M12 20v-4m0 0V11m0 5h-4m4 0h4" /></svg>,
    Lng: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 11.37 9.198 15.299 6 18.5"/></svg>,
    Fod: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>,
    Sud: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M4 6h16M4 10h16M4 14h16M4 18h16M10 4v16M14 4v16"/></svg>,
    Spk: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>,
    Trs: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>,
    Ref: () => <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>,
    Clip: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>,
    Up: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M5 15l7-7 7 7"/></svg>,
    Dn: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M19 9l-7 7-7-7"/></svg>,
    Drag: () => <svg className="w-4 h-4 text-gray-400 cursor-move" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 8h16M4 16h16" /></svg>,
    Lock: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/></svg>,
    Pepper: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
};

function WeatherBar({ lang }) {
    const [c, setC] = useState(S.load('wcity', 'Zoetermeer'));
    const [w, setW] = useState(null);
    const [locLoading, setLocLoading] = useState(false);

    useEffect(() => { const h = (e) => { if(e.detail.type === 'SET_CITY') { setC(e.detail.payload); S.save('wcity', e.detail.payload); }}; window.addEventListener('dashCmd', h); return () => window.removeEventListener('dashCmd', h); }, []);
    
    useEffect(() => {
        fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${c}&count=1&language=${lang}`).then(r=>r.json()).then(d=>{
            if(d.results){
                const { latitude:lat, longitude:lon, name } = d.results[0];
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,precipitation&hourly=precipitation_probability&timezone=auto`)
                .then(r=>r.json()).then(wd => { const ch=new Date().getHours(); let rf=null; for(let i=ch; i<ch+12; i++) { if(wd.hourly.precipitation_probability[i]>30){rf=i-ch;break;} } setW({ t: Math.round(wd.current.temperature_2m), f: Math.round(wd.current.apparent_temperature), rain: rf, name }); });
            }
        });
    }, [c, lang]);

    const handleLocate = () => {
        if(!navigator.geolocation) return alert('Geolocatie wordt niet ondersteund door je browser.');
        setLocLoading(true);
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const { latitude, longitude } = pos.coords;
            try {
                const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=${lang}`);
                const data = await res.json();
                const newCity = data.city || data.locality || 'Amsterdam';
                setC(newCity);
                S.save('wcity', newCity);
            } catch(e) {
                console.error("Locatiefout:", e);
            }
            setLocLoading(false);
        }, () => {
            alert('Toegang tot locatie geweigerd.');
            setLocLoading(false);
        });
    };

    return (
        <div className="bg-white/10 px-4 md:px-10 py-3 border-b border-white/10 flex justify-between items-center text-white text-xs font-bold uppercase tracking-widest">
            <div className="flex gap-4 md:gap-8 items-center w-full">
                <div className="flex items-center gap-1.5">
                    <div className="flex items-center gap-2 cursor-pointer hover:text-blue-300 transition" onClick={()=>{const n=prompt(lang==='nl'?"Stad:":"City:",c);if(n){setC(n);S.save('wcity',n);}}}>
                        <Ico.Wea/> <span className="hidden md:inline">{w?.name||c}</span>
                    </div>
                    <button onClick={handleLocate} className={`p-1 bg-white/10 rounded hover:bg-white/20 transition ${locLoading ? 'animate-pulse text-blue-300' : ''}`} title="Gebruik huidige locatie">
                        <Ico.Loc />
                    </button>
                </div>
                <div className="flex gap-3 md:gap-4 items-center"><span className="text-sm md:text-lg">{w?.t}Â°C</span><span className="opacity-60 text-[10px] md:text-xs">{lang==='nl'?'Gevoel':'Feels'}: {w?.f}Â°C</span></div>
                <div className="ml-auto bg-blue-500/20 px-3 py-1.5 rounded flex items-center gap-2"><span className="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span><span className="hidden md:inline">{w?.rain === 0 ? (lang==='nl'?"Nu regen":"Raining") : w?.rain ? (lang==='nl'?`Regen over ${w.rain}u`:`Rain in ${w.rain}h`) : (lang==='nl'?"Geen regen verwacht":"No rain expected")}</span><span className="md:hidden">{w?.rain===0?"Regen":w?.rain?`${w.rain}u`:"Droog"}</span></div>
            </div>
        </div>
    );
}

function DailyBriefing({ lang }) {
    const hour = new Date().getHours();
    let greetingNL = hour >= 6 && hour < 12 ? 'Goedemorgen' : hour >= 12 && hour < 18 ? 'Goedemiddag' : 'Goedenavond';
    let greetingEN = hour >= 6 && hour < 12 ? 'Good morning' : hour >= 12 && hour < 18 ? 'Good afternoon' : 'Good evening';
    const dynamicGreeting = lang === 'nl' ? greetingNL : greetingEN;

    return (
        <div className="bg-blue-600/20 border border-blue-500/30 text-blue-100 rounded-lg p-4 mb-6 flex flex-col md:flex-row items-center gap-4 shadow-lg backdrop-blur-md">
            <div className="bg-blue-500 p-2 rounded-full text-white shrink-0"><Ico.Bot /></div>
            <div className="text-sm font-medium leading-relaxed">
                <span className="font-bold">{dynamicGreeting}, Michael.</span> Live API systemen en veilige Vercel backend geactiveerd.
            </div>
        </div>
    );
}

function AIWidget({ lang }) {
    const [msg, setMsg] = useState('');
    
    const defaultHist = [{r: 'ai', t: lang==='nl'?'Hallo! Ik ben Gemini. Hoe kan ik je helpen?':'Hello! I am Gemini. How can I help?'}];
    const [hist, setHist] = useState(() => {
        try {
            const saved = S.load('ai_hist', null);
            if (saved && Array.isArray(saved) && saved.length > 0 && saved[0] && typeof saved[0].t === 'string' && saved[0].t.includes('Welkom')) {
                return defaultHist; 
            }
            return saved || defaultHist;
        } catch(e) {
            return defaultHist;
        }
    });
    
    const [showHist, setShowHist] = useState(false);
    const [exp, setExp] = useState(false);
    
    const speak = (txt) => { const u = new SpeechSynthesisUtterance(txt); u.lang = lang==='nl'?'nl-NL':'en-US'; window.speechSynthesis.speak(u); };
    
    const send = async () => {
        if(!msg) return; 
        const input = msg.toLowerCase(); 
        const n = [...hist, {r: 'usr', t: msg}]; 
        setHist(n); S.save('ai_hist', n); setMsg('');
        
        if(input.includes('weer') || input.includes('weather')) { const city = input.split('naar')[1]?.trim() || input.split('to')[1]?.trim() || 'Amsterdam'; emitCmd('SET_CITY', city); setTimeout(() => { const r = [...n, {r: 'ai', t: lang==='nl'?`Weer aangepast naar ${city}.`:`Weather changed to ${city}.`}]; setHist(r); S.save('ai_hist', r); }, 500); return; }
        if(input.includes('agenda') || input.includes('schedule')) { emitCmd('SET_AGENDA', input.split('agenda')[1]?.trim() || input.split('schedule')[1]?.trim()); setTimeout(() => { const r = [...n, {r: 'ai', t: lang==='nl'?`Agenda gefilterd.`:`Schedule filtered.`}]; setHist(r); S.save('ai_hist', r); }, 500); return; }
        
        const apiKeyObj = S.load('api_keys_dyn', []).find(a => a.name.toLowerCase().includes('gemini'));
        const geminiKey = apiKeyObj ? apiKeyObj.val : '';
        
        if (geminiKey) {
            try {
                let contents = [];
                let lastRole = null;
                const recentMsgs = [...hist.slice(-5), {r: 'usr', t: msg}];
                recentMsgs.forEach(m => {
                    let role = m.r === 'usr' ? 'user' : 'model';
                    if (role !== lastRole) {
                        contents.push({ role: role, parts: [{ text: m.t }] });
                        lastRole = role;
                    } else {
                        contents[contents.length-1].parts[0].text += "\n" + m.t;
                    }
                });
                if (contents.length > 0 && contents[0].role === 'model') contents.shift();

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiKey}`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ contents }) 
                });
                const data = await res.json();
                
                if(data.candidates && data.candidates[0].content) { 
                    const reply = data.candidates[0].content.parts[0].text;
                    const r = [...n, {r: 'ai', t: reply}]; 
                    setHist(r); S.save('ai_hist', r); 
                } else if (data.error) {
                    const r = [...n, {r: 'ai', t: `API Error: ${data.error.message}`}]; 
                    setHist(r); S.save('ai_hist', r);
                } else {
                    const r = [...n, {r: 'ai', t: 'Geen geldig antwoord ontvangen.'}]; 
                    setHist(r); S.save('ai_hist', r);
                }
            } catch(e) { 
                const r = [...n, {r: 'ai', t: 'Netwerk of API Error.'}]; 
                setHist(r); S.save('ai_hist', r); 
            }
        } else { 
            setTimeout(() => { 
                const r = [...n, {r: 'ai', t: `Geen API key gevonden. Controleer of je de naam in settings exact op 'Gemini' hebt gezet.`}]; 
                setHist(r); S.save('ai_hist', r); 
            }, 600); 
        }
    };

    return (
        <div className={`widget ai-transition ${exp ? 'h-[450px]' : 'h-[72px]'}`}>
            <div className="p-4 bg-gray-50 border-b flex justify-between items-center cursor-pointer" onClick={()=>setExp(true)}>
                <div className="flex items-center gap-2 text-gray-500"><Ico.Bot/><h3 className="text-[10px] font-black uppercase tracking-widest">AI Assistant</h3></div>
                {exp ? (
                    <div className="flex gap-2 items-center">
                        <span className="bg-blue-100 text-blue-700 px-2 py-1 text-[9px] font-black rounded uppercase shadow-sm">âœ¨ Gemini</span>
                        <button onClick={(e)=>{e.stopPropagation();setShowHist(!showHist)}} className="px-2 py-1 bg-gray-200 hover:bg-gray-300 transition rounded text-[9px] font-bold">Historie</button>
                        <button onClick={(e)=>{e.stopPropagation();setExp(false)}} className="text-gray-400 hover:text-red-500 transition font-bold ml-2 text-lg">&times;</button>
                    </div>
                ) : <div className="text-[10px] font-bold text-gray-400 uppercase">Openen â–¼</div>}
            </div>
            <div className={`flex-1 flex overflow-hidden bg-white ${exp ? 'opacity-100' : 'opacity-0'}`}>
                <div className={`flex-1 p-4 overflow-y-auto space-y-4 ${showHist ? 'hidden md:block' : 'block'}`}>
                    {hist.slice(-10).map((m, i) => (
                        <div key={i} className={`flex flex-col ${m.r==='ai'?'items-start':'items-end'}`}>
                            <div className={`p-3 rounded-lg text-sm max-w-[85%] shadow-sm ${m.r==='ai'?'bg-gray-100 text-gray-800':'bg-[#0073b1] text-white whitespace-pre-wrap'}`}>{m.t}</div>
                            {m.r==='ai' && <button onClick={()=>speak(m.t)} className="mt-1 flex items-center gap-1 text-[9px] text-gray-400 hover:text-blue-600 font-bold uppercase"><Ico.Spk/> {lang==='nl'?'Voorlees':'Speak'}</button>}
                        </div>
                    ))}
                </div>
            </div>
            {exp && <div className="p-3 border-t bg-gray-50 flex gap-2"><button className="px-3 bg-white border rounded text-gray-400 hover:text-blue-600 transition"><Ico.Clip/></button><input value={msg} onChange={e=>setMsg(e.target.value)} onKeyPress={e=>e.key==='Enter'&&send()} placeholder={lang==='nl'?"Commando of vraag...":"Command or question..."} className="flex-1 border p-2.5 rounded text-sm outline-none focus:border-blue-500 shadow-sm" /><button onClick={send} className="bg-[#0073b1] text-white px-5 font-bold rounded text-xs uppercase hover:bg-[#005a8c] transition">Zend</button></div>}
        </div>
    );
}

function CryptoWidget({ lang }) {
    const [valuta, setValuta] = useState('EUR'); 
    const [exRate, setExRate] = useState(1);
    const [portfolio, setPortfolio] = useState([]);
    const [totalEur, setTotalEur] = useState(0);
    const [loading, setLoading] = useState(true);
    const [err, setErr] = useState('');

    useEffect(() => {
        if(valuta === 'USD') {
            fetch('https://open.er-api.com/v6/latest/EUR')
                .then(r=>r.json()).then(d => setExRate(d.rates.USD))
                .catch(() => setExRate(1.08)); 
        } else {
            setExRate(1);
        }
    }, [valuta]);

    useEffect(() => {
        const fetchBitvavo = async () => {
            const bvKeys = S.load('bitvavo_keys', {pub: '', sec: ''});
            if(!bvKeys || !bvKeys.pub || !bvKeys.sec) {
                setErr(lang==='nl'?'Vul je Bitvavo keys in via Instellingen':'Enter Bitvavo keys in Settings');
                setLoading(false); return;
            }
            try {
                const res = await fetch('/api/bitvavo', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key: bvKeys.pub, secret: bvKeys.sec })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error);

                let calcTotal = 0;
                let combined = data.balances.map(b => {
                    const amount = parseFloat(b.available) + parseFloat(b.inOrder);
                    if(b.symbol === 'EUR') { 
                        calcTotal += amount; 
                        return { sym: 'EUR', amount, price: 1, val: amount, tr: {d: 0, w: 0, m: 0, y: 0, sparkline: ''} }; 
                    }
                    const priceObj = data.prices.find(p => p.market === `${b.symbol}-EUR`);
                    const price = priceObj ? parseFloat(priceObj.price) : 0;
                    const val = amount * price;
                    calcTotal += val;
                    return { sym: b.symbol, amount, price, val, tr: {d: 0, w: 0, m: 0, y: 0, sparkline: ''} };
                }).filter(b => b.val > 0).sort((a,b) => b.val - a.val);

                setPortfolio(combined); 
                setTotalEur(calcTotal); 
                setErr('');

                try {
                    const t24Res = await fetch('https://api.bitvavo.com/v2/ticker/24h');
                    const t24Data = await t24Res.json();
                    
                    combined = combined.map(coin => {
                        if(coin.sym === 'EUR') return coin;
                        const t = t24Data.find(x => x.market === `${coin.sym}-EUR`);
                        if(t && parseFloat(t.open) > 0) {
                            coin.tr.d = ((parseFloat(t.last) - parseFloat(t.open)) / parseFloat(t.open)) * 100;
                        }
                        return coin;
                    });
                    setPortfolio([...combined]);

                    combined.forEach(async (coin) => {
                        if(coin.sym === 'EUR') return;
                        try {
                            const cRes = await fetch(`https://api.bitvavo.com/v2/${coin.sym}-EUR/candles?interval=1d&limit=366`);
                            const candles = await cRes.json();
                            
                            const hRes = await fetch(`https://api.bitvavo.com/v2/${coin.sym}-EUR/candles?interval=1h&limit=24`);
                            const hCandles = await hRes.json();

                            setPortfolio(prev => {
                                const nw = [...prev];
                                const matchIdx = nw.findIndex(x => x.sym === coin.sym);
                                if(matchIdx > -1) {
                                    if(Array.isArray(candles) && candles.length > 0) {
                                        const curPrice = parseFloat(candles[0][4]);
                                        const getTr = (d) => candles.length > d ? ((curPrice - parseFloat(candles[d][4])) / parseFloat(candles[d][4])) * 100 : 0;
                                        nw[matchIdx].tr.w = getTr(7);
                                        nw[matchIdx].tr.m = getTr(30);
                                        nw[matchIdx].tr.y = getTr(365);
                                    }
                                    if(Array.isArray(hCandles) && hCandles.length > 0) {
                                        const closes = hCandles.map(c => parseFloat(c[4])).reverse();
                                        const min = Math.min(...closes);
                                        const max = Math.max(...closes);
                                        const range = max - min || 1;
                                        nw[matchIdx].tr.sparkline = closes.map((v, idx) => {
                                            const x = (idx / (closes.length - 1)) * 40;
                                            const y = 20 - (((v - min) / range) * 20);
                                            return `${x},${y}`;
                                        }).join(' ');
                                    }
                                }
                                return nw;
                            });
                        } catch(e) {}
                    });
                } catch (e) { console.error("Trends ophalen mislukt:", e); }

            } catch (error) { setErr(error.message); }
            setLoading(false);
        };
        fetchBitvavo();
    }, [lang]);
    
    const sym = valuta === 'EUR' ? 'â‚¬' : '$';
    const displayTotal = totalEur * exRate;
    const totalTrend = portfolio.reduce((acc, c) => acc + (c.tr.d * (c.val / (totalEur || 1))), 0);
    const totalColor = totalTrend >= 0 ? 'text-green-600' : 'text-red-600';

    return (
        <div className="widget h-[450px] flex flex-col">
            <div className="p-4 bg-gray-50 border-b flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2 text-gray-500"><Ico.Cry/><h3 className="text-[10px] font-black uppercase tracking-widest">Live Bitvavo</h3></div>
                <div className="flex gap-1 bg-gray-200 p-1 rounded">
                    {['EUR', 'USD'].map(v => (
                        <button key={v} onClick={()=>setValuta(v)} className={`px-2 py-0.5 text-[8px] font-bold rounded uppercase ${valuta===v?'bg-white shadow-sm text-blue-700':'text-gray-500'}`}>{v}</button>
                    ))}
                </div>
            </div>
            <div className="p-5 flex-1 flex flex-col bg-white overflow-hidden">
                <div className="mb-4 shrink-0 flex justify-between items-start">
                    <div>
                        <span className="text-[10px] font-bold text-gray-400 block mb-1">WAARDE ({valuta})</span>
                        <div className={`text-3xl font-black tracking-tight ${loading || err ? 'text-gray-900' : totalColor}`}>
                            {loading ? '...' : err ? 'Error' : `${sym} ${displayTotal.toLocaleString('nl-NL', {maximumFractionDigits:0})}`}
                        </div>
                    </div>
                </div>
                
                {loading ? <div className="flex-1 flex justify-center items-center text-xs font-bold text-blue-500 animate-pulse">Syncing met Bitvavo API...</div> : 
                 err ? <div className="flex-1 text-[10px] text-red-500 font-bold p-4 bg-red-50 rounded border border-red-100 flex items-center justify-center text-center">{err}</div> :
                 (
                    <div className="space-y-3 overflow-y-auto flex-1 hide-scroll pr-1 pb-2">
                        {portfolio.map((c, i) => {
                            const isPos = c.tr.d >= 0;
                            const bgClass = isPos ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                            const P = ({v}) => <span className={v>=0?'text-green-600':'text-red-600'}>{v>0?'+':''}{(v || 0).toFixed(2)}%</span>;
                            
                            const displayVal = c.val * exRate;
                            const displayPrice = c.price * exRate;
                            const displayUnits = c.amount > 100 ? c.amount.toLocaleString('nl-NL', {maximumFractionDigits: 2}) : c.amount.toLocaleString('nl-NL', {maximumFractionDigits: 6});
                            
                            const defaultSpark = isPos ? "0,20 8,10 16,15 24,5 32,8 40,0" : "0,0 8,10 16,5 24,15 32,12 40,20";

                            return (
                                <div key={i} className={`relative p-3 border rounded-lg flex flex-col shadow-sm transition overflow-hidden ${bgClass}`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="w-1/3">
                                            <span className="font-black text-lg block text-gray-900 leading-none">{c.sym}</span>
                                            <span className="text-[10px] text-gray-600 font-medium mt-1 block">{displayUnits} units</span>
                                        </div>
                                        <div className="w-1/3 flex flex-col items-center justify-center gap-1">
                                            <svg viewBox="0 0 40 20" className="w-10 h-4 overflow-visible">
                                                <polyline points={c.tr.sparkline || defaultSpark} fill="none" stroke={isPos ? '#16a34a' : '#dc2626'} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
                                            </svg>
                                            <span className={`text-xs font-black ${isPos ? 'text-green-600' : 'text-red-600'}`}>{isPos?'+':''}{(c.tr.d || 0).toFixed(2)}%</span>
                                        </div>
                                        <div className="w-1/3 text-right">
                                            <span className={`font-bold text-lg block leading-none ${isPos ? 'text-green-600' : 'text-red-600'}`}>{sym}{displayPrice.toLocaleString('nl-NL', {maximumFractionDigits: displayPrice < 1 ? 4 : 2})}</span>
                                            <span className="text-[10px] text-gray-500 font-mono mt-1 block">Waarde: {sym}{displayVal.toLocaleString('nl-NL',{maximumFractionDigits:0})}</span>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center pt-2 mt-1 border-t border-black/10 text-[9px] font-black uppercase tracking-tighter">
                                        <div>1W: <P v={c.tr.w}/></div>
                                        <div>1M: <P v={c.tr.m}/></div>
                                        <div>1J: <P v={c.tr.y}/></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>
        </div>
    );
}

function AgendaWidget({ lang }) {
    const rawCals = S.load('icals_dyn', [{name: 'Agenda', val: ''}]);
    const cals = rawCals.map(c=>c.name).filter(Boolean);
    const [view, setView] = useState('dag'); 
    const [d, setD] = useState(new Date().toISOString().split('T')[0]); 
    const [f, setF] = useState(cals);
    const [items, setItems] = useState([]);
    const [loading, setLoading] = useState(true);
    const [groupBy, setGroupBy] = useState('time'); 
    
    useEffect(() => { const h = (e) => { if(e.detail.type === 'SET_AGENDA') { const target = cals.find(c => c.toLowerCase().includes(e.detail.payload?.toLowerCase() || '')); if(target) setF([target]); }}; window.addEventListener('dashCmd', h); return () => window.removeEventListener('dashCmd', h); }, [cals]);

    useEffect(() => { setF(cals); }, [JSON.stringify(cals)]);

    useEffect(() => {
        const fetchCals = async () => {
            setLoading(true);
            let allEvs = [];

            const parseICalDate = (line) => {
                const parts = line.split(':');
                if (parts.length < 2) return null;
                const params = parts[0]; 
                const val = parts[parts.length - 1].trim();
                const isUTC = val.endsWith('Z');
                const m = val.match(/(\d{4})(\d{2})(\d{2})(?:T(\d{2})(\d{2})(\d{2})?Z?)?/);
                if (!m) return null;

                const year = parseInt(m[1]);
                const month = parseInt(m[2]) - 1;
                const day = parseInt(m[3]);
                const hour = m[4] ? parseInt(m[4]) : 0;
                const min = m[5] ? parseInt(m[5]) : 0;
                const sec = m[6] ? parseInt(m[6]) : 0;
                const isAllDay = !m[4];

                let dateObj;
                if (isUTC) {
                    dateObj = new Date(Date.UTC(year, month, day, hour, min, sec));
                } else if (params.includes('TZID=')) {
                    dateObj = new Date(year, month, day, hour, min, sec);
                } else {
                    dateObj = new Date(year, month, day, hour, min, sec);
                }
                
                const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`;
                const timeStr = isAllDay ? 'Hele dag' : dateObj.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });

                return { date: dateStr, time: timeStr, dateObj, isAllDay };
            };

            const expandRRule = (rruleLine, startDateObj, eventData) => {
                const expanded = [];
                const params = {};
                rruleLine.replace('RRULE:', '').split(';').forEach(p => { const [k, v] = p.split('='); params[k] = v; });

                const freq = params.FREQ;
                const count = params.COUNT ? parseInt(params.COUNT) : 200;
                const untilMatch = params.UNTIL ? params.UNTIL.match(/(\d{4})(\d{2})(\d{2})/) : null;
                const until = untilMatch ? new Date(parseInt(untilMatch[1]), parseInt(untilMatch[2])-1, parseInt(untilMatch[3]), 23, 59, 59) : null;
                const interval = params.INTERVAL ? parseInt(params.INTERVAL) : 1;

                const now = new Date();
                const rangeStart = new Date(now); rangeStart.setDate(rangeStart.getDate() - 7); 
                const rangeEnd = new Date(now); rangeEnd.setDate(rangeEnd.getDate() + 60); 

                let current = new Date(startDateObj);
                let generated = 0;

                for (let i = 0; i < 500 && generated < count; i++) {
                    if (until && current > until) break;
                    if (current > rangeEnd) break;

                    if (current >= rangeStart) {
                        const dateStr = `${current.getFullYear()}-${String(current.getMonth()+1).padStart(2,'0')}-${String(current.getDate()).padStart(2,'0')}`;
                        expanded.push({ ...eventData, date: dateStr });
                    }
                    generated++;

                    if (freq === 'DAILY') current.setDate(current.getDate() + interval);
                    else if (freq === 'WEEKLY') current.setDate(current.getDate() + (7 * interval));
                    else if (freq === 'MONTHLY') current.setMonth(current.getMonth() + interval);
                    else if (freq === 'YEARLY') current.setFullYear(current.getFullYear() + interval);
                    else break; 
                }
                return expanded;
            };

            for (let c of rawCals) {
                if (!c.val) continue;

                try {
                    const res = await fetch('/api/ical', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: c.val })
                    });

                    let txt = '';
                    if (res.ok) {
                        if ((res.headers.get('content-type') || '').includes('application/json')) {
                            const errData = await res.json();
                            throw new Error(errData.error || 'Proxy fout');
                        }
                        txt = await res.text();
                    } else {
                        const errData = await res.json().catch(() => ({ error: res.statusText }));
                        throw new Error(errData.error || `HTTP ${res.status}`);
                    }

                    if (!txt || !txt.includes('BEGIN:VCALENDAR')) throw new Error("Geen kalender data");

                    let cur = {};
                    let rrule = null;
                    const lines = txt.split(/\r?\n/);

                    for (let k = 0; k < lines.length; k++) {
                        let l = lines[k];
                        while (k + 1 < lines.length && (lines[k+1].startsWith(' ') || lines[k+1].startsWith('\t'))) { k++; l += lines[k].substring(1); }

                        if (l.startsWith('BEGIN:VEVENT')) { cur = {}; rrule = null; }
                        else if (l.startsWith('SUMMARY')) {
                            const idx = l.indexOf(':');
                            if (idx !== -1) cur.t = l.substring(idx + 1).replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, ' ').replace(/\\/g, '');
                        }
                        else if (l.startsWith('DTSTART')) {
                            const parsed = parseICalDate(l);
                            if (parsed) { cur.date = parsed.date; cur.time = parsed.time; cur.dateObj = parsed.dateObj; }
                        }
                        else if (l.startsWith('DTEND')) {
                            const parsed = parseICalDate(l);
                            if (parsed && !parsed.isAllDay) { cur.endTime = parsed.time; }
                        }
                        else if (l.startsWith('RRULE:')) { rrule = l; }
                        else if (l.startsWith('END:VEVENT') && cur.t && cur.date) {
                            if (rrule && cur.dateObj) {
                                const expanded = expandRRule(rrule, cur.dateObj, { t: cur.t, p: c.name, time: cur.time, endTime: cur.endTime });
                                allEvs.push(...expanded);
                            } else {
                                allEvs.push({ t: cur.t, p: c.name, date: cur.date, time: cur.time, endTime: cur.endTime });
                            }
                        }
                    }
                } catch (e) {
                    console.error("iCal error voor: " + c.name, e);
                    allEvs.push({ t: `âš  ${c.name} fout`, p: c.name, date: d, time: '00:00' });
                }
            }
            if (allEvs.length === 0) allEvs = [{ t: 'Geen afspraken', p: cals[0] || 'Systeem', date: d, time: '00:00' }];
            setItems(allEvs);
            setLoading(false);
        };
        fetchCals();
    }, [JSON.stringify(rawCals)]);

    const colors = ['border-red-500', 'border-blue-500', 'border-green-500', 'border-purple-500', 'border-yellow-500', 'border-pink-500'];
    const getColor = (name) => colors[cals.indexOf(name) % colors.length];

    const tEnd = new Date(d); 
    tEnd.setDate(tEnd.getDate() + 6); 
    const dEnd = tEnd.toISOString().split('T')[0];

    const getWeekNumber = (dateStr) => {
        const date = new Date(dateStr);
        date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay()||7));
        const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
        return Math.ceil(( ( (date - yearStart) / 86400000) + 1)/7);
    };
    
    const filteredItems = items
        .filter(i => f.includes(i.p) && (view === 'dag' ? i.date === d : (i.date >= d && i.date <= dEnd)))
        .sort((a,b) => {
            if(a.date !== b.date) return String(a.date).localeCompare(String(b.date));
            const tA = (a.time === 'Hele dag' || !a.time) ? '00:00' : String(a.time);
            const tB = (b.time === 'Hele dag' || !b.time) ? '00:00' : String(b.time);
            return tA.localeCompare(tB);
        });

    const getSummary = (name) => {
        const evs = filteredItems.filter(e => e.p.toLowerCase().includes(name.toLowerCase()) && e.time !== 'Hele dag');
        if (evs.length === 0) return null;
        const times = [];
        evs.forEach(e => { if(e.time) times.push(e.time); if(e.endTime) times.push(e.endTime); });
        const sorted = times.sort();
        return `${name}: ${sorted[0]} - ${sorted[sorted.length - 1]}`;
    };
    
    const sumRyan = getSummary('Ryan');
    const sumYaron = getSummary('Yaron');

    return (
        <div className="widget h-[450px] flex flex-col">
            <div className="p-4 bg-gray-50 border-b flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2 text-gray-500"><Ico.Cal/><h3 className="text-[10px] font-black uppercase tracking-widest">{T[lang].ag}</h3></div>
                <div className="flex items-center gap-2">
                    <button onClick={()=>setGroupBy(groupBy==='time'?'person':'time')} className="px-2 py-1 bg-white border shadow-sm text-[9px] font-bold rounded uppercase text-gray-600 hover:text-blue-600 transition">
                        {groupBy === 'time' ? 'Groepeer' : 'Sorteer'}
                    </button>
                    <div className="relative flex items-center bg-gray-200 p-1 rounded hover:bg-gray-300 transition cursor-pointer">
                        <span className="px-1.5 text-xs">ðŸ“…</span>
                        <input type="date" value={d} onChange={(e)=>setD(e.target.value)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                    </div>
                    <div className="flex bg-gray-200 p-1 rounded">
                        <button onClick={()=>setView('dag')} className={`px-2 py-1 text-[9px] font-bold rounded ${view==='dag'?'bg-white shadow-sm text-blue-700':''}`}>{T[lang].day}</button>
                        <button onClick={()=>setView('week')} className={`px-2 py-1 text-[9px] font-bold rounded ${view==='week'?'bg-white shadow-sm text-blue-700':''}`}>{T[lang].wk}</button>
                    </div>
                </div>
            </div>
            <div className="flex border-b bg-white overflow-x-auto p-2 gap-2 hide-scroll shrink-0">
                {cals.map(p=><button key={p} onClick={()=>setF(pr=>pr.includes(p)?pr.filter(x=>x!==p):[...pr, p])} className={`px-2 py-1.5 text-[9px] font-bold border rounded uppercase whitespace-nowrap ${f.includes(p)?'bg-[#0073b1] text-white border-[#0073b1]':'text-gray-400 bg-gray-50'}`}>{p}</button>)}
            </div>
            <div className="p-2 flex border-b bg-gray-50 justify-center shrink-0">
                <div className="flex items-center gap-2 bg-white border rounded shadow-sm">
                    <button onClick={()=>{const nd=new Date(d);nd.setDate(nd.getDate()-(view==='week'?7:1));setD(nd.toISOString().split('T')[0])}} className="px-3 py-1.5 hover:bg-gray-100 font-bold text-gray-500">&lt;</button>
                    <span className="text-[10px] font-black text-center uppercase tracking-widest text-gray-600 min-w-[130px]">
                        <span className="text-blue-600">WK {getWeekNumber(d)}</span> <span className="opacity-30">|</span> {view === 'dag' ? fmtDate(d) : `${fmtDate(d).slice(0,5)} - ${fmtDate(dEnd).slice(0,5)}`}
                    </span>
                    <button onClick={()=>{const nd=new Date(d);nd.setDate(nd.getDate()+(view==='week'?7:1));setD(nd.toISOString().split('T')[0])}} className="px-3 py-1.5 hover:bg-gray-100 font-bold text-gray-500">&gt;</button>
                </div>
            </div>
            <div className="flex-1 p-4 bg-white overflow-y-auto content-start">
                {loading ? (
                    <div className="text-center text-xs font-bold text-blue-500 animate-pulse mt-10">Agenda synchroniseren...</div>
                ) : filteredItems.length > 0 ? (
                    groupBy === 'time' ? (
                        <div className="grid grid-cols-2 gap-3">
                            {filteredItems.map((i, idx) => (
                                <div key={idx} className={`p-3 border-l-4 ${getColor(i.p)} bg-gray-50 rounded flex flex-col shadow-sm h-fit`}>
                                    <div className="flex justify-between items-start mb-1">
                                        <span className="text-[9px] font-black text-gray-400 uppercase tracking-widest">
                                            {view==='week' ? `${fmtDate(i.date).slice(0,5)} ` : ''}{i.p}
                                        </span>
                                        <span className="text-blue-600 font-bold font-mono text-[9px] bg-blue-50 px-1.5 py-0.5 rounded leading-tight text-right">
                                            {i.time}{i.endTime ? ` - ${i.endTime}` : ''}
                                        </span>
                                    </div>
                                    <span className="font-bold text-xs leading-tight">{i.t}</span>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {f.map(person => {
                                const personItems = filteredItems.filter(i => i.p === person);
                                if (personItems.length === 0) return null;
                                return (
                                    <div key={person} className="flex flex-col">
                                        <div className={`text-[10px] font-black uppercase text-gray-800 bg-gray-100 border-l-4 ${getColor(person)} px-3 py-1.5 mb-2 w-full`}>
                                            {person}
                                        </div>
                                        <div className="grid grid-cols-2 gap-2">
                                            {personItems.map((i, idx) => (
                                                <div key={idx} className="p-2 border bg-white rounded flex flex-col shadow-sm">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="text-[9px] font-black text-gray-400">
                                                            {view==='week' ? fmtDate(i.date).slice(0,5) : ''}
                                                        </span>
                                                        <span className="text-blue-600 font-bold font-mono text-[9px]">
                                                            {i.time}{i.endTime ? ` - ${i.endTime}` : ''}
                                                        </span>
                                                    </div>
                                                    <span className="font-bold text-[11px] leading-tight">{i.t}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )
                ) : (
                    <div className="col-span-2 text-center text-xs text-gray-400 mt-10">Geen afspraken.</div>
                )}
            </div>
            {(sumRyan || sumYaron) && (
                <div className="bg-gray-100 border-t border-gray-200 p-2 shrink-0 flex justify-center gap-6 text-[9px] font-black uppercase tracking-widest text-gray-600">
                    {sumRyan && <span>ðŸŽ’ {sumRyan}</span>}
                    {sumYaron && <span>ðŸŽ’ {sumYaron}</span>}
                </div>
            )}
        </div>
    );
}

function NewsWidget({ lang }) {
    const [cols, setCols] = useState(S.load('newscats', ['Nieuws', 'Tech', 'Beurs'])); 
    const [manage, setManage] = useState(false);
    const [newsData, setNewsData] = useState({});
    const [search, setSearch] = useState('');
    const [blocked, setBlocked] = useState(S.load('news_blocked', []));
    const [newCol, setNewCol] = useState('');
    const [newBlock, setNewBlock] = useState('');
    const [dragCol, setDragCol] = useState(null);

    useEffect(() => {
        cols.forEach(cat => {
            const isUrl = cat.startsWith('http');
            const rssUrl = isUrl ? cat : `https://news.google.com/rss/search?q=${encodeURIComponent(cat)}&hl=${lang==='nl'?'nl':'en-US'}&gl=${lang==='nl'?'NL':'US'}`;
            fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`)
            .then(r=>r.json()).then(d => { if(d.items) setNewsData(p => ({...p, [cat]: d.items})); })
            .catch(e => console.error(e));
        });
    }, [cols, lang]);

    const addCol = () => { if(newCol && !cols.includes(newCol)) { const n = [...cols, newCol]; setCols(n); S.save('newscats', n); setNewCol(''); } };
    const removeCol = (c) => { const n = cols.filter(x => x !== c); setCols(n); S.save('newscats', n); };
    
    const addBlock = () => { if(newBlock && !blocked.includes(newBlock)) { const n = [...blocked, newBlock]; setBlocked(n); S.save('news_blocked', n); setNewBlock(''); } };
    const removeBlock = (b) => { const n = blocked.filter(x => x !== b); setBlocked(n); S.save('news_blocked', n); };

    const handleDragStart = (e, col) => { setDragCol(col); };
    const handleDrop = (e, col) => {
        if (!dragCol || dragCol === col) return;
        const newCols = [...cols];
        const dragIdx = newCols.indexOf(dragCol);
        const dropIdx = newCols.indexOf(col);
        newCols.splice(dragIdx, 1);
        newCols.splice(dropIdx, 0, dragCol);
        setCols(newCols);
        S.save('newscats', newCols);
        setDragCol(null);
    };

    const formatDate = (pubDate) => {
        if (!pubDate) return '';
        const parts = pubDate.split(' ');
        if(parts.length >= 2 && parts[0].includes('-') && parts[1].includes(':')) {
            const [y,m,d] = parts[0].split('-');
            const [h,min] = parts[1].split(':');
            return `${d}-${m}-${y} | ${h}:${min}`;
        }
        return pubDate;
    };

    return (
        <div className="widget h-[450px]">
            <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                <div className="flex items-center gap-2 text-gray-500">
                    <Ico.Nws/>
                    <h3 className="text-[10px] font-black uppercase tracking-widest">{T[lang].nws}</h3>
                </div>
                <div className="flex gap-2 w-1/2">
                    <input type="text" placeholder={lang==='nl'?"Zoek (bijv. trump, groenland)...":"Search..."} value={search} onChange={e=>setSearch(e.target.value)} className="w-full px-2 py-1 text-[10px] border rounded outline-none focus:border-blue-500 shadow-sm" />
                    <button onClick={()=>setManage(!manage)} className={`px-2 py-1 rounded text-[10px] font-bold ${manage ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}>{manage ? 'Klaar' : 'Beheer'}</button>
                </div>
            </div>
            
            {manage && (
                <div className="p-4 bg-gray-100 border-b flex flex-col gap-3 text-[10px]">
                    <div className="flex gap-2 items-center">
                        <span className="font-bold w-20">Nieuw Topic:</span>
                        <input value={newCol} onChange={e=>setNewCol(e.target.value)} onKeyPress={e=>e.key==='Enter'&&addCol()} className="flex-1 p-1.5 border rounded outline-none" placeholder="Onderwerp, domein of RSS link..." />
                        <button onClick={addCol} className="bg-blue-600 text-white px-3 py-1.5 rounded font-bold hover:bg-blue-700">+</button>
                    </div>
                    <div className="flex gap-2 items-center">
                        <span className="font-bold w-20 text-red-600">Vermijd:</span>
                        <input value={newBlock} onChange={e=>setNewBlock(e.target.value)} onKeyPress={e=>e.key==='Enter'&&addBlock()} className="flex-1 p-1.5 border rounded outline-none" placeholder="Te vermijden bron of woord..." />
                        <button onClick={addBlock} className="bg-red-600 text-white px-3 py-1.5 rounded font-bold hover:bg-red-700">+</button>
                    </div>
                    {blocked.length > 0 && (
                        <div className="flex flex-wrap gap-1 mt-1">
                            {blocked.map(b => <span key={b} className="bg-red-100 text-red-800 px-2 py-1 rounded font-bold flex items-center gap-1">{b} <button onClick={()=>removeBlock(b)} className="text-red-500 hover:text-red-900 ml-1">&times;</button></span>)}
                        </div>
                    )}
                    <span className="text-gray-500 italic mt-1">Slepen (Drag & Drop) is actief voor de kolommen hieronder.</span>
                </div>
            )}

            <div className="flex overflow-x-auto flex-1 bg-white hide-scroll">
                {cols.map(cat => {
                    let items = (newsData[cat] || []).filter(item => {
                        const text = (item.title + " " + (item.source || '') + " " + (item.description || '')).toLowerCase();
                        if (blocked.some(b => text.includes(b.toLowerCase()))) return false;
                        if (search) {
                            const terms = search.toLowerCase().split(',').map(t => t.trim()).filter(Boolean);
                            if (!terms.every(term => text.includes(term))) return false;
                        }
                        return true;
                    });

                    items.sort((a, b) => new Date(b.pubDate.replace(/-/g, '/')) - new Date(a.pubDate.replace(/-/g, '/')));

                    return (
                        <div key={cat} draggable={manage} onDragStart={(e)=>manage && handleDragStart(e, cat)} onDragOver={(e)=>manage && e.preventDefault()} onDrop={(e)=>manage && handleDrop(e, cat)} className={`min-w-[300px] w-[300px] border-r flex flex-col shrink-0 ${manage ? 'cursor-grab active:cursor-grabbing' : ''}`}>
                            <div className="flex justify-between items-center p-3 border-b bg-white sticky top-0">
                                <h4 className="text-[11px] font-black text-blue-600 uppercase truncate pr-2" title={cat}>{cat.startsWith('http') ? 'Custom Feed' : cat}</h4>
                                {manage&&<button onClick={()=>removeCol(cat)} className="text-red-400 font-bold hover:text-red-600 text-lg leading-none">&times;</button>}
                            </div>
                            <div className="space-y-4 p-4 overflow-y-auto flex-1 hide-scroll">
                                {items.slice(0, 15).map((item, i) => {
                                    let cleanDesc = item.description?.replace(/<[^>]+>/g, '').trim() || '';
                                    let sourceName = item.source || '';
                                    let displayTitle = item.title || '';
                                    
                                    const titleParts = displayTitle.split(' - ');
                                    if (titleParts.length > 1) {
                                        const possibleSource = titleParts.pop().trim();
                                        displayTitle = titleParts.join(' - ');
                                        if (!sourceName || sourceName === 'RSS' || sourceName === 'Nieuws') {
                                            sourceName = possibleSource;
                                        }
                                    }
                                    if (!sourceName || sourceName === 'RSS') sourceName = 'Nieuwsbron';

                                    const srcRegex = new RegExp(`[\\-\\|]?\\s*${sourceName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s*$`, 'i');
                                    cleanDesc = cleanDesc.replace(srcRegex, '').trim();

                                    return (
                                    <a href={item.link} target="_blank" key={i} className="block border-b pb-4 hover:bg-gray-50 transition p-1 rounded">
                                        <p className="text-xs font-bold leading-relaxed text-gray-800">{displayTitle}</p>
                                        {cleanDesc && <p className="text-[#1d4ed8] font-bold text-[10px] line-clamp-2 mt-1.5 leading-tight">{cleanDesc}</p>}
                                        <div className="flex justify-between items-center text-[9px] mt-2 uppercase font-black">
                                            <span className="text-[#c586c0]">{sourceName}</span>
                                            <span className="text-gray-400">{formatDate(item.pubDate)}</span>
                                        </div>
                                    </a>
                                )})}
                                {(!newsData[cat]) && <div className="text-xs text-gray-400 text-center mt-10 animate-pulse">Laden...</div>}
                                {(newsData[cat] && items.length === 0) && <div className="text-xs text-gray-400 text-center mt-10">Geen resultaten gevonden.</div>}
                            </div>
                        </div>
                    )
                })}
            </div>
        </div>
    );
}

function RadarWidget({ lang }) {
    const [assets, setAssets] = useState(S.load('inv_assets', ['ASML', 'NVDA', 'MSFT', 'GOOGL', 'AMZN', 'META', 'AAPL', 'NVO']));
    const [manage, setManage] = useState(false);
    const [newAsset, setNewAsset] = useState('');
    const [liveData, setLiveData] = useState({});
    const [loading, setLoading] = useState(true);
    const [tab, setTab] = useState('recs'); 
    const [recs, setRecs] = useState([]);
    const [recsLoading, setRecsLoading] = useState(true);

    useEffect(() => {
        const fetchStockData = async () => {
            try {
                const res = await fetch('/api/stocks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: assets })
                });
                const data = await res.json();
                if (Array.isArray(data)) {
                    const dataMap = {};
                    data.forEach(item => { if (item && item.name) dataMap[item.name] = item; });
                    setLiveData(dataMap);
                }
            } catch (e) { console.error("Beursfout:", e); }
            finally { setLoading(false); }
        };
        fetchStockData();
        const interval = setInterval(fetchStockData, 300000);
        return () => clearInterval(interval);
    }, [assets]);

    useEffect(() => {
        const fetchRecs = async () => {
            setRecsLoading(true);
            try {
                const res = await fetch('/api/stocks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'recommendations' })
                });
                const data = await res.json();
                if (Array.isArray(data)) {
                    setRecs(data);
                }
            } catch (e) { console.error("Aanbevelingen fout:", e); }
            finally { setRecsLoading(false); }
        };
        fetchRecs();
        const interval = setInterval(fetchRecs, 600000);
        return () => clearInterval(interval);
    }, []);

    const addAsset = () => { if(newAsset && !assets.includes(newAsset.toUpperCase().trim())) { const n = [...assets, newAsset.toUpperCase().trim()]; setAssets(n); S.save('inv_assets', n); setNewAsset(''); } };
    const removeAsset = (a) => { const n = assets.filter(x => x !== a); setAssets(n); S.save('inv_assets', n); };

    const P = ({v}) => <span className={v>=0?'text-green-600':'text-red-600'}>{v>0?'+':''}{(v||0).toFixed(2)}%</span>;

    const getScoreColor = (score) => {
        if (score >= 4.3) return 'bg-green-600 text-white';
        if (score >= 3.7) return 'bg-green-500 text-white';
        if (score >= 3.0) return 'bg-yellow-500 text-white';
        if (score >= 2.0) return 'bg-orange-500 text-white';
        return 'bg-red-500 text-white';
    };

    const getConsensusColor = (c) => {
        if (c === 'Strong Buy') return 'text-green-700 bg-green-50 border-green-200';
        if (c === 'Buy') return 'text-green-600 bg-green-50 border-green-100';
        if (c === 'Hold') return 'text-yellow-700 bg-yellow-50 border-yellow-200';
        if (c === 'Sell') return 'text-red-600 bg-red-50 border-red-100';
        return 'text-red-700 bg-red-50 border-red-200';
    };

    const getYahooUrl = (ticker, name) => {
        let t = ticker || name;
        if (t === 'ASML') t = 'ASML.AS';
        if (t === 'NVO') t = 'NOVOB.CO';
        return `https://finance.yahoo.com/quote/${t}`;
    };

    return (
        <div className="widget h-[450px] flex flex-col">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2 text-gray-500"><Ico.Rad/><h3 className="text-[10px] font-black uppercase tracking-widest">Live Beurs</h3></div>
                <div className="flex gap-2 items-center">
                    {tab === 'watch' && (
                        <button onClick={()=>setManage(!manage)} className={`px-2 py-1 rounded text-[10px] font-bold ${manage ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>{manage ? 'Klaar' : 'Beheer'}</button>
                    )}
                </div>
            </div>

            <div className="flex border-b bg-white shrink-0">
                <button onClick={()=>{setTab('recs');setManage(false)}} className={`tab-btn ${tab==='recs'?'active':''}`}>ðŸ“Š TOP PICKS</button>
                <button onClick={()=>setTab('watch')} className={`tab-btn ${tab==='watch'?'active':''}`}>ðŸ‘ WATCHLIST</button>
            </div>

            {manage && tab === 'watch' && (
                <div className="p-3 bg-gray-100 border-b flex gap-2 shrink-0">
                    <input value={newAsset} onChange={e=>setNewAsset(e.target.value)} onKeyPress={e=>e.key==='Enter'&&addAsset()} className="flex-1 p-1.5 border rounded text-[10px]" placeholder="Ticker (bijv. TSLA, AAPL)" />
                    <button onClick={addAsset} className="bg-blue-600 text-white px-3 rounded font-bold">+</button>
                </div>
            )}

            <div className="p-4 space-y-2 overflow-y-auto flex-1 bg-white hide-scroll">
                {tab === 'recs' && (
                    recsLoading ? (
                        <div className="text-center text-xs text-blue-500 animate-pulse mt-10">Analyst aanbevelingen laden...</div>
                    ) : recs.length === 0 ? (
                        <div className="text-center text-[10px] text-gray-400 mt-10">Geen aanbevelingen gevonden.</div>
                    ) : (
                        <>
                            <div className="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-2 text-center">
                                {recs.length} aandelen geanalyseerd Â· gesorteerd op analyst score
                            </div>
                            {recs.map((r, i) => (
                                <div key={r.name} onClick={() => window.open(getYahooUrl(r.ticker, r.name), '_blank')} className={`p-3 border rounded-lg shadow-sm transition cursor-pointer hover:shadow-md ${r.tr.d >= 0 ? 'bg-green-50/50 border-green-100 hover:border-green-300' : 'bg-red-50/50 border-red-100 hover:border-red-300'}`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex items-center gap-2">
                                            <span className={`text-[9px] font-black px-1.5 py-0.5 rounded ${getScoreColor(r.score)}`}>
                                                {r.score.toFixed(1)}
                                            </span>
                                            <span className="font-black text-sm text-gray-900">{r.name}</span>
                                        </div>
                                        <div className="text-right">
                                            <span className="text-[10px] font-mono font-bold block">${r.price.toFixed(2)}</span>
                                            <span className={`text-[9px] font-bold ${r.tr.d >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                {r.tr.d >= 0 ? '+' : ''}{r.tr.d.toFixed(2)}%
                                            </span>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className={`text-[9px] font-black px-2 py-0.5 rounded border ${getConsensusColor(r.consensus)}`}>
                                            {r.consensus}
                                        </span>
                                        <div className="flex items-center gap-1">
                                            <div className="flex h-2.5 w-20 rounded overflow-hidden">
                                                {r.detail.strongBuy > 0 && <div className="bg-green-700" style={{width: `${(r.detail.strongBuy/r.analysts)*100}%`}}></div>}
                                                {r.detail.buy > 0 && <div className="bg-green-400" style={{width: `${(r.detail.buy/r.analysts)*100}%`}}></div>}
                                                {r.detail.hold > 0 && <div className="bg-yellow-400" style={{width: `${(r.detail.hold/r.analysts)*100}%`}}></div>}
                                                {r.detail.sell > 0 && <div className="bg-orange-400" style={{width: `${(r.detail.sell/r.analysts)*100}%`}}></div>}
                                                {r.detail.strongSell > 0 && <div className="bg-red-500" style={{width: `${(r.detail.strongSell/r.analysts)*100}%`}}></div>}
                                            </div>
                                            <span className="text-[8px] font-bold text-gray-400">{r.buyPct}% buy Â· {r.analysts} analysts</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </>
                    )
                )}

                {tab === 'watch' && (
                    loading && Object.keys(liveData).length === 0 ? (
                        <div className="text-center text-xs text-blue-500 animate-pulse mt-10">Koersen laden...</div>
                    ) : assets.map((a) => {
                        const data = liveData[a];
                        if (!data) return (
                            <div key={a} className="p-3 border rounded-lg bg-gray-50 flex justify-between items-center">
                                <span className="font-bold text-sm text-gray-400">{a}</span>
                                {manage ? <button onClick={(e)=>{e.stopPropagation(); removeAsset(a)}} className="text-red-500 font-bold text-lg">&times;</button> : 
                                <span className="text-[9px] text-gray-400">Niet gevonden</span>}
                            </div>
                        );
                        const isPos = data.tr.d >= 0;
                        return (
                            <div key={a} onClick={() => !manage && window.open(getYahooUrl(data.ticker, data.name), '_blank')} className={`p-3 border rounded-lg shadow-sm transition ${!manage ? 'cursor-pointer hover:shadow-md' : ''} ${isPos ? 'bg-green-50 border-green-200 hover:border-green-300' : 'bg-red-50 border-red-200 hover:border-red-300'}`}>
                                <div className="flex justify-between items-start mb-1">
                                    <span className="font-black text-sm text-gray-900">{a}</span>
                                    {manage ? <button onClick={(e)=>{e.stopPropagation(); removeAsset(a)}} className="text-red-500 font-bold text-lg">&times;</button> : 
                                    <span className="text-[10px] font-mono font-bold">{data.currency} {data.price.toFixed(2)}</span>}
                                </div>
                                <div className="flex justify-between items-center text-[9px] font-black uppercase tracking-tighter mt-2 border-t border-black/5 pt-2">
                                    <div>1D: <P v={data.tr.d}/></div>
                                    <div>1W: <P v={data.tr.w}/></div>
                                    <div>1M: <P v={data.tr.m}/></div>
                                    <div>1J: <P v={data.tr.y}/></div>
                                </div>
                            </div>
                        );
                    })
                )}
            </div>
        </div>
    );
}

function PepperWidget({ lang }) {
    const deals = [{ t: 'Sony WH-1000XM5', p: 'â‚¬259', o: 'â‚¬349', d: '25%', h: true }, { t: 'MacBook Air M2', p: 'â‚¬899', o: 'â‚¬1199', d: '25%', h: true }];
    return (
        <div className="widget h-[350px]">
            <div className="p-4 bg-gray-50 border-b flex justify-between items-center"><div className="flex items-center gap-2 text-gray-500"><Ico.Pepper/><h3 className="text-[10px] font-black uppercase tracking-widest italic">Pepper</h3></div></div>
            <div className="p-4 flex gap-4 overflow-x-auto flex-1 items-center bg-white hide-scroll">
                {deals.map((d, i) => (
                    <div key={i} className="min-w-[180px] h-[260px] border rounded p-3 bg-white hover:border-red-400 transition flex flex-col shadow-sm">
                        <div className="h-[80px] w-full bg-gray-100 rounded mb-3 flex items-center justify-center text-[9px] font-bold text-gray-400 border border-dashed">IMG</div>
                        <div className="flex gap-1 mb-2">{d.h && <span className="bg-red-600 text-white text-[9px] font-black px-1.5 py-0.5 rounded">HOT</span>}<span className="bg-green-600 text-white text-[9px] font-black px-1.5 py-0.5 rounded">-{d.d}</span></div>
                        <h4 className="text-[11px] font-bold leading-tight mb-auto">{d.t}</h4>
                        <div className="flex items-baseline gap-2 mt-3"><span className="text-lg font-bold text-blue-600">{d.p}</span><span className="text-[10px] text-gray-400 line-through font-bold">{d.o}</span></div>
                    </div>
                ))}
            </div>
        </div>
    );
}

function RecipeWidget({ lang }) {
    const allRecs = [{ n: "Ribeye Herb Butter", p: 52, k: 650, t: 15, c: "Vlees", ing: "Ribeye\nBoter", stp: "1. Bakken.\n2. Rusten." }, { n: "Kip Teriyaki", p: 48, k: 510, t: 25, c: "Kip", ing: "Kip\nRijst", stp: "1. Koken.\n2. Bakken." }];
    const [f, setF] = useState('All'); const [exp, setExp] = useState(null);
    const filtered = allRecs.filter(r => f === 'All' || r.c === f);
    return (
        <div className="widget h-[350px]">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center"><div className="flex items-center gap-2 text-gray-500"><Ico.Fod/><h3 className="text-[10px] font-black uppercase tracking-widest">{T[lang].rec}</h3></div></div>
            <div className="flex gap-2 p-3 border-b bg-white overflow-x-auto hide-scroll">{['All', 'Vlees', 'Kip', 'Vis'].map(x => <button key={x} onClick={() => {setF(x); setExp(null);}} className={`px-3 py-1 rounded-full text-[9px] font-bold border transition ${f === x ? 'bg-gray-900 text-white border-gray-900' : 'text-gray-500 bg-gray-50 hover:bg-gray-100'}`}>{x.toUpperCase()}</button>)}</div>
            <div className="p-4 space-y-3 flex-1 overflow-y-auto bg-white">
                {filtered.map((r, i) => (
                    <div key={i} onClick={()=>setExp(exp===i?null:i)} className="p-3 border rounded cursor-pointer hover:border-blue-400 transition bg-white shadow-sm flex flex-col"><div className="flex justify-between items-start mb-2"><h4 className="text-xs font-bold text-gray-800">{r.n}</h4><span className="bg-blue-50 text-blue-700 px-2 py-1 rounded text-[9px] font-black">{r.p}g EIWIT</span></div><p className="text-[9px] font-bold text-gray-400 uppercase tracking-widest">{r.t} MIN | {r.k} KCAL</p>{exp === i && <div className="mt-3 pt-3 border-t text-[10px] text-gray-600 whitespace-pre-line leading-relaxed"><span className="font-bold text-gray-900 uppercase">IngrediÃ«nten:</span><br/>{r.ing}<br/><br/><span className="font-bold text-gray-900 uppercase">Bereiding:</span><br/>{r.stp}</div>}</div>
                ))}
            </div>
        </div>
    );
}

function SportsWidget({ lang }) {
    const [tab, setTab] = useState('lst');
    const [search, setSearch] = useState('');
    const [golfTour, setGolfTour] = useState('PGA');

    const [eF1C, setEF1C] = useState(false);
    const [eF1S, setEF1S] = useState(false);
    const [eF1L, setEF1L] = useState(false);
    
    const [eGC, setEGC] = useState(false);
    const [eGS, setEGS] = useState(false);
    const [eGL, setEGL] = useState(false);

    const f1Data = { 
        c: [ { r: "GP Bahrein", d: "02 Mar", t: "16:00" }, { r: "GP Saudi Arabia", d: "09 Mar", t: "18:00" }, { r: "GP Australia", d: "24 Mar", t: "05:00" }, { r: "GP Japan", d: "07 Apr", t: "07:00" }, { r: "GP China", d: "21 Apr", t: "09:00" }, { r: "GP Miami", d: "05 May", t: "22:00" }, { r: "GP Emilia Romagna", d: "19 May", t: "15:00" }, { r: "GP Monaco", d: "26 May", t: "15:00" }, { r: "GP Canada", d: "09 Jun", t: "20:00" }, { r: "GP Spain", d: "23 Jun", t: "15:00" } ], 
        s: [ { p: 1, n: "Verstappen", fl: "ðŸ‡³ðŸ‡±", pt: 25 }, { p: 2, n: "Norris", fl: "ðŸ‡¬ðŸ‡§", pt: 18 }, { p: 3, n: "Leclerc", fl: "ðŸ‡²ðŸ‡¨", pt: 15 }, { p: 4, n: "Sainz", fl: "ðŸ‡ªðŸ‡¸", pt: 12 }, { p: 5, n: "Russell", fl: "ðŸ‡¬ðŸ‡§", pt: 10 }, { p: 6, n: "Hamilton", fl: "ðŸ‡¬ðŸ‡§", pt: 8 }, { p: 7, n: "Piastri", fl: "ðŸ‡¦ðŸ‡º", pt: 6 }, { p: 8, n: "Alonso", fl: "ðŸ‡ªðŸ‡¸", pt: 4 }, { p: 9, n: "Perez", fl: "ðŸ‡²ðŸ‡½", pt: 2 }, { p: 10, n: "Stroll", fl: "ðŸ‡¨ðŸ‡¦", pt: 1 } ], 
        lst: { title: 'GP Abu Dhabi', res: [ { p: 1, n: 'Verstappen', time: '1:27:02' }, { p: 2, n: 'Leclerc', time: '+17.9s' }, { p: 3, n: 'Russell', time: '+20.3s' }, { p: 4, n: 'Norris', time: '+22.7s' }, { p: 5, n: 'Piastri', time: '+31.4s' }, { p: 6, n: 'Sainz', time: '+33.1s' }, { p: 7, n: 'Hamilton', time: '+35.8s' }, { p: 8, n: 'Alonso', time: '+38.5s' }, { p: 9, n: 'Perez', time: '+40.1s' }, { p: 10, n: 'Stroll', time: '+45.0s' } ] } 
    };
    
    const golfPga = { 
        c: [ { r: "The Players", d: "14 Mar", t: "14:00 NL" }, { r: "The Masters", d: "10 Apr", t: "15:00 NL" }, { r: "RBC Heritage", d: "18 Apr", t: "14:00 NL" }, { r: "PGA Champ", d: "16 May", t: "14:00 NL" }, { r: "US Open", d: "13 Jun", t: "15:00 NL" }, { r: "Travelers Champ", d: "20 Jun", t: "14:00 NL" }, { r: "Scottish Open", d: "11 Jul", t: "09:00 NL" }, { r: "The Open", d: "18 Jul", t: "09:00 NL" }, { r: "FedEx St. Jude", d: "15 Aug", t: "14:00 NL" }, { r: "BMW Champ", d: "22 Aug", t: "14:00 NL" } ], 
        s: [ { p: 1, n: "Scheffler", fl: "ðŸ‡ºðŸ‡¸", pt: "3200" }, { p: 2, n: "Kim", fl: "ðŸ‡°ðŸ‡·", pt: "2100" }, { p: 3, n: "McIlroy", fl: "ðŸ‡¬ðŸ‡§", pt: "1950" }, { p: 4, n: "Schauffele", fl: "ðŸ‡ºðŸ‡¸", pt: "1800" }, { p: 5, n: "Rahm", fl: "ðŸ‡ºðŸ‡¸", pt: "1700" }, { p: 6, n: "Clark", fl: "ðŸ‡ºðŸ‡¸", pt: "1500" }, { p: 7, n: "Hovland", fl: "ðŸ‡³ðŸ‡´", pt: "1400" }, { p: 8, n: "Cantlay", fl: "ðŸ‡ºðŸ‡¸", pt: "1350" }, { p: 9, n: "Aberg", fl: "ðŸ‡³ðŸ‡´", pt: "1300" }, { p: 10, n: "Harman", fl: "ðŸ‡ºðŸ‡¸", pt: "1200" } ], 
        lst: { title: 'Arnold Palmer Inv.', res: [ { p: 1, n: 'Scheffler', time: '-15' }, { p: 2, n: 'Clark', time: '-14' }, { p: 3, n: 'Lowry', time: '-13' }, { p: 4, n: 'Zalatoris', time: '-12' }, { p: 5, n: 'Theegala', time: '-11' }, { p: 6, n: 'Burns', time: '-10' }, { p: 7, n: 'McIlroy', time: '-9' }, { p: 8, n: 'Kim', time: '-8' }, { p: 9, n: 'Schauffele', time: '-7' }, { p: 10, n: 'Hovland', time: '-6' } ] } 
    };
    
    const golfDp = { 
        c: [ { r: "Singapore Open", d: "21 Mar", t: "08:00 NL" }, { r: "Indian Open", d: "28 Mar", t: "09:00 NL" }, { r: "Korea Champ", d: "18 Apr", t: "08:00 NL" }, { r: "ISPS Handa", d: "25 Apr", t: "07:00 NL" }, { r: "China Open", d: "02 May", t: "06:00 NL" }, { r: "Soudal Open", d: "23 May", t: "10:00 NL" }, { r: "European Open", d: "30 May", t: "09:00 NL" }, { r: "KLM Open", d: "06 Jun", t: "09:00 NL" }, { r: "BMW Int", d: "20 Jun", t: "10:00 NL" }, { r: "Italian Open", d: "04 Jul", t: "09:00 NL" } ], 
        s: [ { p: 1, n: "McIlroy", fl: "ðŸ‡¬ðŸ‡§", pt: "2500" }, { p: 2, n: "Kim", fl: "ðŸ‡°ðŸ‡·", pt: "2100" }, { p: 3, n: "Fleetwood", fl: "ðŸ‡¬ðŸ‡§", pt: "1950" }, { p: 4, n: "Fox", fl: "ðŸ‡¬ðŸ‡§", pt: "1800" }, { p: 5, n: "Meronk", fl: "ðŸ‡µðŸ‡±", pt: "1600" }, { p: 6, n: "MacIntyre", fl: "ðŸ‡¬ðŸ‡§", pt: "1500" }, { p: 7, n: "Olesen", fl: "ðŸ‡¬ðŸ‡§", pt: "1400" }, { p: 8, n: "Hojgaard", fl: "ðŸ‡©ðŸ‡°", pt: "1350" }, { p: 9, n: "Campillo", fl: "ðŸ‡ªðŸ‡¸", pt: "1300" }, { p: 10, n: "Perez", fl: "ðŸ‡«ðŸ‡·", pt: "1200" } ], 
        lst: { title: 'Dubai Desert Classic', res: [ { p: 1, n: 'McIlroy', time: '-14' }, { p: 2, n: 'Meronk', time: '-13' }, { p: 3, n: 'Kim', time: '-12' }, { p: 4, n: 'Scott', time: '-11' }, { p: 5, n: 'Fox', time: '-10' }, { p: 6, n: 'Fleetwood', time: '-9' }, { p: 7, n: 'MacIntyre', time: '-8' }, { p: 8, n: 'Olesen', time: '-7' }, { p: 9, n: 'Hojgaard', time: '-6' }, { p: 10, n: 'Perez', time: '-5' } ] } 
    };

    const gData = golfTour === 'PGA' ? golfPga : golfDp;
    const match = (s) => s.toLowerCase().includes(search.toLowerCase());

    const fF1c = f1Data.c.filter(x => !search || match(x.r));
    const fF1s = f1Data.s.filter(x => !search || match(x.n));
    const fF1lstRes = f1Data.lst.res.filter(x => !search || match(x.n));
    const f1LstMatch = fF1lstRes.length > 0 || match(f1Data.lst.title); 

    const fGc = gData.c.filter(x => !search || match(x.r));
    const fGs = gData.s.filter(x => !search || match(x.n));
    const fGlstRes = gData.lst.res.filter(x => !search || match(x.n));
    const gLstMatch = fGlstRes.length > 0 || match(gData.lst.title);

    const MoreBtn = ({ e, setE, t1, e1 }) => (
        <button onClick={() => setE(!e)} className="w-full mt-2 bg-gray-50 hover:bg-gray-100 border text-gray-500 text-[9px] font-bold py-1.5 rounded uppercase transition shadow-sm">
            {e ? (lang==='nl'?'Minder tonen':'Show less') : (lang==='nl'?t1:e1)}
        </button>
    );

    return (
        <div className="widget h-[450px]">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2 text-gray-500">
                    <Ico.Trp/><h3 className="text-[10px] font-black uppercase tracking-widest">Sport</h3>
                </div>
                <input type="text" placeholder={lang==='nl'?"Zoek (bijv. Verstappen)":"Search..."} value={search} onChange={e=>setSearch(e.target.value)} className="w-1/2 px-2 py-1 text-[10px] border rounded outline-none focus:border-blue-500 shadow-sm" />
            </div>
            <div className="flex border-b bg-white shrink-0">
                {[ {id:'cal', l:T[lang].cal}, {id:'lst', l:T[lang].lst}, {id:'std', l:T[lang].std} ].map(t => <button key={t.id} onClick={() => setTab(t.id)} className={`tab-btn ${tab === t.id ? 'active' : ''}`}>{t.l}</button>)}
            </div>
            <div className="p-4 flex-1 overflow-y-auto space-y-6 bg-white hide-scroll">
                
                {((tab === 'cal' && fF1c.length>0) || (tab === 'std' && fF1s.length>0) || (tab === 'lst' && f1LstMatch)) && (
                <div>
                    <div className="flex items-center gap-2 mb-2 border-b border-gray-100 pb-1"><Ico.F1/><span className="text-[10px] font-black uppercase text-[#0073b1]">F1</span></div>
                    <div className="space-y-1">
                        {tab === 'cal' && fF1c.slice(0, eF1C ? 10 : 3).map(r => <div key={r.r} className="flex justify-between items-center text-xs p-2 bg-gray-50 rounded border"><div className="flex flex-col"><span className="font-bold">{r.r}</span><span className="text-[9px] font-black text-gray-400 mt-0.5">{r.d}</span></div><span className="font-mono text-blue-600 font-bold">{r.t}</span></div>)}
                        {tab === 'cal' && fF1c.length > 3 && <MoreBtn e={eF1C} setE={setEF1C} t1="Toon 10 events" e1="Show 10 events" />}
                        
                        {tab === 'std' && fF1s.slice(0, eF1S ? 10 : 3).map((s,i) => <div key={s.n} className="flex justify-between items-center text-xs p-2 border-b"><div className="flex gap-3 items-center"><span className="font-black w-4">{s.p===1?'ðŸ¥‡':s.p===2?'ðŸ¥ˆ':s.p===3?'ðŸ¥‰':s.p}</span><span className="text-base">{s.fl}</span><span className="font-bold">{s.n.toUpperCase()}</span></div><span className="bg-gray-800 text-white px-2 py-0.5 rounded font-mono font-bold text-[9px]">{s.pt}</span></div>)}
                        {tab === 'std' && fF1s.length > 3 && <MoreBtn e={eF1S} setE={setEF1S} t1="Volledige stand" e1="Full standings" />}

                        {tab === 'lst' && f1LstMatch && (
                            <div className="flex flex-col gap-1">
                                <div className="bg-blue-50 text-blue-800 font-bold text-center py-1.5 rounded uppercase text-[9px] mb-1">{f1Data.lst.title}</div>
                                {fF1lstRes.slice(0, eF1L ? 10 : 3).map((r, i) => (
                                    <div key={r.n} className={`flex justify-between items-center text-xs p-2 border-b ${r.p===1?'bg-yellow-50 border-yellow-300 rounded':''}`}>
                                        <div className="flex gap-3 items-center">
                                            <span className="font-black w-4">{r.p===1?'ðŸ¥‡':r.p===2?'ðŸ¥ˆ':r.p===3?'ðŸ¥‰':r.p}</span>
                                            <span className="font-bold">{r.n.toUpperCase()}</span>
                                        </div>
                                        <span className="text-gray-500 font-mono text-[9px]">{r.time}</span>
                                    </div>
                                ))}
                                {fF1lstRes.length > 3 && <MoreBtn e={eF1L} setE={setEF1L} t1="Volledige uitslag" e1="Full results" />}
                            </div>
                        )}
                    </div>
                </div>
                )}

                {((tab === 'cal' && fGc.length>0) || (tab === 'std' && fGs.length>0) || (tab === 'lst' && gLstMatch)) && (
                <div>
                    <div className="flex items-center justify-between mb-2 border-b border-gray-100 pb-1">
                        <div className="flex items-center gap-2"><Ico.Glf/><span className="text-[10px] font-black uppercase text-[#0073b1]">GOLF</span></div>
                        <div className="flex gap-1 bg-gray-100 p-0.5 rounded">
                            <button onClick={()=>setGolfTour('PGA')} className={`px-2 py-0.5 text-[8px] font-bold rounded uppercase ${golfTour==='PGA'?'bg-white shadow-sm text-blue-700':'text-gray-500'}`}>PGA</button>
                            <button onClick={()=>setGolfTour('DP')} className={`px-2 py-0.5 text-[8px] font-bold rounded uppercase ${golfTour==='DP'?'bg-white shadow-sm text-blue-700':'text-gray-500'}`}>DP</button>
                        </div>
                    </div>
                    <div className="space-y-1">
                        {tab === 'cal' && fGc.slice(0, eGC ? 10 : 3).map(r => <div key={r.r} className="flex justify-between items-center text-xs p-2 bg-gray-50 rounded border"><div className="flex flex-col"><span className="font-bold">{r.r}</span><span className="text-[9px] font-black text-gray-400 mt-0.5">{r.d}</span></div><span className="font-mono text-blue-600 font-bold">{r.t}</span></div>)}
                        {tab === 'cal' && fGc.length > 3 && <MoreBtn e={eGC} setE={setEGC} t1="Toon 10 events" e1="Show 10 events" />}
                        
                        {tab === 'std' && fGs.slice(0, eGS ? 10 : 3).map((s,i) => <div key={s.n} className="flex justify-between items-center text-xs p-2 border-b"><div className="flex gap-3 items-center"><span className="font-black w-4">{s.p===1?'ðŸ¥‡':s.p===2?'ðŸ¥ˆ':s.p===3?'ðŸ¥‰':s.p}</span><span className="text-base">{s.fl}</span><span className="font-bold">{s.n.toUpperCase()}</span></div><span className="bg-gray-800 text-white px-2 py-0.5 rounded font-mono font-bold text-[9px]">{s.pt}</span></div>)}
                        {tab === 'std' && fGs.length > 3 && <MoreBtn e={eGS} setE={setEGS} t1="Volledige stand" e1="Full standings" />}

                        {tab === 'lst' && gLstMatch && (
                            <div className="flex flex-col gap-1">
                                <div className="bg-green-50 text-green-800 font-bold text-center py-1.5 rounded uppercase text-[9px] mb-1">{gData.lst.title}</div>
                                {fGlstRes.slice(0, eGL ? 10 : 3).map((r, i) => (
                                    <div key={r.n} className={`flex justify-between items-center text-xs p-2 border-b ${r.p===1?'bg-green-100 border-green-300 rounded':''}`}>
                                        <div className="flex gap-3 items-center">
                                            <span className="font-black w-4">{r.p===1?'ðŸ¥‡':r.p===2?'ðŸ¥ˆ':r.p===3?'ðŸ¥‰':r.p}</span>
                                            <span className="font-bold">{r.n.toUpperCase()}</span>
                                        </div>
                                        <span className="text-gray-500 font-mono text-[9px]">{r.time}</span>
                                    </div>
                                ))}
                                {fGlstRes.length > 3 && <MoreBtn e={eGL} setE={setEGL} t1="Volledige uitslag" e1="Full results" />}
                            </div>
                        )}
                    </div>
                </div>
                )}
                
                {search && fF1c.length===0 && fF1s.length===0 && !f1LstMatch && fGc.length===0 && fGs.length===0 && !gLstMatch && (
                    <div className="text-center text-gray-400 text-[10px] font-bold py-10 uppercase">Geen resultaten voor '{search}'</div>
                )}
            </div>
        </div>
    );
}

function SudokuWidget({ lang }) {
    const [diff, setDiff] = useState('Medium'); const [mode, setMode] = useState('normal'); 
    const [grid, setGrid] = useState(Array(81).fill(null)); const [fixed, setFixed] = useState(Array(81).fill(false)); const [notes, setNotes] = useState(Array(81).fill([]));
    const [history, setHistory] = useState([]); const [sel, setSel] = useState(null);

    const generate = (d) => { const n=Array(81).fill(null); const f=Array(81).fill(false); const c=d==='Medium'?32:24; for(let i=0;i<c;i++){ let idx=Math.floor(Math.random()*81); n[idx]=Math.floor(Math.random()*9)+1; f[idx]=true; } setGrid(n); setFixed(f); setNotes(Array(81).fill([])); setHistory([]); setSel(null); };
    useEffect(() => generate(diff), [diff]);

    const push = () => setHistory(p => [...p, {grid: [...grid], notes: [...notes]}]);
    const undo = () => { if(history.length === 0) return; const last = history[history.length - 1]; setGrid(last.grid); setNotes(last.notes); setHistory(history.slice(0, -1)); };
    const num = (n) => { if(sel === null || fixed[sel]) return; push(); if(mode === 'normal') { const g = [...grid]; g[sel] = n; setGrid(g); } else { const nt = [...notes]; if(nt[sel].includes(n)) nt[sel] = nt[sel].filter(x => x !== n); else nt[sel] = [...nt[sel], n].sort(); setNotes(nt); } };

    return (
        <div className="widget p-6 h-[500px] bg-gray-50">
            <div className="flex justify-between items-center mb-4"><div className="flex items-center gap-2 text-gray-500"><Ico.Sud/><h3 className="text-[10px] font-black uppercase tracking-widest">SUDOKU</h3></div><select value={diff} onChange={e=>{setDiff(e.target.value); generate(e.target.value)}} className="text-[10px] font-bold border rounded px-2 py-1 outline-none text-blue-700 bg-white"><option>Medium</option><option>Hard</option></select></div>
            <div className="flex-1 flex flex-col justify-center items-center w-full">
                <div className="sudoku-container bg-white shadow-md">
                    {grid.map((c, i) => <div key={i} onClick={()=>setSel(i)} className={`sudoku-cell ${Math.floor(i/9)%3===2 && Math.floor(i/9)!==8 ? 'border-b-thick' : ''} ${i%3===2 && i%9!==8 ? 'border-r-thick' : ''} ${fixed[i] ? 'fixed' : c ? 'input' : ''} ${sel === i ? 'selected' : ''}`}>{c ? c : (notes[i].length > 0 && <div className="sudoku-candidates">{[1,2,3,4,5,6,7,8,9].map(n => <span key={n}>{notes[i].includes(n) ? n : ''}</span>)}</div>)}</div>)}
                </div>
            </div>
            <div className="mt-4 flex flex-col gap-2">
                <div className="flex justify-between gap-1">{[1,2,3,4,5,6,7,8,9].map(n => <button key={n} onClick={()=>num(n)} className="flex-1 bg-white border py-2 rounded font-black shadow-sm">{n}</button>)}</div>
                <div className="flex gap-2 h-10"><button onClick={()=>setMode('normal')} className={`flex-1 rounded font-bold text-[10px] uppercase border ${mode==='normal'?'bg-blue-600 text-white':'bg-white text-gray-600'}`}>Normaal</button><button onClick={()=>setMode('note')} className={`flex-1 rounded font-bold text-[10px] uppercase border ${mode==='note'?'bg-blue-600 text-white':'bg-white text-gray-600'}`}>Notitie</button><button onClick={undo} disabled={history.length===0} className="w-14 bg-white border rounded text-gray-500 disabled:opacity-30">Undo</button><button onClick={()=>generate(diff)} className="px-4 bg-gray-800 text-white rounded text-[10px] font-black uppercase">{T[lang].new}</button></div>
            </div>
        </div>
    );
}

function LanguageWidget({ lang }) {
    const [l, setL] = useState('Spaans'); const [t, setT] = useState('w');
    const [h, setH] = useState(S.load('lang_hist', []));
    const finish = () => { const dt = fmtDate(new Date().toISOString().split('T')[0]); const nh = [{d: dt, l, a: t==='w'?'Woord':t==='v'?'Werkwoord':'Gesprek'}, ...h]; setH(nh); S.save('lang_hist', nh); alert('Opgeslagen in Historie!'); };

    return (
        <div className="widget h-[400px]">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                <div className="flex items-center gap-2 text-gray-500"><Ico.Lng /><h3 className="text-[10px] font-black uppercase tracking-widest">{T[lang].lang}</h3></div>
                <select value={l} onChange={e=>setL(e.target.value)} className="bg-white border rounded text-[10px] font-bold px-2 py-1 outline-none text-blue-700">
                    <option>Italiaans</option>
                    <option>Spaans</option>
                    <option>Engels</option>
                    <option>Frans</option>
                    <option>Duits</option>
                    <option>Nederlands</option>
                </select>
            </div>
            <div className="flex border-b bg-white">{[ {id:'w', l:'Woord'}, {id:'v', l:'Werkwoord'}, {id:'c', l:'Gesprek'}, {id:'h', l:'Historie'} ].map(x => <button key={x.id} onClick={()=>setT(x.id)} className={`tab-btn ${t === x.id ? 'active' : ''}`}>{x.l}</button>)}</div>
            <div className="flex-1 p-6 flex flex-col items-center justify-center bg-white overflow-y-auto">
                {t === 'w' && <div className="text-center"><span className="bg-blue-50 text-blue-700 px-2 py-1 text-[9px] font-bold uppercase rounded">A2 Niveau</span><h4 className="text-3xl font-black my-4">{l === 'Italiaans' ? 'Sviluppare' : 'Desarrollar'}</h4><p className="text-sm text-gray-500 italic mb-6">"Ontwikkelen"</p><button onClick={finish} className="bg-[#0073b1] text-white px-6 py-2 rounded text-[10px] font-black uppercase">Geleerd</button></div>}
                {t === 'v' && <div className="w-full max-w-sm"><p className="text-[10px] font-black text-gray-400 mb-3 uppercase">{l === 'Italiaans' ? 'Parlare' : 'Hablar'} (Presente)</p><div className="grid grid-cols-2 gap-3 mb-6">{['Yo/Io', 'TÃº/Tu', 'Ã‰l/Lui', 'Nosotros/Noi'].map(v => <input key={v} placeholder={v} className="p-3 border rounded text-xs outline-none focus:border-blue-500 bg-gray-50"/>)}</div><button onClick={finish} className="w-full bg-[#0073b1] text-white py-3 rounded text-[10px] font-black uppercase">Voltooi Sessie</button></div>}
                {t === 'c' && <div className="w-full max-w-sm"><div className="bg-blue-50 p-5 rounded-lg text-sm italic border border-blue-100 text-gray-800 mb-6">{l === 'Italiaans' ? '"Lo sviluppo Ã¨ fondamentale."' : '"El desarrollo es fundamental."'}</div><button onClick={finish} className="w-full bg-[#0073b1] text-white py-3 rounded text-[10px] font-black uppercase">Gesprek Klaar</button></div>}
                {t === 'h' && <div className="w-full space-y-2">{h.length===0?<p className="text-center text-xs text-gray-400">Geen historie nog.</p>:h.map((x,i)=><div key={i} className="flex justify-between border-b p-2 text-xs"><span className="font-bold text-gray-800">{x.l} - {x.a}</span><span className="text-[10px] text-gray-500">{x.d}</span></div>)}</div>}
            </div>
        </div>
    );
}

function Settings({ isOpen, onClose, layout, setLayout }) {
    const [bvKeys, setBvKeys] = useState(S.load('bitvavo_keys', {pub: '', sec: ''}));
    const [apis, setApis] = useState(S.load('api_keys_dyn', [{name: 'Gemini', val: ''}]));
    const [icals, setIcals] = useState(S.load('icals_dyn', [{name: 'Ryan', val: ''}, {name: 'Yaron', val: ''}, {name: 'Michael', val: ''}, {name: 'Fam-Sch', val: ''}]));
    const [aiUrl, setAiUrl] = useState(S.load('ai_chat_url', ''));
    const [dragIdx, setDragIdx] = useState(null);
    const [isSaving, setIsSaving] = useState(false);

    const handleDragStart = (e, idx) => { setDragIdx(idx); e.dataTransfer.effectAllowed = "move"; };
    const handleDrop = (e, idx) => { e.preventDefault(); if (dragIdx === null || dragIdx === idx) return; const n = [...layout]; const item = n.splice(dragIdx, 1)[0]; n.splice(idx, 0, item); setLayout(n); S.save('layout_v7', n); setDragIdx(null); };
    const move = (idx, dir) => { if((dir===-1 && idx===0) || (dir===1 && idx===layout.length-1)) return; const n = [...layout]; const temp = n[idx]; n[idx] = n[idx+dir]; n[idx+dir] = temp; setLayout(n); S.save('layout_v7', n); };

    const saveAll = async () => { 
        setIsSaving(true);
        S.save('bitvavo_keys', bvKeys); 
        S.save('api_keys_dyn', apis); 
        S.save('icals_dyn', icals); 
        S.save('ai_chat_url', aiUrl); 
        S.save('layout_v7', layout);
        
        const cloudSettings = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('d_')) {
                cloudSettings[key.substring(2)] = JSON.parse(localStorage.getItem(key));
            }
        }

        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: ALLOWED_EMAIL, settings: cloudSettings })
            });
            const dbData = await res.json();
            
            if (!res.ok || dbData.error) {
                alert("FOUT BIJ OPSLAAN: " + (dbData.error || res.statusText));
                setIsSaving(false);
                return; 
            }
        } catch(e) { 
            alert("NETWERK FOUT BIJ OPSLAAN: " + e.message); 
            setIsSaving(false);
            return; 
        }

        setIsSaving(false);
        onClose(); 
        window.location.reload(); 
    };

    return (
        <div className={`settings-panel p-6 md:p-8 ${isOpen ? 'open' : ''}`}>
            <div className="flex justify-between items-center mb-8 border-b pb-4"><h2 className="text-2xl font-black uppercase">Configuratie</h2><button onClick={onClose} className="text-3xl text-gray-400 hover:text-gray-800 transition">&times;</button></div>
            <div className="space-y-8">
                
                <section>
                    <h3 className="text-[10px] font-black text-blue-600 uppercase mb-4">Dashboard Indeling (Drag & Drop)</h3>
                    <div className="space-y-1">
                        {layout.map((w, i) => (
                            <div key={w} draggable onDragStart={(e)=>handleDragStart(e, i)} onDragOver={(e)=>e.preventDefault()} onDrop={(e)=>handleDrop(e, i)} className="flex justify-between items-center bg-white p-3 border rounded shadow-sm cursor-move hover:border-blue-400 transition">
                                <div className="flex items-center gap-3"><Ico.Drag /><span className="text-xs font-bold uppercase">{w}</span></div>
                                <div className="flex gap-2"><button onClick={()=>move(i, -1)} className="text-gray-400 hover:text-blue-600"><Ico.Up/></button><button onClick={()=>move(i, 1)} className="text-gray-400 hover:text-blue-600"><Ico.Dn/></button></div>
                            </div>
                        ))}
                    </div>
                </section>

                <section>
                    <h3 className="text-[10px] font-black text-blue-600 uppercase mb-4">Bitvavo Koppeling (Live)</h3>
                    <div className="space-y-2">
                        <input type="text" placeholder="Bitvavo API Key" value={bvKeys.pub} onChange={e=>setBvKeys({...bvKeys, pub: e.target.value})} className="w-full p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                        <input type="password" placeholder="Bitvavo API Secret" value={bvKeys.sec} onChange={e=>setBvKeys({...bvKeys, sec: e.target.value})} className="w-full p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                    </div>
                </section>

                <section>
                    <div className="flex justify-between items-center mb-4"><h3 className="text-[10px] font-black text-blue-600 uppercase">Overige API Keys</h3><button onClick={()=>setApis([...apis, {name:'', val:''}])} className="bg-blue-100 text-blue-700 px-2 rounded font-bold">+</button></div>
                    {apis.map((a, i) => (
                        <div key={i} className="flex gap-2 mb-2">
                            <input placeholder="Naam (bijv. Gemini)" value={a.name} onChange={e=>{const n=[...apis]; n[i].name=e.target.value; setApis(n);}} className="w-1/3 p-2.5 border rounded text-xs font-bold bg-gray-50 outline-none focus:border-blue-500" />
                            <input type="password" placeholder="API Key..." value={a.val} onChange={e=>{const n=[...apis]; n[i].val=e.target.value; setApis(n);}} className="flex-1 p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                            <button onClick={()=>{const n=apis.filter((_,idx)=>idx!==i); setApis(n);}} className="text-red-400 hover:text-red-600 font-bold px-1">&times;</button>
                        </div>
                    ))}
                </section>

                <section>
                    <div className="flex justify-between items-center mb-4"><h3 className="text-[10px] font-black text-blue-600 uppercase">Live iCal Links (.ics)</h3><button onClick={()=>setIcals([...icals, {name:'', val:''}])} className="bg-blue-100 text-blue-700 px-2 rounded font-bold">+</button></div>
                    {icals.map((c, i) => (
                        <div key={i} className="flex gap-2 mb-2">
                            <input placeholder="Naam (bijv. Werk)" value={c.name} onChange={e=>{const n=[...icals]; n[i].name=e.target.value; setIcals(n);}} className="w-1/3 p-2.5 border rounded text-xs font-bold bg-gray-50 outline-none focus:border-blue-500" />
                            <input type="text" placeholder="https://..." value={c.val} onChange={e=>{const n=[...icals]; n[i].val=e.target.value; setIcals(n);}} className="flex-1 p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                            <button onClick={()=>{const n=icals.filter((_,idx)=>idx!==i); setIcals(n);}} className="text-red-400 hover:text-red-600 font-bold px-1">&times;</button>
                        </div>
                    ))}
                </section>

                <section className="bg-gray-50 p-4 rounded border border-gray-200">
                    <h3 className="text-[10px] font-black text-gray-800 uppercase mb-3">Systeem & AI Beheer</h3>
                    <label className="text-[9px] font-bold text-gray-500 uppercase block mb-1">AI Chat URL (Voor updates)</label>
                    <div className="flex gap-2">
                        <input type="text" placeholder="Link van AI chat..." value={aiUrl} onChange={e=>setAiUrl(e.target.value)} className="flex-1 p-3 border rounded text-xs font-mono bg-white shadow-sm outline-none focus:border-blue-500" />
                        <a href={aiUrl || '#'} target="_blank" className="bg-blue-600 text-white px-4 rounded flex items-center justify-center font-bold text-xs hover:bg-blue-700 transition">Open</a>
                    </div>
                </section>
            </div>
            <button onClick={saveAll} disabled={isSaving} className="mt-10 w-full bg-[#1a1a1a] text-white py-4 text-[10px] font-black uppercase rounded shadow-lg hover:bg-black transition disabled:opacity-50">
                {isSaving ? 'BEZIG MET CLOUD SYNC...' : 'OPSLAAN & HERLADEN (CLOUD SYNC)'}
            </button>
        </div>
    );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
