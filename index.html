<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Dashboard - Michael</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/NLqKzZ4C/nieuw-schaap-logo1.png">

    <script src="https://accounts.google.com/gsi/client" async defer></script>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js" defer></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --p-blue: #0073b1; --bg: linear-gradient(135deg, #001a33 0%, #000a14 100%); }
        body { background: var(--bg); min-height: 100vh; font-family: 'Inter', sans-serif; margin: 0; color: #1a1a1a; }
        .widget { background: rgba(255,255,255,0.98); border-radius: 6px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .tab-btn { font-size: 0.65rem; font-weight: 800; padding: 10px; color: #666; border-bottom: 2px solid transparent; text-transform: uppercase; flex: 1; transition: 0.2s; text-align: center; cursor: pointer; }
        .tab-btn.active { color: var(--p-blue); border-bottom-color: var(--p-blue); background: rgba(0,115,177,0.05); }
        .border-r-thick { border-right: 2px solid #1a1a1a !important; }
        .border-b-thick { border-bottom: 2px solid #1a1a1a !important; }
        .settings-panel { position: fixed; right: 0; top: 0; height: 100vh; width: 100%; max-width: 480px; background: white; z-index: 100; box-shadow: -10px 0 30px rgba(0,0,0,0.5); transform: translateX(100%); transition: 0.3s ease; overflow-y: auto; }
        .settings-panel.open { transform: translateX(0); }
        .sparkline-bg { position: absolute; bottom: 0; left: 0; right: 0; height: 40px; opacity: 0.08; background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 30" xmlns="http://www.w3.org/2000/svg"><path d="M0 30 L10 20 L20 25 L30 15 L40 18 L50 5 L60 10 L70 2 L80 12 L90 5 L100 0 L100 30 Z" fill="%230073b1"/></svg>'); background-size: cover; background-position: bottom; pointer-events: none; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--p-blue); border-radius: 4px; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .ai-transition { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useMemo } = React;

const GOOGLE_CLIENT_ID = "196901777247-3ak09abjpa3dm5908a5f8m08d4o7gqj8.apps.googleusercontent.com";
const ALLOWED_EMAIL = "diabaas3@gmail.com"; 

const S = {
    load: (k, d) => { try { const v = localStorage.getItem('d_'+k); return v ? JSON.parse(v) : d; } catch(e) { return d; } },
    save: (k, v) => localStorage.setItem('d_'+k, JSON.stringify(v)),
    remove: (k) => localStorage.removeItem('d_'+k)
};

const emitCmd = (type, payload) => window.dispatchEvent(new CustomEvent('dashCmd', { detail: { type, payload } }));
const fmtDate = (dStr) => { const p = dStr.split('-'); return p.length===3 ? `${p[2]}-${p[1]}-${p[0]}` : dStr; };

const T = {
    nl: { port: 'Portfolio', ag: 'Agenda', nws: 'Nieuws', rad: 'Investeringen', deal: 'Pepper Deals', rec: 'Recepten', lang: 'Talen', day: 'DAG', wk: 'WEEK', src: 'BRON', blk: 'BLOCK', cal: 'Kalender', std: 'Stand', lst: 'Laatste', new: 'Nieuw Spel' },
    en: { port: 'Portfolio', ag: 'Schedule', nws: 'News', rad: 'Investments', deal: 'Deals', rec: 'Recipes', lang: 'Languages', day: 'DAY', wk: 'WEEK', src: 'SOURCE', blk: 'BLOCK', cal: 'Calendar', std: 'Standings', lst: 'Latest', new: 'New Game' }
};

const Ico = {
    Set: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
    Wea: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>,
    Loc: () => <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
    Bot: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>,
    Cry: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
    Cal: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>,
    Nws: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>,
    Rad: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>,
    Tag: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>,
    F1: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/></svg>,
    Glf: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path strokeWidth="2" d="M12 18a6 6 0 100-12 6 6 0 000 12z"/></svg>,
    Trp: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 4v2a4 4 0 01-8 0V4m12 4v2a4 4 0 01-1 2.652M4 8v2a4 4 0 001 2.652M12 20v-4m0 0V11m0 5h-4m4 0h4" /></svg>,
    Clip: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>,
    Mail: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>,
    Up: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M5 15l7-7 7 7"/></svg>,
    Dn: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M19 9l-7 7-7-7"/></svg>,
    Drag: () => <svg className="w-4 h-4 text-gray-400 cursor-move" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 8h16M4 16h16" /></svg>,
    Lock: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/></svg>
};

function WeatherBar({ lang }) {
    const [c, setC] = useState(() => {
        const saved = S.load('wcity', '');
        if (saved === 'Huidige Locatie') return ''; 
        return saved;
    });
    const [w, setW] = useState(null);
    const [locLoading, setLocLoading] = useState(false);
    const [autoGps, setAutoGps] = useState(() => S.load('auto_gps', true));
    
    const [isEditing, setIsEditing] = useState(false);
    const [editVal, setEditVal] = useState('');

    const syncWeather = () => {
        const cloudSettings = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('d_')) {
                cloudSettings[key.substring(2)] = JSON.parse(localStorage.getItem(key));
            }
        }
        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: ALLOWED_EMAIL, settings: cloudSettings })
        }).catch(()=>{});
    };

    useEffect(() => { 
        const h = (e) => { 
            if(e.detail.type === 'SET_CITY') { 
                setC(e.detail.payload); 
                S.save('wcity', e.detail.payload);
                setAutoGps(false); 
                S.save('auto_gps', false);
                syncWeather();
            }
        }; 
        window.addEventListener('dashCmd', h); 
        return () => window.removeEventListener('dashCmd', h); 
    }, []);

    const handleLocate = (silent = false) => {
        if(!navigator.geolocation) return;
        setLocLoading(true);
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const { latitude, longitude } = pos.coords;
            try {
                const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=${lang}`);
                const data = await res.json();
                const newCity = data.city || data.locality;
                if(newCity) {
                    setC(newCity);
                    S.save('wcity', newCity);
                    setAutoGps(true);
                    S.save('auto_gps', true);
                    syncWeather();
                }
            } catch(e) { console.error("Locatiefout:", e); }
            setLocLoading(false);
        }, () => {
            setLocLoading(false); 
            setAutoGps(false); 
            S.save('auto_gps', false);
        }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }); 
    };

    useEffect(() => { 
        if (autoGps || !c) handleLocate(true); 
    }, []);
    
    useEffect(() => {
        if (!c) return;
        fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(c)}&format=json&limit=1`)
        .then(r=>r.json())
        .then(d=>{
            if(d && d.length > 0){
                const { lat, lon, name } = d[0];
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,precipitation,weather_code&hourly=precipitation_probability&timezone=auto`)
                .then(r=>r.json()).then(wd => { 
                    const ch=new Date().getHours(); 
                    let rf=null; 
                    for(let i=ch; i<ch+12; i++) { 
                        if(wd.hourly && wd.hourly.precipitation_probability[i]>30){rf=i-ch;break;} 
                    } 
                    setW({ t: Math.round(wd.current.temperature_2m), f: Math.round(wd.current.apparent_temperature), code: wd.current.weather_code || wd.current.weathercode, rain: rf, name: name }); 
                });
            } else {
                setW(prev => ({ ...prev, name: "Niet gevonden" }));
            }
        }).catch(() => setW(prev => ({ ...prev, name: "Error" })));
    }, [c, lang]);

    const WxIco = ({ code, isLoading }) => {
        if (isLoading) return <svg className="w-4 h-4 shrink-0 animate-spin text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>;
        if (code === 0 || code === undefined || code === null) return <svg className="w-4 h-4 shrink-0 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" /></svg>;
        if (code === 1 || code === 2) return <svg className="w-4 h-4 shrink-0 text-yellow-200" fill="currentColor" viewBox="0 0 24 24"><path fillRule="evenodd" clipRule="evenodd" d="M6.91 10.518c.036-.59.184-1.166.435-1.705.518-1.114 1.4-2.023 2.527-2.601A5.96 5.96 0 0113.5 5.5c1.196 0 2.338.35 3.303.978.895.584 1.593 1.399 2.016 2.353.424.953.535 2.018.318 3.036-.217 1.018-.748 1.93-1.522 2.617a4.498 4.498 0 01-1.144.757h.03a3.5 3.5 0 110 7H6.5a4.5 4.5 0 11.41-8.981v-.001a4.48 4.48 0 01-.41-8.981zM10.25 2.5a.75.75 0 00-1.5 0v1.5a.75.75 0 001.5 0v-1.5zM4.146 5.646a.75.75 0 00-1.06 1.06l1.06 1.06a.75.75 0 001.06-1.06l-1.06-1.06zM2.5 10.25a.75.75 0 000 1.5h1.5a.75.75 0 000-1.5h-1.5z" /></svg>;
        if (code === 3) return <svg className="w-4 h-4 shrink-0 text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path fillRule="evenodd" clipRule="evenodd" d="M6.5 19h11a4.5 4.5 0 001.623-8.697 7.498 7.498 0 00-14.246 1.49A4.5 4.5 0 006.5 19z" /></svg>;
        if (code === 45 || code === 48) return <svg className="w-4 h-4 shrink-0 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M4 7h16v2H4V7zm0 4h16v2H4v-2zm0 4h16v2H4v-2zm4 4h8v2H8v-2z" /></svg>;
        if (code >= 51 && code <= 57) return <svg className="w-4 h-4 shrink-0 text-blue-300" fill="currentColor" viewBox="0 0 24 24"><path d="M6.5 17h11a4.5 4.5 0 001.623-8.697 7.498 7.498 0 00-14.246 1.49A4.5 4.5 0 006.5 17zm1.5 2a1 1 0 10-2 0v2a1 1 0 102 0v-2zm6 0a1 1 0 10-2 0v2a1 1 0 102 0v-2zm6 0a1 1 0 10-2 0v2a1 1 0 102 0v-2z" /></svg>;
        if ((code >= 61 && code <= 67) || (code >= 80 && code <= 82)) return <svg className="w-4 h-4 shrink-0 text-blue-500" fill="currentColor" viewBox="0 0 24 24"><path d="M6.5 16h11a4.5 4.5 0 001.623-8.697 7.498 7.498 0 00-14.246 1.49A4.5 4.5 0 006.5 16zm.854 2.146a.5.5 0 01.146.354v3a.5.5 0 01-1 0v-3a.5.5 0 01.854-.354zm5 0a.5.5 0 01.146.354v4a.5.5 0 01-1 0v-4a.5.5 0 01.854-.354zm5 0a.5.5 0 01.146.354v3a.5.5 0 01-1 0v-3a.5.5 0 01.854-.354z" /></svg>;
        if ((code >= 71 && code <= 77) || code === 85 || code === 86) return <svg className="w-4 h-4 shrink-0 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M6.5 16h11a4.5 4.5 0 001.623-8.697 7.498 7.498 0 00-14.246 1.49A4.5 4.5 0 006.5 16zm-1 3.5a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm5 0a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm5 0a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0z" /></svg>; 
        if (code >= 95) return <svg className="w-4 h-4 shrink-0 text-yellow-500" fill="currentColor" viewBox="0 0 24 24"><path d="M11.623 2.162a1.5 1.5 0 00-1.897 1.13L8.03 9.475H4.5a1.5 1.5 0 00-1.155 2.463l8 9.5a1.5 1.5 0 002.584-1.373l-1.282-5.565h3.853a1.5 1.5 0 001.189-2.42l-4.5-5.5a1.5 1.5 0 00-1.566-.418l-1.566.418v-.001L11.623 2.162z" /></svg>; 
        return <svg className="w-4 h-4 shrink-0 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" /></svg>;
    };

    const saveCity = (val) => {
        if(val && val.trim() !== "") {
            const cleanCity = val.trim();
            setC(cleanCity); 
            S.save('wcity', cleanCity); 
            setAutoGps(false); 
            S.save('auto_gps', false);
            syncWeather();
        }
        setIsEditing(false);
    };

    return (
        <div className="bg-white/5 px-2 md:px-10 py-2.5 border-b border-white/10 flex items-center text-white text-xs font-bold uppercase tracking-widest overflow-hidden w-full">
            <div className="flex gap-2 sm:gap-4 items-center shrink-0 w-full">
                
                <div className="flex items-center gap-1.5 shrink-0 bg-black/20 px-2 py-1.5 rounded-lg border border-white/5 max-w-[45%]">
                    <div 
                        className="flex items-center gap-1.5 cursor-pointer hover:text-blue-300 transition flex-1 min-w-0" 
                        onClick={() => { setIsEditing(true); setEditVal(''); }}
                    >
                        <WxIco code={w?.code} isLoading={locLoading || (!w && c && !isEditing)} />
                        {isEditing ? (
                            <input 
                                autoFocus
                                type="text" 
                                placeholder={c}
                                value={editVal} 
                                onChange={e=>setEditVal(e.target.value)} 
                                onBlur={() => saveCity(editVal)}
                                onKeyDown={e => e.key === 'Enter' && saveCity(editVal)}
                                className="bg-transparent border-b border-blue-400 outline-none w-full text-white text-xs p-0 m-0 placeholder-white/30"
                            />
                        ) : (
                            <span className="truncate block">{w?.name || c || 'Zoeken...'}</span>
                        )}
                    </div>
                    <div className="w-px h-3 bg-white/20 mx-0.5 shrink-0"></div>
                    <button onClick={() => handleLocate(false)} className={`p-1 bg-white/10 rounded hover:bg-white/20 transition shrink-0 ${locLoading ? 'animate-pulse text-blue-300' : autoGps ? 'text-blue-400' : 'text-gray-400'}`} title="Gebruik huidige locatie (GPS)">
                        <Ico.Loc />
                    </button>
                </div>
                
                <div className="flex gap-1.5 items-center shrink-0 bg-black/20 px-2 py-1.5 rounded-lg border border-white/5">
                    <span className="text-sm md:text-base">{w?.t !== undefined ? `${w.t}¬∞C` : '...'}</span>
                    <span className="opacity-40 font-normal">|</span>
                    <span className="opacity-70 text-[10px] whitespace-nowrap">
                        <span className="hidden sm:inline">{lang==='nl'?'Gevoel: ':'Feels: '}</span>
                        {w?.f !== undefined ? `${w.f}¬∞C` : '...'}
                    </span>
                </div>
                
                {w?.rain !== null && w?.rain !== undefined && w.rain <= 1 && (
                    <div className="bg-[#0073b1]/40 border border-[#0073b1]/50 px-2 py-1.5 rounded-lg flex items-center gap-1.5 shrink-0 ml-auto">
                        <span className="w-2 h-2 bg-blue-300 rounded-full animate-pulse shrink-0"></span>
                        <span className="hidden sm:inline">
                            {w.rain === 0 ? (lang==='nl'?"Nu regen":"Raining") : (lang==='nl'?`Regen over ${w.rain}u`:`Rain in ${w.rain}h`)}
                        </span>
                        <span className="sm:hidden text-[10px]">
                            {w.rain === 0 ? "Regen" : `${w.rain}U`}
                        </span>
                    </div>
                )}
            </div>
        </div>
    );
}

function AIWidget({ lang }) {
    const [msg, setMsg] = useState('');
    const [loading, setLoading] = useState(false);
    const [attachedFile, setAttachedFile] = useState(null);
    const fileRef = useRef(null);
    const chatContainerRef = useRef(null);
    const lastUserMsgRef = useRef(null);
    const prevHistLen = useRef(0);

    const [sessions, setSessions] = useState(() => {
        let loadedSessions = [];
        try { loadedSessions = S.load('michael_sessions', []); } catch(e) {}
        
        let savedHist = [];
        try { savedHist = S.load('ai_hist', []); } catch(e) {}
        
        let activeId = null;
        try { activeId = S.load('ai_active_session', null); } catch(e) {}

        if (savedHist && savedHist.length > 0 && savedHist.some(m => m.r === 'usr')) {
            if (activeId) {
                const idx = loadedSessions.findIndex(s => s.id === activeId);
                if (idx !== -1) {
                    loadedSessions[idx].msgs = savedHist;
                } else {
                    const title = savedHist.find(m=>m.r==='usr')?.t?.slice(0,40) || 'Chat';
                    loadedSessions.unshift({id: Date.now(), title, date: new Date().toLocaleDateString('nl-NL'), msgs: savedHist});
                }
            } else {
                const title = savedHist.find(m=>m.r==='usr')?.t?.slice(0,40) || 'Chat';
                loadedSessions.unshift({id: Date.now(), title, date: new Date().toLocaleDateString('nl-NL'), msgs: savedHist});
            }
            loadedSessions = loadedSessions.slice(0, 20);
            S.save('michael_sessions', loadedSessions);
        }
        
        S.save('ai_hist', []);
        S.save('ai_active_session', null);
        return loadedSessions;
    });

    const [activeSession, setActiveSession] = useState(null);
    const [hist, setHist] = useState([]); 

    const [view, setView] = useState('chat');
    const [exp, setExp] = useState(false);

    const [isDesktop, setIsDesktop] = useState(window.innerWidth >= 1024);
    useEffect(() => {
        const handleResize = () => setIsDesktop(window.innerWidth >= 1024);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
    }, []);
    
    const showContent = exp || isDesktop;

    const syncToCloud = () => {
        const cloudSettings = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('d_')) {
                cloudSettings[key.substring(2)] = JSON.parse(localStorage.getItem(key));
            }
        }
        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: ALLOWED_EMAIL, settings: cloudSettings })
        }).catch(()=>{});
    };

    useEffect(() => {
        syncToCloud();
    }, []);

    useEffect(() => {
        if (showContent && hist.length > prevHistLen.current) {
            setTimeout(() => {
                if (chatContainerRef.current && lastUserMsgRef.current) {
                    const container = chatContainerRef.current;
                    const target = lastUserMsgRef.current;
                    container.scrollTo({ top: target.offsetTop - container.offsetTop - 16, behavior: 'smooth' });
                }
            }, 100);
        }
        prevHistLen.current = hist.length;
    }, [hist.length, showContent]);

    const handleFile = (e) => {
        const file = e.target.files[0]; if(!file) return;
        const isImg = file.type.startsWith('image/');
        const reader = new FileReader();
        reader.onload = (ev) => setAttachedFile({name: file.name, type: isImg?'image':'text', content: ev.target.result});
        if(isImg) reader.readAsDataURL(file); else reader.readAsText(file);
    };

    const updateChatState = (newHist) => {
        setHist(newHist);
        S.save('ai_hist', newHist);
        if (activeSession) {
            setSessions(prev => {
                const updated = prev.map(s => s.id === activeSession ? { ...s, msgs: newHist } : s);
                S.save('michael_sessions', updated);
                return updated;
            });
        }
    };

    const deleteMsg = (idx, e) => {
        e.stopPropagation();
        const n = hist.filter((_,i)=>i!==idx);
        updateChatState(n);
        syncToCloud();
    };

    const saveCurrentSession = () => {
        if(hist.length === 0 || !hist.some(m => m.r === 'usr')) return;
        
        let updatedSessions = [...sessions];
        if (activeSession) {
            updatedSessions = updatedSessions.map(s => s.id === activeSession ? { ...s, msgs: hist } : s);
        } else {
            const title = hist.find(m=>m.r==='usr')?.t?.slice(0,40) || 'Chat';
            const session = {id: Date.now(), title, date: new Date().toLocaleDateString('nl-NL'), msgs: hist};
            updatedSessions = [session, ...updatedSessions].slice(0, 20);
        }
        setSessions(updatedSessions);
        S.save('michael_sessions', updatedSessions);
    };

    const newChat = () => {
        saveCurrentSession();
        setHist([]); 
        S.save('ai_hist', []);
        setActiveSession(null); 
        S.save('ai_active_session', null);
        setView('chat');
        syncToCloud();
    };

    const loadSession = (session) => {
        saveCurrentSession();
        setHist(session.msgs); 
        S.save('ai_hist', session.msgs);
        setActiveSession(session.id); 
        S.save('ai_active_session', session.id);
        setView('chat');
        syncToCloud();
    };

    const deleteSession = (id, e) => {
        e.stopPropagation();
        const updated = sessions.filter(s=>s.id!==id);
        setSessions(updated); 
        S.save('michael_sessions', updated);
        if (activeSession === id) {
            setHist([]); 
            S.save('ai_hist', []);
            setActiveSession(null); 
            S.save('ai_active_session', null);
            setView('history');
        }
        syncToCloud();
    };

    const tryDashboardCommand = (input) => {
        const low = input.toLowerCase().replace(/[?!.,'"]/g, '');
        
        if(/\b(weer|weather|temperatuur|graden|locatie)\b/.test(low)) {
            let city = null;
            const match = low.match(/(?:naar|in|op|voor|van|to|for|at|of)\s+([a-z√†-√ø\s-]+)/i);
            if (match && match[1]) { city = match[1].replace(/\b(de|het|een|the|a|locatie|location)\b/gi, '').trim(); } 
            else { city = low.replace(/\b(pas|het|weer|aan|verander|toon|laat|zien|huidige|locatie|temperatuur|graden|wat|is|hoe|van|de|een)\b/gi, '').trim(); }
            if (city && city.length >= 2) {
                const cleanCity = city.split(/\s+/).filter(Boolean).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                emitCmd('SET_CITY', cleanCity);
                return lang === 'nl' ? `‚úÖ Weerlocatie aangepast naar **${cleanCity}**.` : `‚úÖ Weather location set to **${cleanCity}**.`;
            }
            return null;
        }
        if(/\b(agenda|schedule|kalender|calendar)\b/.test(low)) {
            const m = low.match(/(?:van|voor|of|for)\s+([a-z√†-√ø]+)/i);
            if(m) { emitCmd('SET_AGENDA', m[1].trim()); return lang==='nl'?`‚úÖ Agenda gefilterd op ${m[1].trim()}.`:`‚úÖ Schedule filtered for ${m[1].trim()}.`; }
        }
        if(/\b(nieuws|news)\b/.test(low)) {
            const m = low.match(/(?:over|about|van|of)\s+([a-z√†-√ø0-9\s]+)/i);
            if(m) { emitCmd('SET_NEWS', m[1].trim()); return lang==='nl'?`‚úÖ Nieuws gefilterd op ${m[1].trim()}.`:`‚úÖ News filtered for ${m[1].trim()}.`; }
        }
        if(/\b(sport|resultat|f1|formula|voetbal|football|race)\b/.test(low)) {
            const m = low.match(/(?:van|for|over|about)\s+([a-z√†-√ø0-9\s]+)/i);
            const q = m ? m[1].trim() : 'verstappen';
            emitCmd('SET_SPORTS', q);
            return lang==='nl'?`‚úÖ Sport gefilterd op ${q}.`:`‚úÖ Sports filtered for ${q}.`;
        }
        return null;
    };

    const send = async () => {
        if(!msg.trim() && !attachedFile) return;
        let displayMsg = msg.trim();
        if(attachedFile) displayMsg = `[Bijgevoegd: ${attachedFile.name}]\n${displayMsg}`;
        
        const n = [...hist, {r:'usr', t: displayMsg, file: attachedFile}];
        updateChatState(n);
        setMsg(''); setAttachedFile(null); 
        if(fileRef.current) fileRef.current.value = '';

        const cmdResult = tryDashboardCommand(displayMsg);
        if(cmdResult) {
            setTimeout(() => {
                const r = [...n, {r:'ai', t: cmdResult}];
                updateChatState(r);
                syncToCloud();
            }, 400);
            return;
        }

        const groqKey = S.load('api_keys_dyn', []).find(a => a.name.toLowerCase().includes('groq'))?.val;
        if(!groqKey) {
            setTimeout(() => {
                const r = [...n, {r:'ai', t: lang==='nl'?'‚ö†Ô∏è Geen Groq key gevonden. Ga naar Instellingen ‚Üí API Keys ‚Üí voeg een key toe met naam **Groq**.':'‚ö†Ô∏è No Groq key found.'}];
                updateChatState(r);
                syncToCloud();
            }, 400);
            return;
        }

        setLoading(true);
        const system = {role:'system', content: lang==='nl'
            ? 'Je bent een snelle en behulpzame AI-assistent in een persoonlijk dashboard. Antwoord beknopt en direct in het Nederlands. Vermijd onnodige introducties.'
            : 'You are a fast AI assistant in a personal dashboard. Answer concisely.'
        };
        const recent = n.slice(-8).map(m => {
            if(m.r==='usr' && m.file?.type==='text') return {role:'user', content:`Bestand ${m.file.name}:\n${m.file.content.slice(0,3000)}\n\n${m.t.replace(/\[Bijgevoegd:.*?\]\n/,'')}`};
            if(m.r==='usr' && m.file?.type==='image') return {role:'user', content:[
                {type:'text', text: m.t.replace(/\[Bijgevoegd:.*?\]\n/,'') || 'Beschrijf deze afbeelding.'},
                {type:'image_url', image_url:{url: m.file.content}}
            ]};
            return {role: m.r==='usr'?'user':'assistant', content: m.t};
        });

        try {
            let useModel = attachedFile?.type === 'image' ? 'llama-3.2-11b-vision-preview' : 'llama-3.3-70b-versatile';
            const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method:'POST',
                headers:{'Authorization':`Bearer ${groqKey}`, 'Content-Type':'application/json'},
                body: JSON.stringify({model: useModel, messages: [system, ...recent], temperature: 0.7, max_tokens: 2048})
            });
            const data = await res.json();
            if(data.choices?.[0]?.message?.content) {
                const r = [...n, {r:'ai', t: data.choices[0].message.content}];
                updateChatState(r);
                syncToCloud();
            } else if(data.error) {
                const r = [...n, {r:'ai', t: `‚ö†Ô∏è API Error: ${data.error.message}`}];
                updateChatState(r);
                syncToCloud();
            }
        } catch(e) {
            const r = [...n, {r:'ai', t:'‚ö†Ô∏è Netwerkfout. Check je verbinding.'}];
            updateChatState(r);
            syncToCloud();
        }
        setLoading(false);
    };

    const lastUserIdx = hist.map(m=>m.r).lastIndexOf('usr');

    return (
        <div className={`widget ai-transition relative flex flex-col overflow-hidden ${showContent ? 'h-[450px]' : 'h-[72px]'}`}>
            <div className={`p-4 bg-white border-b flex justify-between items-center shrink-0 z-20 ${!isDesktop ? 'cursor-pointer' : ''}`} onClick={() => { if(!isDesktop) setExp(true); }}>
                <div className="flex items-center gap-2">
                    <img src="https://i.postimg.cc/NLqKzZ4C/nieuw-schaap-logo1.png" alt="AI Logo" className="w-8 h-8 object-contain mix-blend-multiply" />
                </div>
                {showContent ? (
                    <div className="flex items-center gap-2">
                        <button onClick={e=>{e.stopPropagation();setView(view==='history'?'chat':'history')}} className={`px-2.5 py-1 rounded-full text-[9px] font-bold transition ${view==='history'?'bg-blue-100 text-blue-700':'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>
                            {view==='history'?'‚Üê Chat':'üìã Historie'}
                        </button>
                        {view==='chat' && <button onClick={e=>{e.stopPropagation();newChat()}} className="px-2.5 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-[9px] font-bold text-gray-500 transition">+ Nieuw</button>}
                        {!isDesktop && <button onClick={e=>{e.stopPropagation();setExp(false)}} className="text-gray-400 hover:text-gray-800 transition font-bold text-lg ml-1">√ó</button>}
                    </div>
                ) : <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider block lg:hidden">Openen ‚ñº</div>}
            </div>

            {showContent && view === 'chat' && (
                <>
                    <div ref={chatContainerRef} className="flex-1 overflow-y-auto p-4 space-y-4 hide-scroll relative" style={{overscrollBehavior:'contain'}}>
                        {hist.map((m,i) => {
                            const isAi = m.r === 'ai';
                            return (
                                <div key={i} ref={i === lastUserIdx ? lastUserMsgRef : null} className={`flex flex-col ${isAi?'items-start':'items-end'} group relative`}>
                                    <div className="flex items-start gap-1.5 max-w-[95%]">
                                        {!isAi && <button onClick={(e)=>deleteMsg(i, e)} className="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition mt-2 text-[10px]">‚úï</button>}
                                        <div className={`px-4 py-2.5 rounded-2xl text-[13.5px] leading-relaxed shadow-sm whitespace-pre-wrap transition ${isAi?'bg-[#f0f4f9] text-gray-800 rounded-bl-sm':'bg-[#0b57d0] text-white rounded-br-sm'}`}>
                                            {m.t.includes('[Bijgevoegd:') && <div className="text-[10px] opacity-60 mb-1.5 pb-1 border-b border-current/20 italic">üìé {m.t.split('\n')[0].replace('[Bijgevoegd: ','').replace(']','')}</div>}
                                            {m.t.replace(/\[Bijgevoegd:.*?\]\n/,'')}
                                        </div>
                                        {isAi && <button onClick={(e)=>deleteMsg(i, e)} className="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition mt-2 text-[10px]">‚úï</button>}
                                    </div>
                                </div>
                            );
                        })}
                        {loading && (
                            <div className="flex items-start">
                                <div className="bg-[#f0f4f9] px-4 py-3 rounded-2xl rounded-bl-sm shadow-sm">
                                    <div className="flex gap-1.5"><span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay:'0ms'}}/><span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay:'150ms'}}/><span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay:'300ms'}}/></div>
                                </div>
                            </div>
                        )}
                        <div className="h-4"></div>
                    </div>
                    
                    <div className="p-3 bg-white border-t shrink-0 z-20">
                        {attachedFile && (
                            <div className="flex items-center gap-2 bg-blue-50 border border-blue-100 text-blue-700 text-[10px] font-bold px-3 py-1.5 rounded-lg w-fit mb-2 shadow-sm">
                                üìé {attachedFile.name}
                                <button onClick={()=>setAttachedFile(null)} className="hover:text-red-500 ml-1">√ó</button>
                            </div>
                        )}
                        <div className="flex items-center gap-2 bg-[#f0f4f9] rounded-full p-1.5 pl-3 border border-transparent focus-within:border-gray-300 transition shadow-inner">
                            <input type="file" ref={fileRef} accept="image/*,text/*,.pdf,.csv,.json" onChange={handleFile} className="hidden"/>
                            <button onClick={()=>fileRef.current.click()} className="text-gray-400 hover:text-gray-800 transition p-0.5" title="Bestand of Foto toevoegen">
                                <Ico.Clip/>
                            </button>
                            <input value={msg} onChange={e=>setMsg(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}}} placeholder={lang==='nl'?'Vraag of commando...':'Question or command...'} className="flex-1 bg-transparent text-[13px] outline-none px-2 text-gray-800 placeholder-gray-400" disabled={loading}/>
                            
                            <div className="flex items-center gap-1 bg-white rounded-full p-1 shadow-sm border border-gray-100 pr-1 pl-1">
                                <button onClick={send} disabled={loading || (!msg.trim() && !attachedFile)} className={`flex items-center justify-center w-8 h-8 rounded-full transition shrink-0 ${msg.trim()||attachedFile?'bg-[#0b57d0] text-white shadow-md hover:bg-blue-800':'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>
                                    <svg className="w-4 h-4 ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </>
            )}

            {showContent && view === 'history' && (
                <div className="flex-1 overflow-y-auto p-4 space-y-2 hide-scroll">
                    {sessions.length === 0 ? (
                        <div className="flex-1 flex items-center justify-center text-gray-400 text-xs font-bold h-full">
                            {lang==='nl'?'Nog geen opgeslagen chats.':'No saved chats yet.'}
                        </div>
                    ) : sessions.map(s => (
                        <div key={s.id} onClick={()=>loadSession(s)} className={`p-3 rounded-lg border cursor-pointer transition hover:border-gray-300 hover:bg-gray-50 ${activeSession===s.id?'border-gray-400 bg-gray-50':'border-gray-100 bg-white'}`}>
                            <div className="flex justify-between items-start">
                                <div className="flex-1 min-w-0">
                                    <div className="text-xs font-bold text-gray-800 truncate">{s.title}</div>
                                    <div className="text-[10px] text-gray-400 mt-0.5">{s.date} ¬∑ {s.msgs.length} berichten</div>
                                </div>
                                <button onClick={e=>deleteSession(s.id, e)} className="text-gray-300 hover:text-red-500 transition text-xs ml-2 shrink-0">‚úï</button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

function CryptoWidget({ lang }) {
    const [valuta, setValuta] = useState('EUR'); 
    const [exRate, setExRate] = useState(1);
    const [portfolio, setPortfolio] = useState([]);
    const [totalEur, setTotalEur] = useState(0);
    const [loading, setLoading] = useState(true);
    const [err, setErr] = useState('');

    useEffect(() => {
        if(valuta === 'USD') {
            fetch('https://open.er-api.com/v6/latest/EUR')
                .then(r=>r.json()).then(d => setExRate(d.rates.USD))
                .catch(() => setExRate(1.08)); 
        } else {
            setExRate(1);
        }
    }, [valuta]);

    useEffect(() => {
        const fetchBitvavo = async () => {
            const bvKeys = S.load('bitvavo_keys', {pub: '', sec: ''});
            if(!bvKeys || !bvKeys.pub || !bvKeys.sec) {
                setErr(lang==='nl'?'Vul je Bitvavo keys in via Instellingen':'Enter Bitvavo keys in Settings');
                setLoading(false); return;
            }
            try {
                const res = await fetch('/api/bitvavo', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key: bvKeys.pub, secret: bvKeys.sec })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error);

                let calcTotal = 0;
                let combined = data.balances.map(b => {
                    const amount = parseFloat(b.available) + parseFloat(b.inOrder);
                    if(b.symbol === 'EUR') { 
                        calcTotal += amount; 
                        return { sym: 'EUR', amount, price: 1, val: amount, tr: {d: 0, w: 0, m: 0, y: 0, sparkline: ''} }; 
                    }
                    const priceObj = data.prices.find(p => p.market === `${b.symbol}-EUR`);
                    const price = priceObj ? parseFloat(priceObj.price) : 0;
                    const val = amount * price;
                    calcTotal += val;
                    return { sym: b.symbol, amount, price, val, tr: {d: 0, w: 0, m: 0, y: 0, sparkline: ''} };
                }).filter(b => b.val > 0).sort((a,b) => b.val - a.val);

                setPortfolio(combined); 
                setTotalEur(calcTotal); 
                setErr('');

                try {
                    const t24Res = await fetch('https://api.bitvavo.com/v2/ticker/24h');
                    const t24Data = await t24Res.json();
                    
                    combined = combined.map(coin => {
                        if(coin.sym === 'EUR') return coin;
                        const t = t24Data.find(x => x.market === `${coin.sym}-EUR`);
                        if(t && parseFloat(t.open) > 0) {
                            coin.tr.d = ((parseFloat(t.last) - parseFloat(t.open)) / parseFloat(t.open)) * 100;
                        }
                        return coin;
                    });
                    setPortfolio([...combined]);

                    combined.forEach(async (coin) => {
                        if(coin.sym === 'EUR') return;
                        try {
                            const cRes = await fetch(`https://api.bitvavo.com/v2/${coin.sym}-EUR/candles?interval=1d&limit=366`);
                            const candles = await cRes.json();
                            
                            const hRes = await fetch(`https://api.bitvavo.com/v2/${coin.sym}-EUR/candles?interval=1h&limit=24`);
                            const hCandles = await hRes.json();

                            setPortfolio(prev => {
                                const nw = [...prev];
                                const matchIdx = nw.findIndex(x => x.sym === coin.sym);
                                if(matchIdx > -1) {
                                    if(Array.isArray(candles) && candles.length > 0) {
                                        const curPrice = parseFloat(candles[0][4]);
                                        const getTr = (d) => candles.length > d ? ((curPrice - parseFloat(candles[d][4])) / parseFloat(candles[d][4])) * 100 : 0;
                                        nw[matchIdx].tr.w = getTr(7);
                                        nw[matchIdx].tr.m = getTr(30);
                                        nw[matchIdx].tr.y = getTr(365);
                                    }
                                    if(Array.isArray(hCandles) && hCandles.length > 0) {
                                        const closes = hCandles.map(c => parseFloat(c[4])).reverse();
                                        const min = Math.min(...closes);
                                        const max = Math.max(...closes);
                                        const range = max - min || 1;
                                        nw[matchIdx].tr.sparkline = closes.map((v, idx) => {
                                            const x = (idx / (closes.length - 1)) * 40;
                                            const y = 20 - (((v - min) / range) * 20);
                                            return `${x},${y}`;
                                        }).join(' ');
                                    }
                                }
                                return nw;
                            });
                        } catch(e) {}
                    });
                } catch (e) { console.error("Trends ophalen mislukt:", e); }

            } catch (error) { setErr(error.message); }
            setLoading(false);
        };
        fetchBitvavo();
    }, [lang]);
    
    const sym = valuta === 'EUR' ? '‚Ç¨' : '$';
    const displayTotal = totalEur * exRate;
    const totalTrend = portfolio.reduce((acc, c) => acc + (c.tr.d * (c.val / (totalEur || 1))), 0);
    const totalColor = totalTrend >= 0 ? 'text-green-600' : 'text-red-600';

    return (
        <div className="widget h-[450px] flex flex-col">
            <div className="p-4 bg-gray-50 border-b flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2 text-gray-500"><Ico.Cry/><h3 className="text-[10px] font-black uppercase tracking-widest">Live Bitvavo</h3></div>
                <div className="flex gap-1 bg-gray-200 p-1 rounded">
                    {['EUR', 'USD'].map(v => (
                        <button key={v} onClick={()=>setValuta(v)} className={`px-2 py-0.5 text-[8px] font-bold rounded uppercase ${valuta===v?'bg-white shadow-sm text-blue-700':'text-gray-500'}`}>{v}</button>
                    ))}
                </div>
            </div>
            <div className="p-5 flex-1 flex flex-col bg-white overflow-hidden">
                <div className="mb-4 shrink-0 flex justify-between items-start">
                    <div>
                        <span className="text-[10px] font-bold text-gray-400 block mb-1">TOTAAL WALLET</span>
                        <div className={`text-3xl font-black tracking-tight ${loading || err ? 'text-gray-900' : totalColor}`}>
                            {loading ? '...' : err ? 'Error' : `${sym} ${displayTotal.toLocaleString('nl-NL', {maximumFractionDigits:0})}`}
                        </div>
                    </div>
                </div>
                
                {loading ? <div className="flex-1 flex justify-center items-center text-xs font-bold text-blue-500 animate-pulse">Syncing met Bitvavo API...</div> : 
                 err ? <div className="flex-1 text-[10px] text-red-500 font-bold p-4 bg-red-50 rounded border border-red-100 flex items-center justify-center text-center">{err}</div> :
                 (
                    <div className="space-y-3 overflow-y-auto flex-1 hide-scroll pr-1 pb-2">
                        {portfolio.map((c, i) => {
                            const isPos = c.tr.d >= 0;
                            const bgClass = isPos ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                            const P = ({v}) => <span className={v>=0?'text-green-600':'text-red-600'}>{v>0?'+':''}{(v || 0).toFixed(2)}%</span>;
                            
                            const displayVal = c.val * exRate;
                            const displayPrice = c.price * exRate;
                            const displayUnits = c.amount > 100 ? c.amount.toLocaleString('nl-NL', {maximumFractionDigits: 2}) : c.amount.toLocaleString('nl-NL', {maximumFractionDigits: 6});
                            
                            const defaultSpark = isPos ? "0,20 8,10 16,15 24,5 32,8 40,0" : "0,0 8,10 16,5 24,15 32,12 40,20";

                            return (
                                <div key={i} className={`relative p-3 border rounded-lg flex flex-col shadow-sm transition overflow-hidden ${bgClass}`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="w-1/3">
                                            <span className="font-black text-lg block text-gray-900 leading-none">{c.sym}</span>
                                            <span className="text-[10px] text-gray-600 font-medium mt-1 block">{displayUnits} units</span>
                                        </div>
                                        <div className="w-1/3 flex flex-col items-center justify-center gap-1">
                                            <svg viewBox="0 0 40 20" className="w-10 h-4 overflow-visible">
                                                <polyline points={c.tr.sparkline || defaultSpark} fill="none" stroke={isPos ? '#16a34a' : '#dc2626'} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
                                            </svg>
                                            <span className={`text-xs font-black ${isPos ? 'text-green-600' : 'text-red-600'}`}>{isPos?'+':''}{(c.tr.d || 0).toFixed(2)}%</span>
                                        </div>
                                        <div className="w-1/3 text-right">
                                            <span className={`font-bold text-lg block leading-none ${isPos ? 'text-green-600' : 'text-red-600'}`}>{sym}{displayPrice.toLocaleString('nl-NL', {maximumFractionDigits: displayPrice < 1 ? 4 : 2})}</span>
                                            <span className="text-[10px] text-gray-500 font-mono mt-1 block">Waarde: {sym}{displayVal.toLocaleString('nl-NL',{maximumFractionDigits:0})}</span>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center pt-2 mt-1 border-t border-black/10 text-[9px] font-black uppercase tracking-tighter">
                                        <div>1W: <P v={c.tr.w}/></div>
                                        <div>1M: <P v={c.tr.m}/></div>
                                        <div>1J: <P v={c.tr.y}/></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>
        </div>
    );
}

class WidgetErrorBoundary extends React.Component {
    constructor(props) { super(props); this.state = { hasError: false, error: null }; }
    static getDerivedStateFromError(error) { return { hasError: true, error }; }
    componentDidCatch(err, info) { console.error(`[${this.props.name}] Widget crash:`, err, info); }
    render() {
        if (this.state.hasError) return (
            <div className="widget p-4">
                <div className="bg-red-50 border border-red-200 rounded p-3 text-center">
                    <p className="text-red-600 font-bold text-xs mb-1">‚ö†Ô∏è {this.props.name} ‚Äì Fout</p>
                    <p className="text-red-500 text-[10px] mb-2">{this.state.error?.message || 'Onbekende fout'}</p>
                    <button onClick={() => this.setState({ hasError: false, error: null })} className="bg-red-600 text-white px-3 py-1 rounded text-[10px] font-bold hover:bg-red-700">Opnieuw proberen</button>
                </div>
            </div>
        );
        return this.props.children;
    }
}

async function fetchWithRetry(url, options, retries = 1) {
    for (let i = 0; i <= retries; i++) {
        try {
            const res = await fetch(url, options);
            if (res.ok || i === retries) return res;
            if (res.status === 502 || res.status === 503) {
                await new Promise(r => setTimeout(r, 2000));
                continue;
            }
            return res;
        } catch (e) {
            if (i === retries) throw e;
            await new Promise(r => setTimeout(r, 2000));
        }
    }
}

function AgendaWidget({ lang }) {
    const rawCals = S.load('icals_dyn', [{name: 'Agenda', val: ''}]);
    const cals = (Array.isArray(rawCals)?rawCals:[]).map(c=>c?.name).filter(Boolean);
    
    const getLocalYYYYMMDD = (dateObj) => { return `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`; };
    const todayStr = getLocalYYYYMMDD(new Date());

    const [view, setView] = useState('dag'); 
    const [d, setD] = useState(todayStr); 
    const [f, setF] = useState(cals);
    const [items, setItems] = useState([]);
    const [loading, setLoading] = useState(true);
    const [groupBy, setGroupBy] = useState('person'); 
    
    const getDayStr = (dStr) => { const days = ['zo', 'ma', 'di', 'wo', 'do', 'vr', 'za']; return days[new Date(dStr||todayStr).getDay()]; };

    useEffect(() => { const h = (e) => { if(e.detail.type === 'SET_AGENDA') { const target = cals.find(c => (c||'').toLowerCase().includes((e.detail.payload||'').toLowerCase())); if(target) setF([target]); }}; window.addEventListener('dashCmd', h); return () => window.removeEventListener('dashCmd', h); }, [cals]);
    useEffect(() => { setF(cals); }, [JSON.stringify(cals)]);

    useEffect(() => {
        const fetchCals = async () => {
            setLoading(true);
            const cacheKey = 'agenda_cache_v3';
            const sig = JSON.stringify(rawCals);
            const cached = sessionStorage.getItem(cacheKey);
            if (cached) {
                try {
                    const { t, d: cachedEvs, s } = JSON.parse(cached);
                    if (Date.now() - t < 900000 && s === sig) { setItems(cachedEvs); setLoading(false); return; }
                } catch(e) {}
            }

            const parseICalDate = (line) => {
                const parts = (line||'').split(':'); if (parts.length < 2) return null;
                const val = parts[parts.length - 1].trim();
                const isUTC = val.endsWith('Z'); const m = val.match(/(\d{4})(\d{2})(\d{2})(?:T(\d{2})(\d{2})(\d{2})?Z?)?/);
                if (!m) return null;
                const year = parseInt(m[1]); const month = parseInt(m[2]) - 1; const day = parseInt(m[3]);
                const hour = m[4] ? parseInt(m[4]) : 0; const min = m[5] ? parseInt(m[5]) : 0; const sec = m[6] ? parseInt(m[6]) : 0;
                const isAllDay = !m[4];
                let dateObj = isUTC ? new Date(Date.UTC(year, month, day, hour, min, sec)) : new Date(year, month, day, hour, min, sec);
                return { date: getLocalYYYYMMDD(dateObj), time: isAllDay ? 'Hele dag' : dateObj.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' }), dateObj, isAllDay };
            };

            const fetchPromises = (Array.isArray(rawCals) ? rawCals : []).map(async (c) => {
                if (!c?.val) return [];
                const calEvs = [];
                try {
                    const res = await fetchWithRetry('/api/ical', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: c.val }) });
                    let txt = '';
                    if (res.ok) { if ((res.headers.get('content-type') || '').includes('application/json')) throw new Error('Proxy fout'); txt = await res.text(); } 
                    else throw new Error(`HTTP ${res.status}`);
                    if (!txt || !txt.includes('BEGIN:VCALENDAR')) throw new Error("Geen kalender data");

                    let cur = {}; let rrule = null; const lines = txt.split(/\r?\n/);
                    for (let k = 0; k < lines.length; k++) {
                        let l = lines[k];
                        while (k + 1 < lines.length && (lines[k+1].startsWith(' ') || lines[k+1].startsWith('\t'))) { k++; l += lines[k].substring(1); }
                        if (l.startsWith('BEGIN:VEVENT')) { cur = {}; rrule = null; }
                        else if (l.startsWith('SUMMARY')) { const idx = l.indexOf(':'); if (idx !== -1) cur.t = l.substring(idx + 1).replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, ' ').replace(/\\/g, ''); }
                        else if (l.startsWith('DTSTART')) { const parsed = parseICalDate(l); if (parsed) { cur.date = parsed.date; cur.time = parsed.time; cur.dateObj = parsed.dateObj; } }
                        else if (l.startsWith('DTEND')) { const parsed = parseICalDate(l); if (parsed && !parsed.isAllDay) cur.endTime = parsed.time; }
                        else if (l.startsWith('RRULE:')) { rrule = l; }
                        else if (l.startsWith('END:VEVENT') && cur.t && cur.date) {
                            if (rrule && cur.dateObj) {
                                const params = {}; rrule.replace('RRULE:', '').split(';').forEach(p => { const [k, v] = p.split('='); params[k] = v; });
                                const freq = params.FREQ; const count = params.COUNT ? parseInt(params.COUNT) : 200;
                                const untilMatch = params.UNTIL ? params.UNTIL.match(/(\d{4})(\d{2})(\d{2})/) : null;
                                const until = untilMatch ? new Date(parseInt(untilMatch[1]), parseInt(untilMatch[2])-1, parseInt(untilMatch[3]), 23, 59, 59) : null;
                                const interval = params.INTERVAL ? parseInt(params.INTERVAL) : 1;
                                const now = new Date(); const rangeStart = new Date(now); rangeStart.setDate(rangeStart.getDate() - 7); 
                                const rangeEnd = new Date(now); rangeEnd.setDate(rangeEnd.getDate() + 60); 
                                let current = new Date(cur.dateObj); let generated = 0;
                                for (let i = 0; i < 500 && generated < count; i++) {
                                    if (until && current > until) break; if (current > rangeEnd) break;
                                    if (current >= rangeStart) { calEvs.push({ t: cur.t, p: c.name, time: cur.time, endTime: cur.endTime, date: getLocalYYYYMMDD(current) }); }
                                    generated++;
                                    if (freq === 'DAILY') current.setDate(current.getDate() + interval);
                                    else if (freq === 'WEEKLY') current.setDate(current.getDate() + (7 * interval));
                                    else if (freq === 'MONTHLY') current.setMonth(current.getMonth() + interval);
                                    else if (freq === 'YEARLY') current.setFullYear(current.getFullYear() + interval);
                                    else break; 
                                }
                            } else {
                                calEvs.push({ t: cur.t, p: c.name, date: cur.date, time: cur.time, endTime: cur.endTime });
                            }
                        }
                    }
                } catch (e) { calEvs.push({ t: `‚ö† ${c.name} fout`, p: c.name, date: d, time: '00:00' }); }
                return calEvs;
            });

            const results = await Promise.all(fetchPromises);
            let allEvs = [];
            results.forEach(res => allEvs.push(...res));
            if (allEvs.length === 0) allEvs = [{ t: 'Geen afspraken', p: cals[0] || 'Systeem', date: d, time: '00:00' }];
            
            try { sessionStorage.setItem(cacheKey, JSON.stringify({ t: Date.now(), d: allEvs, s: sig })); } catch(e) {}
            setItems(allEvs); setLoading(false);
        };
        fetchCals();
    }, [JSON.stringify(rawCals)]);

    const getColorHex = (name) => {
        if (!name) return '#9ca3af'; 
        const n = String(name).toLowerCase();
        if (n.includes('ryan')) return '#ef4444'; 
        if (n.includes('yaron')) return '#3b82f6'; 
        if (n.includes('michael')) return '#22c55e'; 
        if (n.includes('fam')) return '#f97316'; 
        return '#a855f7'; 
    };

    const safeD = d || todayStr;
    const tEnd = new Date(safeD); tEnd.setDate(tEnd.getDate() + 6); const dEnd = getLocalYYYYMMDD(tEnd);
    
    const getWeekNumber = (dateStr) => { const date = new Date(dateStr); date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay()||7)); return Math.ceil(( ( (date - new Date(Date.UTC(date.getUTCFullYear(),0,1))) / 86400000) + 1)/7); };
    
    const filteredItems = (Array.isArray(items)?items:[]).filter(i => (f||[]).includes(i?.p) && (view === 'dag' ? i?.date === safeD : (i?.date >= safeD && i?.date <= dEnd))).sort((a,b) => {
        if(a.date !== b.date) return String(a.date||'').localeCompare(String(b.date||''));
        const tA = (a.time === 'Hele dag' || !a.time) ? '00:00' : String(a.time); const tB = (b.time === 'Hele dag' || !b.time) ? '00:00' : String(b.time); return tA.localeCompare(tB);
    });

    const getSelectedDaySummary = (name) => {
        const evs = (Array.isArray(items)?items:[]).filter(e => e.date === safeD && (e.p || '').toLowerCase().includes((name||'').toLowerCase()) && e.time !== 'Hele dag');
        if (evs.length === 0) return null;
        const times = []; evs.forEach(e => { if(e.time) times.push(e.time); if(e.endTime) times.push(e.endTime); });
        const sorted = times.sort(); return `${name.toUpperCase()}: ${sorted[0]} - ${sorted[sorted.length - 1]}`;
    };
    
    const sumRyan = getSelectedDaySummary('Ryan'); 
    const sumYaron = getSelectedDaySummary('Yaron');

    const navDateText = view === 'dag' 
        ? `${getDayStr(safeD).toUpperCase()} ${fmtDate(safeD).slice(0,5)}` 
        : `${fmtDate(safeD).slice(0,5)} / ${fmtDate(dEnd).slice(0,5)}`;

    return (
        <div className="widget h-[450px] flex flex-col">
            <div className="p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center shrink-0 flex-wrap gap-2">
                <div className="flex items-center gap-2 text-gray-500 font-black tracking-widest text-[10px] uppercase">
                    <Ico.Cal/> {T[lang].ag}
                </div>
                <div className="flex items-center gap-2">
                    <button onClick={()=>setGroupBy(groupBy==='time'?'person':'time')} className="px-3 py-1.5 bg-white border border-gray-200 shadow-sm text-[9px] font-bold rounded uppercase text-gray-600 hover:text-blue-600 transition">
                        {groupBy === 'time' ? 'Groepeer' : 'Sorteer'}
                    </button>
                    <div className="flex bg-gray-200 p-1 rounded relative z-10">
                        <button onClick={(e)=>{e.preventDefault(); setView('dag');}} className={`px-2 py-1 text-[9px] font-bold rounded ${view==='dag'?'bg-white shadow-sm text-blue-700':'text-gray-500'}`}>{T[lang].day}</button>
                        <button onClick={(e)=>{e.preventDefault(); setView('week');}} className={`px-2 py-1 text-[9px] font-bold rounded ${view==='week'?'bg-white shadow-sm text-blue-700':'text-gray-500'}`}>{T[lang].wk}</button>
                    </div>
                </div>
            </div>
            
            <div className="flex border-b border-gray-200 bg-white overflow-x-auto p-2.5 gap-2.5 hide-scroll shrink-0">
                {cals.map(p => {
                    const isActive = (f||[]).includes(p);
                    return (
                        <button 
                            key={p} 
                            onClick={()=>setF(pr=>pr.includes(p)?pr.filter(x=>x!==p):[...pr, p])} 
                            className={`px-3 py-1.5 text-[10px] font-bold rounded uppercase whitespace-nowrap border border-gray-200 border-l-[4px] transition-all ${isActive ? 'bg-[#f8fafc] text-gray-900 shadow-sm' : 'bg-gray-50 text-gray-400 opacity-70 hover:opacity-100'}`}
                            style={{ borderLeftColor: isActive ? getColorHex(p) : '#d1d5db' }}
                        >
                            {p}
                        </button>
                    );
                })}
            </div>
            
            <div className="p-2 flex border-b border-gray-200 bg-gray-50 items-center justify-between shrink-0 gap-1.5 overflow-hidden">
                <div 
                    className="relative flex items-center bg-white border border-gray-200 p-1.5 px-2 rounded shadow-sm hover:bg-gray-100 transition cursor-pointer shrink-0"
                    onClick={(e) => {
                        const input = e.currentTarget.querySelector('input');
                        if (input && typeof input.showPicker === 'function') input.showPicker();
                    }}
                >
                    <span className="text-xs pointer-events-none">üìÖ</span>
                    <span className="text-[10px] font-black text-gray-700 ml-1.5 pointer-events-none">{safeD.slice(8,10)}</span>
                    <input type="date" value={safeD} onChange={(e)=>setD(e.target.value)} className="absolute opacity-0 w-0 h-0" />
                </div>
                
                <div className="flex-1 flex items-center justify-between bg-white border border-gray-200 rounded shadow-sm px-0.5 overflow-hidden min-w-[120px] max-w-[220px]">
                    <button onClick={()=>{const nd=new Date(safeD);nd.setDate(nd.getDate()-(view==='week'?7:1));setD(getLocalYYYYMMDD(nd))}} className="px-2 py-1.5 hover:bg-gray-100 font-bold text-gray-500 transition shrink-0">&lt;</button>
                    <span className="text-[9px] font-black text-center uppercase tracking-wide text-blue-600 whitespace-nowrap px-1 truncate">
                        WK {getWeekNumber(safeD)} <span className="opacity-30 text-gray-400">|</span> <span className="text-gray-700">{navDateText}</span>
                    </span>
                    <button onClick={()=>{const nd=new Date(safeD);nd.setDate(nd.getDate()+(view==='week'?7:1));setD(getLocalYYYYMMDD(nd))}} className="px-2 py-1.5 hover:bg-gray-100 font-bold text-gray-500 transition shrink-0">&gt;</button>
                </div>

                <button onClick={() => setD(todayStr)} className="px-2.5 py-1.5 bg-white border border-gray-200 shadow-sm text-[8px] font-bold rounded uppercase text-blue-600 hover:text-blue-800 transition shrink-0">
                    Vandaag
                </button>
            </div>
            
            <div className="flex-1 p-4 bg-white overflow-y-auto content-start">
                {loading ? ( <div className="text-center text-xs font-bold text-blue-500 animate-pulse mt-10">Agenda synchroniseren...</div> ) : filteredItems.length > 0 ? (
                    groupBy === 'time' ? (
                        <div className="grid grid-cols-2 gap-3">
                            {filteredItems.map((i, idx) => (
                                <div key={idx} className="p-3 bg-white border border-gray-200 border-l-[4px] rounded-lg flex flex-col shadow-sm h-fit transition-shadow hover:shadow-md" style={{ borderLeftColor: getColorHex(i.p) }}>
                                    <span className="font-bold text-[12px] leading-tight text-gray-900 mb-2">{i.t||''}</span>
                                    <div className="flex justify-between items-center mt-auto">
                                        <span className="text-[9px] font-black text-gray-400 uppercase tracking-widest">{view==='week' ? `${getDayStr(i.date)} ${fmtDate(i.date).slice(0,5)} ` : ''}{i.p||''}</span>
                                        <span className="text-blue-600 font-bold font-mono text-[9px] bg-blue-50 px-1.5 py-0.5 rounded leading-tight text-right">{i.time||''}{i.endTime ? ` - ${i.endTime}` : ''}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {(f||[]).map(person => {
                                const personItems = filteredItems.filter(i => i.p === person);
                                if (personItems.length === 0) return null;
                                return (
                                    <div key={person} className="flex flex-col">
                                        <div className="text-[10px] font-black uppercase text-gray-800 bg-gray-50 border border-gray-200 border-l-[4px] rounded-sm px-3 py-1.5 mb-2 w-full" style={{ borderLeftColor: getColorHex(person) }}>
                                            {person}
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            {personItems.map((i, idx) => (
                                                <div key={idx} className="p-3 bg-white border border-gray-200 border-l-[4px] rounded-lg flex flex-col shadow-sm h-fit transition-shadow hover:shadow-md" style={{ borderLeftColor: getColorHex(person) }}>
                                                    <span className="font-bold text-[12px] leading-tight text-gray-900 mb-2">{i.t||''}</span>
                                                    <div className="flex justify-between items-center mt-auto">
                                                        <span className="text-[9px] font-black text-gray-400 uppercase">{view==='week' ? `${getDayStr(i.date)} ${fmtDate(i.date).slice(0,5)}` : ''}</span>
                                                        <span className="text-blue-600 font-bold font-mono text-[9px] bg-blue-50 px-1.5 py-0.5 rounded leading-tight text-right">{i.time||''}{i.endTime ? ` - ${i.endTime}` : ''}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )
                ) : ( <div className="col-span-2 text-center text-[10px] text-gray-400 mt-10 font-bold uppercase tracking-widest">Geen afspraken</div> )}
            </div>
            <div className="bg-gray-50 border-t border-gray-200 p-2 shrink-0 flex items-center justify-center min-h-[36px]">
                <div className="flex gap-6 text-[9px] font-black uppercase tracking-widest text-gray-600">{sumRyan && <span>üéí {sumRyan}</span>}{sumYaron && <span>üéí {sumYaron}</span>}</div>
            </div>
        </div>
    );
}

function NewsWidget({ lang }) {
    const defaultCols = ['AI & TECH', 'F1', 'AUTO', 'CRYPTO', 'LEIDSCHENDAM'];
    const [cols, setCols] = useState(() => S.load('newscats', defaultCols));
    const [manage, setManage] = useState(false);
    const [allArticles, setAllArticles] = useState([]);
    const [feedReady, setFeedReady] = useState(false);

    const [search, setSearch] = useState('');
    const [searchResults, setSearchResults] = useState([]);
    const [isSearching, setIsSearching] = useState(false);
    const [searchDone, setSearchDone] = useState(false);

    const [visibleCount, setVisibleCount] = useState(40);
    const [blocked, setBlocked] = useState(() => S.load('news_blocked', []));
    const [priority, setPriority] = useState(() => S.load('news_priority', []));
    const [sortMode, setSortMode] = useState(() => S.load('news_sort', 'tijd'));
    
    const [feedMode, setFeedMode] = useState(() => S.load('news_feedmode', 'alles'));

    const [newCol, setNewCol] = useState('');
    const [newBlock, setNewBlock] = useState('');
    const [newPriority, setNewPriority] = useState('');

    const searchTimer = useRef(null);

    const syncSettings = () => {
        const s = {};
        for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (k && k.startsWith('d_')) s[k.substring(2)] = JSON.parse(localStorage.getItem(k));
        }
        fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: ALLOWED_EMAIL, settings: s }) }).catch(()=>{});
    };

    async function fastFetch(query, hlParam, glParam, ceidParam) {
        const ctrl = new AbortController();
        const tid = setTimeout(() => { ctrl.abort(); }, 8000);
        
        const gUrl = query === 'ALGEMEEN' 
            ? `https://news.google.com/rss?hl=${hlParam}&gl=${glParam}&ceid=${ceidParam}`
            : `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=${hlParam}&gl=${glParam}&ceid=${ceidParam}`;

        try {
            const apiUrl = `/api/news?q=${encodeURIComponent(query)}&hl=${hlParam}&gl=${glParam}&ceid=${ceidParam}`;
            const r = await fetch(apiUrl, { signal: ctrl.signal });
            if (r.ok) {
                clearTimeout(tid);
                return await r.text();
            }
            throw new Error('API failed');
        } catch(e) {
            try {
                const proxy1 = 'https://corsproxy.io/?' + encodeURIComponent(gUrl);
                const r2 = await fetch(proxy1, { signal: ctrl.signal });
                if (r2.ok) {
                    clearTimeout(tid);
                    return await r2.text();
                }
                throw new Error('Proxy 1 failed');
            } catch(e2) {
                try {
                    const proxy2 = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(gUrl);
                    const r3 = await fetch(proxy2, { signal: ctrl.signal });
                    if (r3.ok) {
                        clearTimeout(tid);
                        return await r3.text();
                    }
                } catch(e3) {
                    clearTimeout(tid);
                    return null;
                }
            }
            clearTimeout(tid);
            return null;
        }
    }

    const parseRSS = (xml, cat) => {
        const doc = new DOMParser().parseFromString(xml, 'text/xml');
        const items = doc.querySelectorAll('item');
        const out = [];
        const max = Math.min(items.length, 60);
        for (let i = 0; i < max; i++) {
            const item = items[i];
            const rawTitle = item.querySelector('title')?.textContent || '';
            const link = item.querySelector('link')?.textContent || '';
            const pubDate = item.querySelector('pubDate')?.textContent || '';
            const srcTag = item.querySelector('source');
            let source = srcTag?.textContent || '';
            const srcUrl = srcTag?.getAttribute('url') || '';
            const desc = item.querySelector('description')?.textContent || '';

            let title = rawTitle;
            const parts = rawTitle.split(' - ');
            if (parts.length > 1) { const s = parts.pop().trim(); title = parts.join(' - '); if (!source) source = s; }
            if (!source) source = lang === 'nl' ? 'Nieuws' : 'News';

            let cleanDesc = desc.replace(/<[^>]+>/g, '').trim();
            if (cleanDesc.toLowerCase().startsWith(title.toLowerCase().substring(0, 30))) cleanDesc = '';

           // Betere artikelafbeelding-extractie
            let img = null;
            
            // 1. Zoek <img> tags in description (Google News stopt hier de artikelafbeelding)
            const imgM = desc.match(/<img[^>]+src=["']([^"']+)["']/i);
            if (imgM) img = imgM[1];
            
            // 2. Zoek directe image-URLs in description
            if (!img) {
                const urlM = desc.match(/(https?:\/\/[^"'\s<>]+\.(?:jpg|jpeg|png|webp|gif|avif)(?:\?[^"'\s<>]*)?)/i);
                if (urlM) img = urlM[1];
            }
            
            // 3. Zoek Google News thumbnail URLs (lh3.googleusercontent.com zonder extensie)
            if (!img) {
                const gnM = desc.match(/(https?:\/\/lh3\.googleusercontent\.com\/[^"'\s<>]+)/i);
                if (gnM) img = gnM[1];
            }
            
            // 4. CDATA fallback
            if (!img && desc.includes('CDATA')) {
                const cdataM = desc.match(/\[CDATA\[(.*?)\]\]/s);
                if (cdataM) {
                    const cdataImg = cdataM[1].match(/<img[^>]+src=["']([^"']+)["']/i) 
                                  || cdataM[1].match(/(https?:\/\/[^"'\s<>]+\.(?:jpg|jpeg|png|webp|gif))/i);
                    if (cdataImg) img = cdataImg[1];
                }
            }
            
            // 5. media:content tag
            if (!img) {
                const mediaContent = item.querySelector('media\\:content, content');
                if (mediaContent) img = mediaContent.getAttribute('url');
            }
            
            // 6. Enclosure tag (sommige feeds)
            if (!img) {
                const enc = item.querySelector('enclosure');
                if (enc && (enc.getAttribute('type') || '').startsWith('image/')) img = enc.getAttribute('url');
            }
            
            // 7. Laatste fallback: GEEN favicon, liever geen afbeelding dan een bronlogo
            // img blijft null ‚Üí widget toont geen afbeelding
            if (pubDate) {
                try {
                    const t = new Date(pubDate).getTime();
                    const limit = Date.now() - (3 * 24 * 60 * 60 * 1000);
                    if (t < limit) continue;
                } catch(e) {}
            }

            out.push({ title: title, link: link, pubDate: pubDate, source: source, desc: cleanDesc, img: img, cat: cat });
        }
        return out;
    };

    useEffect(() => {
        let alive = true;
        const cacheKey = `nws_cache_v15_${lang}`;
        const cached = sessionStorage.getItem(cacheKey);
        if (cached) {
            try {
                const { t, d } = JSON.parse(cached);
                if (Date.now() - t < 900000) { setAllArticles(d); setFeedReady(true); return; }
            } catch(e) {}
        }

        setFeedReady(false);
        const seen = new Set();
        let merged = [];

        const loadCats = async () => {
            const fetchList = ['ALGEMEEN', ...cols];
            for (let i = 0; i < fetchList.length; i++) {
                const cat = fetchList[i];
                if (!alive) return;
                const h = lang === 'nl' ? 'nl' : 'en-US';
                const g = lang === 'nl' ? 'NL' : 'US';
                const c = lang === 'nl' ? 'NL:nl' : 'US:en';
                const xml = await fastFetch(cat, h, g, c);
                if (!xml || !alive) continue;
                
                const items = parseRSS(xml, cat);
                if (!alive) return;

                items.forEach(a => {
                    const key = a.link || a.title.substring(0, 40);
                    if (!seen.has(key)) { seen.add(key); merged.push(a); }
                });
                
                setAllArticles([...merged]);
                sessionStorage.setItem(cacheKey, JSON.stringify({ t: Date.now(), d: merged }));
            }
            if (alive) setFeedReady(true);
        };
        
        loadCats();

        return () => { alive = false; };
    }, [cols, lang]);

    const doSearch = async (q) => {
        if (!q.trim()) { setSearchResults([]); setSearchDone(false); setIsSearching(false); return; }
        setIsSearching(true);
        setSearchDone(false);
        const h = lang === 'nl' ? 'nl' : 'en-US';
        const g = lang === 'nl' ? 'NL' : 'US';
        const c = lang === 'nl' ? 'NL:nl' : 'US:en';
        const xml = await fastFetch(q.trim(), h, g, c);
        if (xml) {
            const items = parseRSS(xml, 'ZOEKEN');
            const unique = []; const urls = new Set();
            items.forEach(a => { if (!urls.has(a.link)) { urls.add(a.link); unique.push(a); } });
            setSearchResults(unique);
        } else {
            setSearchResults([]);
        }
        setIsSearching(false);
        setSearchDone(true);
    };

    const handleSearchInput = (val) => {
        setSearch(val);
        setVisibleCount(40);
        if (searchTimer.current) clearTimeout(searchTimer.current);
        if (!val.trim()) { setSearchResults([]); setSearchDone(false); setIsSearching(false); return; }
        setIsSearching(true);
        searchTimer.current = setTimeout(() => { doSearch(val); }, 400);
    };

    const isSearchActive = search.trim().length > 0;

    const availableSorts = (isSearchActive || feedMode === 'alles') ? ['tijd', 'bron'] : ['tijd', 'bron', 'onderwerp'];
    const sortLabels = {
        tijd: lang === 'nl' ? 'Tijd' : 'Time',
        bron: lang === 'nl' ? 'Bron' : 'Source',
        onderwerp: lang === 'nl' ? 'Onderwerp' : 'Topic'
    };

    const filterSort = (items) => {
        let f = items.filter(a => {
            const txt = (a.title + ' ' + a.source + ' ' + a.desc).toLowerCase();
            if (blocked.some(b => txt.includes(b))) return false;
            
            if (!isSearchActive) {
                if (feedMode === 'alles' && a.cat !== 'ALGEMEEN') return false;
                if (feedMode === 'voorjou' && a.cat === 'ALGEMEEN') return false;
            }

            return true;
        });

        f.sort((a, b) => {
            const tA = new Date(a.pubDate).getTime() || 0;
            const tB = new Date(b.pubDate).getTime() || 0;
            
            let effectiveSort = sortMode;
            if ((isSearchActive || feedMode === 'alles') && sortMode === 'onderwerp') {
                effectiveSort = 'tijd';
            }

            if (effectiveSort === 'bron') {
                let iA = priority.findIndex(p => (a.source||'').toLowerCase().includes(p)); if (iA===-1) iA=9999;
                let iB = priority.findIndex(p => (b.source||'').toLowerCase().includes(p)); if (iB===-1) iB=9999;
                if (iA !== iB) return iA - iB;
                const srcA = (a.source || '').toLowerCase();
                const srcB = (b.source || '').toLowerCase();
                if (srcA < srcB) return -1;
                if (srcA > srcB) return 1;
            }
            if (effectiveSort === 'onderwerp') {
                let iA = cols.findIndex(c => c.toLowerCase() === (a.cat||'').toLowerCase()); if (iA===-1) iA=9999;
                let iB = cols.findIndex(c => c.toLowerCase() === (b.cat||'').toLowerCase()); if (iB===-1) iB=9999;
                if (iA !== iB) return iA - iB;
                const catA = (a.cat || '').toLowerCase();
                const catB = (b.cat || '').toLowerCase();
                if (catA < catB) return -1;
                if (catA > catB) return 1;
            }
            return tB - tA;
        });
        return f;
    };

    const displayItems = filterSort(isSearchActive ? searchResults : allArticles).slice(0, visibleCount);
    const totalFiltered = filterSort(isSearchActive ? searchResults : allArticles).length;

    const formatDate = (d) => {
        if (!d) return '';
        try { const dt = new Date(d); return `${String(dt.getDate()).padStart(2,'0')}-${String(dt.getMonth()+1).padStart(2,'0')}-${dt.getFullYear()} | ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`; }
        catch(e) { return d; }
    };

    const srcColor = (s) => {
        const c = ['#c586c0','#d16b92','#b278a9','#9a73b5','#e27b64','#e2a864','#4a90e2'];
        let h = 0; for (let i=0;i<s.length;i++) { h = s.charCodeAt(i)+((h<<5)-h); }
        return c[Math.abs(h)%c.length];
    };

    const addCol = () => { if(newCol && !cols.includes(newCol.toUpperCase())) { const n=[...cols,newCol.toUpperCase()]; setCols(n); S.save('newscats',n); syncSettings(); setNewCol(''); }};
    const removeCol = (c) => { const n=cols.filter(x=>x!==c); setCols(n); S.save('newscats',n); syncSettings(); };
    const addBlock = () => { if(newBlock && !blocked.includes(newBlock.toLowerCase())) { const n=[...blocked,newBlock.toLowerCase()]; setBlocked(n); S.save('news_blocked',n); syncSettings(); setNewBlock(''); }};
    const removeBlock = (b) => { const n=blocked.filter(x=>x!==b); setBlocked(n); S.save('news_blocked',n); syncSettings(); };
    const addPriority = () => { if(newPriority && !priority.includes(newPriority.toLowerCase())) { const n=[...priority,newPriority.toLowerCase()]; setPriority(n); S.save('news_priority',n); syncSettings(); setNewPriority(''); }};
    const removePriority = (p) => { const n=priority.filter(x=>x!==p); setPriority(n); S.save('news_priority',n); syncSettings(); };
    const handleSortChange = (m) => { setSortMode(m); S.save('news_sort',m); syncSettings(); };

    return (
        <div className="widget h-[500px] flex flex-col bg-white">
            <div className="p-3 bg-[#f8f9fa] border-b border-gray-200 flex flex-wrap justify-between items-center gap-2 shrink-0">
                <div className="flex items-center gap-2 text-gray-600 font-black tracking-widest text-[11px] uppercase shrink-0">
                    <Ico.Nws/> {lang === 'nl' ? 'NIEUWS' : 'NEWS'}
                </div>
                <div className="flex flex-wrap gap-2 flex-1 justify-end items-center">
                    <input
                        type="text"
                        placeholder={lang === 'nl' ? "Zoek nieuws..." : "Search news..."}
                        value={search}
                        onChange={e => handleSearchInput(e.target.value)}
                        className="flex-1 min-w-[120px] max-w-[250px] px-3 py-1.5 text-[16px] md:text-[11px] font-medium border border-gray-200 rounded-md bg-white outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-100 transition"
                    />
                    <button onClick={()=>setManage(!manage)} className="px-3 py-1.5 bg-white border border-gray-200 shadow-sm text-[10px] font-bold rounded text-gray-600 hover:text-blue-600 transition shrink-0">
                        {lang === 'nl' ? 'Beheer' : 'Manage'}
                    </button>
                </div>
            </div>

            <div className="px-3 py-2 bg-gray-50 border-b border-gray-100 flex flex-wrap gap-3 justify-between items-center shrink-0">
                <div className="flex items-center gap-3 flex-wrap">
                    {!isSearchActive ? (
                        <div className="flex gap-1 bg-white p-0.5 rounded-md border border-gray-200 shadow-sm">
                            <button onClick={() => { setFeedMode('alles'); S.save('news_feedmode', 'alles'); syncSettings(); }} className={`px-3 py-1 text-[9px] font-bold rounded transition ${feedMode === 'alles' ? 'bg-blue-50 text-blue-700' : 'text-gray-500 hover:bg-gray-100'}`}>{lang === 'nl' ? 'Algemeen' : 'General'}</button>
                            <button onClick={() => { setFeedMode('voorjou'); S.save('news_feedmode', 'voorjou'); syncSettings(); }} className={`px-3 py-1 text-[9px] font-bold rounded transition ${feedMode === 'voorjou' ? 'bg-blue-50 text-blue-700' : 'text-gray-500 hover:bg-gray-100'}`}>{lang === 'nl' ? 'Voor Jou' : 'For You'}</button>
                        </div>
                    ) : (
                        <span className="text-amber-500 text-[9px] font-bold uppercase tracking-wider">
                            üîç {lang === 'nl' ? 'Zoekresultaten' : 'Search results'}: "{search}" {isSearching && <span className="animate-pulse ml-1">{lang === 'nl' ? 'laden...' : 'loading...'}</span>}
                        </span>
                    )}

                    <div className="flex bg-[#eef0f2] p-0.5 rounded-md border border-gray-200 shrink-0">
                        {availableSorts.map(m => (
                            <button key={m} onClick={()=>handleSortChange(m)} className={`px-2.5 py-1 text-[9px] font-bold rounded uppercase transition ${sortMode===m?'bg-white shadow-sm text-blue-700':'text-gray-500 hover:bg-gray-200'}`}>
                                {sortLabels[m]}
                            </button>
                        ))}
                    </div>
                </div>
                
                <div className="flex items-center gap-4 text-[9px] font-bold text-gray-400 uppercase tracking-wider ml-auto">
                    {!isSearchActive && <span>{!feedReady && <span className="text-blue-500 animate-pulse mr-2">{lang === 'nl' ? 'laden...' : 'loading...'}</span>}</span>}
                    <span className="text-blue-500">{displayItems.length} / {totalFiltered} {lang === 'nl' ? 'getoond' : 'shown'}</span>
                </div>
            </div>

            {manage && (
                <div className="p-4 bg-gray-50 border-b border-gray-200 space-y-3 shrink-0 max-h-[200px] overflow-y-auto">
                    <div>
                        <div className="text-[9px] font-black uppercase text-gray-500 mb-1.5">{lang === 'nl' ? 'Categorie√´n üìå Sleep om prioriteit te bepalen (Links = Hoogste)' : 'Categories üìå Drag to set priority'}</div>
                        <div className="flex flex-wrap gap-1.5">
                            {cols.map((c, idx) => (
                                <span 
                                    key={c} 
                                    draggable 
                                    onDragStart={(e) => { e.dataTransfer.effectAllowed = "move"; e.dataTransfer.setData('catIndex', idx); }}
                                    onDragOver={(e) => { e.preventDefault(); }}
                                    onDrop={(e) => {
                                        e.preventDefault();
                                        const fromIdx = parseInt(e.dataTransfer.getData('catIndex'));
                                        if (fromIdx === idx) return;
                                        const newCols = [...cols];
                                        const [moved] = newCols.splice(fromIdx, 1);
                                        newCols.splice(idx, 0, moved);
                                        setCols(newCols); S.save('newscats', newCols); syncSettings();
                                    }}
                                    className="px-2.5 py-1.5 bg-blue-50 text-blue-700 text-[9px] font-bold rounded border-2 border-blue-200 flex items-center gap-1.5 cursor-move hover:border-blue-400 hover:shadow-sm transition-all"
                                    style={{ borderLeftWidth: idx === 0 ? '4px' : '2px', borderLeftColor: idx === 0 ? '#0073b1' : undefined }}
                                >
                                    <span className="opacity-40">‚ò∞</span> {c} 
                                    <button onClick={(e) => { e.stopPropagation(); removeCol(c); }} className="text-red-400 hover:text-red-600 ml-1">√ó</button>
                                </span>
                            ))}
                        </div>
                        <div className="flex gap-1 mt-1.5">
                            <input value={newCol} onChange={e=>setNewCol(e.target.value)} onKeyDown={e=>{ if (e.key==='Enter') { addCol(); } }} placeholder={lang === 'nl' ? "+ Categorie" : "+ Category"} className="px-2 py-1 text-[10px] border border-gray-200 rounded flex-1 outline-none"/>
                            <button onClick={addCol} className="px-2 py-1 bg-blue-500 text-white text-[9px] font-bold rounded">+</button>
                        </div>
                    </div>
                    <div>
                        <div className="text-[9px] font-black uppercase text-gray-500 mb-1.5">{lang === 'nl' ? 'üö´ Geblokkeerde woorden - Sleep om te sorteren' : 'üö´ Blocked words - Drag to sort'}</div>
                        <div className="flex flex-wrap gap-1.5">
                            {blocked.map((b, idx) => (
                                <span 
                                    key={b}
                                    draggable
                                    onDragStart={(e) => { e.dataTransfer.effectAllowed = "move"; e.dataTransfer.setData('blockIndex', idx); }}
                                    onDragOver={(e) => { e.preventDefault(); }}
                                    onDrop={(e) => {
                                        e.preventDefault();
                                        const fromIdx = parseInt(e.dataTransfer.getData('blockIndex'));
                                        if (fromIdx === idx) return;
                                        const newBlock = [...blocked];
                                        const [moved] = newBlock.splice(fromIdx, 1);
                                        newBlock.splice(idx, 0, moved);
                                        setBlocked(newBlock); S.save('news_blocked', newBlock); syncSettings();
                                    }}
                                    className="px-2.5 py-1.5 bg-red-50 text-red-600 text-[9px] font-bold rounded border-2 border-red-200 flex items-center gap-1.5 cursor-move hover:border-red-400 hover:shadow-sm transition-all"
                                >
                                    <span className="opacity-40">‚ò∞</span> {b} 
                                    <button onClick={(e) => { e.stopPropagation(); removeBlock(b); }} className="hover:text-red-800 ml-1">√ó</button>
                                </span>
                            ))}
                        </div>
                        <div className="flex gap-1 mt-1.5">
                            <input value={newBlock} onChange={e=>setNewBlock(e.target.value)} onKeyDown={e=>{ if (e.key==='Enter') { addBlock(); } }} placeholder={lang === 'nl' ? "+ Blokkeer woord" : "+ Block word"} className="px-2 py-1 text-[10px] border border-gray-200 rounded flex-1 outline-none"/>
                            <button onClick={addBlock} className="px-2 py-1 bg-red-500 text-white text-[9px] font-bold rounded">+</button>
                        </div>
                    </div>
                    <div>
                        <div className="text-[9px] font-black uppercase text-gray-500 mb-1.5">{lang === 'nl' ? '‚≠ê Prioriteit bronnen - Sleep om ranking te bepalen (Links = Hoogste)' : '‚≠ê Priority sources - Drag to set priority'}</div>
                        <div className="flex flex-wrap gap-1.5">
                            {priority.map((p, idx) => (
                                <span 
                                    key={p}
                                    draggable
                                    onDragStart={(e) => { e.dataTransfer.effectAllowed = "move"; e.dataTransfer.setData('prioIndex', idx); }}
                                    onDragOver={(e) => { e.preventDefault(); }}
                                    onDrop={(e) => {
                                        e.preventDefault();
                                        const fromIdx = parseInt(e.dataTransfer.getData('prioIndex'));
                                        if (fromIdx === idx) return;
                                        const newPrio = [...priority];
                                        const [moved] = newPrio.splice(fromIdx, 1);
                                        newPrio.splice(idx, 0, moved);
                                        setPriority(newPrio); S.save('news_priority', newPrio); syncSettings();
                                    }}
                                    className="px-2.5 py-1.5 bg-green-50 text-green-700 text-[9px] font-bold rounded border-2 border-green-200 flex items-center gap-1.5 cursor-move hover:border-green-400 hover:shadow-sm transition-all"
                                    style={{ 
                                        borderLeftWidth: idx === 0 ? '4px' : '2px', 
                                        borderLeftColor: idx === 0 ? '#16a34a' : undefined,
                                        opacity: 1 - (idx * 0.1)
                                    }}
                                >
                                    <span className="opacity-40">‚ò∞</span> #{idx + 1} {p} 
                                    <button onClick={(e) => { e.stopPropagation(); removePriority(p); }} className="hover:text-red-600 ml-1">√ó</button>
                                </span>
                            ))}
                        </div>
                        <div className="flex gap-1 mt-1.5">
                            <input value={newPriority} onChange={e=>setNewPriority(e.target.value)} onKeyDown={e=>{ if (e.key==='Enter') { addPriority(); } }} placeholder={lang === 'nl' ? "+ Prioriteit bron" : "+ Priority source"} className="px-2 py-1 text-[10px] border border-gray-200 rounded flex-1 outline-none"/>
                            <button onClick={addPriority} className="px-2 py-1 bg-green-500 text-white text-[9px] font-bold rounded">+</button>
                        </div>
                    </div>
                </div>
            )}

            <div className="flex-1 overflow-y-auto hide-scroll">
                {displayItems.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-full py-10">
                        {(isSearching || (!feedReady && !isSearchActive)) ? (
                            <div className="text-xs font-bold text-blue-500 animate-pulse">
                                {isSearchActive ? (lang === 'nl' ? `Zoeken naar "${search}"...` : `Searching for "${search}"...`) : (lang === 'nl' ? 'Nieuws synchroniseren...' : 'Syncing news...')}
                            </div>
                        ) : (
                            <div className="text-xs font-bold text-gray-400">
                                {isSearchActive && searchDone ? (lang === 'nl' ? `Geen resultaten voor "${search}"` : `No results for "${search}"`) : (lang === 'nl' ? 'Geen artikelen gevonden.' : 'No articles found.')}
                            </div>
                        )}
                    </div>
                ) : (
                    <div className="space-y-0">
                        {displayItems.map((a, i) => {
                            const isPri = priority.some(p => (a.source||'').toLowerCase().includes(p));
                            return (
                                <a href={a.link} target="_blank" rel="noopener" key={a.link+i}
                                    className={`flex gap-3 px-4 py-3.5 border-b border-gray-100 hover:bg-gray-50 transition group ${isPri && sortMode==='bron' ? 'bg-green-50/30' : ''}`}
                                >
                                    <div className="flex-1 flex flex-col justify-between min-w-0">
                                        <div>
                                            <p className="text-[13px] font-bold leading-snug text-gray-900 group-hover:text-blue-700 transition line-clamp-2">{a.title}</p>
                                            {a.desc && <p className="text-[#0b57d0] font-semibold text-[11px] line-clamp-2 mt-1 leading-snug">{a.desc}</p>}
                                        </div>
                                        <div className="flex justify-between items-center mt-2.5 flex-wrap gap-1.5">
                                            <div className="flex items-center gap-1.5">
                                                <span className="bg-gray-100 text-gray-500 border border-gray-200 px-1.5 py-0.5 rounded text-[8px] font-black tracking-widest uppercase">
                                                    {a.cat === 'ALGEMEEN' ? (lang === 'nl' ? 'TOPNIEUWS' : 'TOP NEWS') : a.cat}
                                                </span>
                                                <span className="text-[10px] font-black uppercase tracking-wider flex items-center gap-0.5" style={{color: srcColor(a.source)}}>
                                                    {isPri && '‚≠ê'}{a.source}
                                                </span>
                                            </div>
                                            <span className="text-[10px] font-bold text-gray-400 shrink-0">{formatDate(a.pubDate)}</span>
                                        </div>
                                    </div>
                                    {a.img && (
                                        <div className="shrink-0 w-16 h-16 sm:w-20 sm:h-20 bg-gray-100 rounded-lg overflow-hidden shadow-sm flex items-center justify-center">
                                            <img src={a.img} alt="" crossOrigin="anonymous" className="w-full h-full object-cover" loading="lazy"
                                                onError={(e) => {
                                                    const el = e.target;
                                                    const retryCount = parseInt(el.dataset.retry || '0');
                                                    
                                                    if (retryCount === 0) {
                                                        el.dataset.retry = '1';
                                                        el.src = `https://images.weserv.nl/?url=${encodeURIComponent(a.img)}&w=200&h=200&fit=cover`;
                                                    } else if (retryCount === 1) {
                                                        el.dataset.retry = '2';
                                                        try { 
                                                            const domain = new URL(a.link).hostname.replace('www.','');
                                                            el.src = `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
                                                        } catch(err) { 
                                                            el.dataset.retry = '3';
                                                            el.src = 'https://www.google.com/s2/favicons?sz=128'; 
                                                        }
                                                    } else {
                                                        el.parentElement.classList.add('hidden');
                                                    }
                                                }}
                                            />
                                        </div>
                                    )}
                                </a>
                            );
                        })}
                        {displayItems.length < totalFiltered && (
                            <div className="p-3 text-center border-t border-gray-100">
                                <button onClick={()=>setVisibleCount(v=>v+40)} className="px-6 py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded text-[10px] font-bold hover:bg-blue-100 transition">
                                    {lang === 'nl' ? `Meer laden (${totalFiltered - displayItems.length} resterend)` : `Load more (${totalFiltered - displayItems.length} remaining)`}
                                </button>
                            </div>
                        )}
                    </div>
                )}
            </div>
        </div>
    );
}
    
function RadarWidget({ lang }) {
    const [assets, setAssets] = useState(S.load('inv_assets', ['ASML', 'NVDA', 'MSFT', 'GOOGL', 'AMZN', 'META', 'AAPL', 'NVO']));
    const [manage, setManage] = useState(false);
    const [newAsset, setNewAsset] = useState('');
    const [liveData, setLiveData] = useState({});
    const [loading, setLoading] = useState(true);
    const [tab, setTab] = useState('recs'); 
    const [recs, setRecs] = useState([]);
    const [recsLoading, setRecsLoading] = useState(true);

    useEffect(() => {
        const fetchStockData = async () => {
            const cacheKey = 'radar_stocks_v3';
            const sig = JSON.stringify(assets);
            const cached = sessionStorage.getItem(cacheKey);
            if (cached) {
                try {
                    const { t, data, s } = JSON.parse(cached);
                    if (Date.now() - t < 120000 && s === sig) { setLiveData(data); setLoading(false); return; }
                } catch(e) {}
            }
            try {
                const res = await fetchWithRetry('/api/stocks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: assets })
                });
                const data = await res.json();
                if (Array.isArray(data)) {
                    const dataMap = {};
                    data.forEach(item => { if (item && item.name) dataMap[item.name] = item; });
                    setLiveData(dataMap);
                    try { sessionStorage.setItem(cacheKey, JSON.stringify({ t: Date.now(), data: dataMap, s: sig })); } catch(e) {}
                }
            } catch (e) { console.error("Beursfout:", e); }
            finally { setLoading(false); }
        };
        fetchStockData();
        const interval = setInterval(fetchStockData, 120000);
        return () => clearInterval(interval);
    }, [assets]);

    useEffect(() => {
        const fetchRecs = async () => {
            setRecsLoading(true);
            const cacheKey = 'radar_recs_v3';
            const cached = sessionStorage.getItem(cacheKey);
            if (cached) {
                try {
                    const { t, data } = JSON.parse(cached);
                    if (Date.now() - t < 600000) { setRecs(data); setRecsLoading(false); return; }
                } catch(e) {}
            }
            try {
                const res = await fetchWithRetry('/api/stocks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'recommendations' })
                });
                const data = await res.json();
                if (Array.isArray(data)) {
                    setRecs(data);
                    try { sessionStorage.setItem(cacheKey, JSON.stringify({ t: Date.now(), data: data })); } catch(e) {}
                }
            } catch (e) { console.error("Aanbevelingen fout:", e); }
            finally { setRecsLoading(false); }
        };
        fetchRecs();
        const interval = setInterval(fetchRecs, 600000);
        return () => clearInterval(interval);
    }, []);

    const addAsset = () => { if(newAsset && !assets.includes(newAsset.toUpperCase().trim())) { const n = [...assets, newAsset.toUpperCase().trim()]; setAssets(n); S.save('inv_assets', n); setNewAsset(''); } };
    const removeAsset = (a) => { const n = assets.filter(x => x !== a); setAssets(n); S.save('inv_assets', n); };

    const P = ({v}) => <span className={v>=0?'text-green-600':'text-red-600'}>{v>0?'+':''}{(v||0).toFixed(2)}%</span>;

    const getScoreColor = (score) => {
        if (score >= 4.3) return 'bg-green-600 text-white';
        if (score >= 3.7) return 'bg-green-500 text-white';
        if (score >= 3.0) return 'bg-yellow-500 text-white';
        if (score >= 2.0) return 'bg-orange-500 text-white';
        return 'bg-red-500 text-white';
    };

    const getConsensusColor = (c) => {
        if (c === 'Strong Buy') return 'text-green-700 bg-green-50 border-green-200';
        if (c === 'Buy') return 'text-green-600 bg-green-50 border-green-100';
        if (c === 'Hold') return 'text-yellow-700 bg-yellow-50 border-yellow-200';
        if (c === 'Sell') return 'text-red-600 bg-red-50 border-red-100';
        return 'text-red-700 bg-red-50 border-red-200';
    };

    const getYahooUrl = (ticker, name) => {
        let t = ticker || name;
        if (t === 'ASML') t = 'ASML.AS';
        if (t === 'NVO') t = 'NOVOB.CO';
        return `https://finance.yahoo.com/quote/${t}`;
    };

    return (
        <div className="widget h-[450px] flex flex-col">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2 text-gray-500"><Ico.Rad/><h3 className="text-[10px] font-black uppercase tracking-widest">Live Beurs</h3></div>
                <div className="flex gap-2 items-center">
                    {tab === 'watch' && (
                        <button onClick={()=>setManage(!manage)} className={`px-2 py-1 rounded text-[10px] font-bold ${manage ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>{manage ? 'Klaar' : 'Beheer'}</button>
                    )}
                </div>
            </div>

            <div className="flex border-b bg-white shrink-0">
                <button onClick={()=>{setTab('recs');setManage(false);}} className={`tab-btn ${tab==='recs'?'active':''}`}>üìä TOP PICKS</button>
                <button onClick={()=>{setTab('watch');}} className={`tab-btn ${tab==='watch'?'active':''}`}>üëÅ WATCHLIST</button>
            </div>

            {manage && tab === 'watch' && (
                <div className="p-3 bg-gray-100 border-b flex gap-2 shrink-0">
                    <input value={newAsset} onChange={e=>setNewAsset(e.target.value)} onKeyPress={e=>{ if (e.key==='Enter') { addAsset(); } }} className="flex-1 p-1.5 border rounded text-[10px]" placeholder="Ticker (bijv. TSLA, AAPL)" />
                    <button onClick={addAsset} className="bg-blue-600 text-white px-3 rounded font-bold">+</button>
                </div>
            )}

            <div className="p-4 space-y-2 overflow-y-auto flex-1 bg-white hide-scroll">
                {tab === 'recs' && (
                    recsLoading ? (
                        <div className="text-center text-xs text-blue-500 animate-pulse mt-10">Analyst aanbevelingen laden...</div>
                    ) : recs.length === 0 ? (
                        <div className="text-center text-[10px] text-gray-400 mt-10">Geen aanbevelingen gevonden.</div>
                    ) : (
                        <>
                            <div className="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-2 text-center">
                                {recs.length} aandelen geanalyseerd ¬∑ gesorteerd op analyst score
                            </div>
                            {recs.map((r, i) => (
                                <div key={r.name} onClick={() => window.open(getYahooUrl(r.ticker, r.name), '_blank')} className={`p-3 border rounded-lg shadow-sm transition cursor-pointer hover:shadow-md ${r.tr.d >= 0 ? 'bg-green-50/50 border-green-100 hover:border-green-300' : 'bg-red-50/50 border-red-100 hover:border-red-300'}`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex items-center gap-2">
                                            <span className={`text-[9px] font-black px-1.5 py-0.5 rounded ${getScoreColor(r.score)}`}>
                                                {r.score.toFixed(1)}
                                            </span>
                                            <span className="font-black text-sm text-gray-900">{r.name}</span>
                                        </div>
                                        <div className="text-right">
                                            <span className="text-[10px] font-mono font-bold block">${r.price.toFixed(2)}</span>
                                            <span className={`text-[9px] font-bold ${r.tr.d >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                {r.tr.d >= 0 ? '+' : ''}{r.tr.d.toFixed(2)}%
                                            </span>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className={`text-[9px] font-black px-2 py-0.5 rounded border ${getConsensusColor(r.consensus)}`}>
                                            {r.consensus}
                                        </span>
                                        <div className="flex items-center gap-1">
                                            <div className="flex h-2.5 w-20 rounded overflow-hidden">
                                                {r.detail.strongBuy > 0 && <div className="bg-green-700" style={{width: `${(r.detail.strongBuy/r.analysts)*100}%`}}></div>}
                                                {r.detail.buy > 0 && <div className="bg-green-400" style={{width: `${(r.detail.buy/r.analysts)*100}%`}}></div>}
                                                {r.detail.hold > 0 && <div className="bg-yellow-400" style={{width: `${(r.detail.hold/r.analysts)*100}%`}}></div>}
                                                {r.detail.sell > 0 && <div className="bg-orange-400" style={{width: `${(r.detail.sell/r.analysts)*100}%`}}></div>}
                                                {r.detail.strongSell > 0 && <div className="bg-red-500" style={{width: `${(r.detail.strongSell/r.analysts)*100}%`}}></div>}
                                            </div>
                                            <span className="text-[8px] font-bold text-gray-400">{r.buyPct}% buy ¬∑ {r.analysts} analysts</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </>
                    )
                )}

                {tab === 'watch' && (
                    loading && Object.keys(liveData).length === 0 ? (
                        <div className="text-center text-xs text-blue-500 animate-pulse mt-10">Koersen laden...</div>
                    ) : assets.map((a) => {
                        const data = liveData[a];
                        if (!data) return (
                            <div key={a} className="p-3 border rounded-lg bg-gray-50 flex justify-between items-center">
                                <span className="font-bold text-sm text-gray-400">{a}</span>
                                {manage ? <button onClick={(e)=>{e.stopPropagation(); removeAsset(a);}} className="text-red-500 font-bold text-lg">&times;</button> : 
                                <span className="text-[9px] text-gray-400">Niet gevonden</span>}
                            </div>
                        );
                        const isPos = data.tr.d >= 0;
                        return (
                            <div key={a} onClick={() => { if (!manage) { window.open(getYahooUrl(data.ticker, data.name), '_blank'); } }} className={`p-3 border rounded-lg shadow-sm transition ${!manage ? 'cursor-pointer hover:shadow-md' : ''} ${isPos ? 'bg-green-50 border-green-200 hover:border-green-300' : 'bg-red-50 border-red-200 hover:border-red-300'}`}>
                                <div className="flex justify-between items-start mb-1">
                                    <span className="font-black text-sm text-gray-900">{a}</span>
                                    {manage ? <button onClick={(e)=>{e.stopPropagation(); removeAsset(a);}} className="text-red-500 font-bold text-lg">&times;</button> : 
                                    <span className="text-[10px] font-mono font-bold">{data.currency} {data.price.toFixed(2)}</span>}
                                </div>
                                <div className="flex justify-between items-center text-[9px] font-black uppercase tracking-tighter mt-2 border-t border-black/5 pt-2">
                                    <div>1D: <P v={data.tr.d}/></div>
                                    <div>1W: <P v={data.tr.w}/></div>
                                    <div>1M: <P v={data.tr.m}/></div>
                                    <div>1J: <P v={data.tr.y}/></div>
                                </div>
                            </div>
                        );
                    })
                )}
            </div>
        </div>
    );
}

function SportsWidget({ lang }) {
    const [tab, setTab] = useState('lst');
    const [search, setSearch] = useState('');
    const [golfTour, setGolfTour] = useState('PGA');
    const [sportsLoading, setSportsLoading] = useState(true);

    const [eF1C, setEF1C] = useState(false);
    const [eF1S, setEF1S] = useState(false);
    const [eF1L, setEF1L] = useState(false);
    
    const [eGC, setEGC] = useState(false);
    const [eGS, setEGS] = useState(false);
    const [eGL, setEGL] = useState(false);

    const FLAGS = { dutch:'üá≥üá±',british:'üá¨üáß',german:'üá©üá™',spanish:'üá™üá∏',mexican:'üá≤üáΩ',australian:'üá¶üá∫',french:'üá´üá∑',canadian:'üá®üá¶',monegasque:'üá≤üá®',thai:'üáπüá≠',japanese:'üáØüáµ',chinese:'üá®üá≥',finnish:'üá´üáÆ',danish:'üá©üá∞',american:'üá∫üá∏',italian:'üáÆüáπ',polish:'üáµüá±',brazilian:'üáßüá∑',norwegian:'üá≥üá¥',swedish:'üá∏üá™',swiss:'üá®üá≠','new zealander':'üá≥üáø',argentine:'üá¶üá∑',korean:'üá∞üá∑',irish:'üáÆüá™','south african':'üáøüá¶',belgian:'üáßüá™',austrian:'üá¶üáπ',colombian:'üá®üá¥',portuguese:'üáµüáπ',indian:'üáÆüá≥' };
    const getFlag = (nat) => FLAGS[(nat||'').toLowerCase()] || 'üèÅ';

    const fmtDate = (iso) => { const d = new Date(iso); const m = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return `${String(d.getDate()).padStart(2,'0')} ${m[d.getMonth()]}`; };
    const fmtTimeNL = (iso) => { const d = new Date(iso); return d.toLocaleTimeString('nl-NL', { hour:'2-digit', minute:'2-digit', timeZone:'Europe/Amsterdam' }); };

    const FALLBACK_F1 = { c: [], s: [], lst: { title: 'Geen data', res: [] } };
    const FALLBACK_GOLF = { c: [], s: [], lst: { title: 'Geen data', res: [] } };

    const [f1Data, setF1Data] = useState(FALLBACK_F1);
    const [golfPga, setGolfPga] = useState(FALLBACK_GOLF);
    const [golfDp, setGolfDp] = useState(FALLBACK_GOLF);

    useEffect(() => {
        const CACHE_KEY = 'sports_f1_v3';
        const CACHE_TTL = 1800000;
        const currentYear = new Date().getFullYear();

        const fetchF1 = async () => {
            const cached = sessionStorage.getItem(CACHE_KEY);
            if (cached) {
                try { const { t, d } = JSON.parse(cached); if (Date.now() - t < CACHE_TTL) { setF1Data(d); setSportsLoading(false); return; } } catch(e) {}
            }
            try {
                const [calRes, stdRes, lstRes] = await Promise.all([
                    fetchWithRetry(`https://api.jolpi.ca/ergast/f1/${currentYear}/races/`, { headers: { 'Accept': 'application/json' } }),
                    fetchWithRetry(`https://api.jolpi.ca/ergast/f1/${currentYear}/driverStandings/`, { headers: { 'Accept': 'application/json' } }),
                    fetchWithRetry(`https://api.jolpi.ca/ergast/f1/${currentYear}/results/last/`, { headers: { 'Accept': 'application/json' } }).catch(() => ({ ok: false }))
                ]);

                const result = { c: [], s: [], lst: { title: 'Geen data', res: [] } };

                if (calRes.ok) {
                    const calJson = await calRes.json();
                    const races = calJson?.MRData?.RaceTable?.Races || [];
                    const now = new Date();
                    result.c = races
                        .filter(r => new Date(r.date + 'T' + (r.time || '14:00:00Z')) >= new Date(now.getTime() - 86400000))
                        .slice(0, 10)
                        .map(r => ({
                            r: `GP ${r.raceName.replace(' Grand Prix', '')}`,
                            d: fmtDate(r.date),
                            t: fmtTimeNL(r.date + 'T' + (r.time || '14:00:00Z'))
                        }));
                }

                if (stdRes.ok) {
                    const stdJson = await stdRes.json();
                    const drivers = stdJson?.MRData?.StandingsTable?.StandingsLists?.[0]?.DriverStandings || [];
                    result.s = drivers.slice(0, 10).map(d => ({
                        p: parseInt(d.position),
                        n: d.Driver.familyName,
                        fl: getFlag(d.Driver.nationality),
                        pt: parseInt(d.points)
                    }));
                }

                if (lstRes.ok) {
                    const lstJson = await lstRes.json();
                    const race = lstJson?.MRData?.RaceTable?.Races?.[0];
                    if (race) {
                        result.lst = {
                            title: `GP ${race.raceName.replace(' Grand Prix', '')}`,
                            res: (race.Results || []).slice(0, 10).map(r => ({
                                p: parseInt(r.position),
                                n: r.Driver.familyName,
                                time: r.position === '1' ? (r.Time?.time || r.status || '-') : (r.Time?.time ? `+${r.Time.time.replace(/.*\+/, '')}` : r.status || 'DNF')
                            }))
                        };
                    }
                }

                setF1Data(result);
                try { sessionStorage.setItem(CACHE_KEY, JSON.stringify({ t: Date.now(), d: result })); } catch(e) {}
            } catch (e) {
                console.error('F1 API fout:', e);
                const cached = sessionStorage.getItem(CACHE_KEY);
                if (cached) { try { setF1Data(JSON.parse(cached).d); } catch(e) {} }
            }
            setSportsLoading(false);
        };
        fetchF1();
        const interval = setInterval(fetchF1, CACHE_TTL);
        return () => clearInterval(interval);
    }, []);

    useEffect(() => {
        const CACHE_TTL = 900000;

        const fetchGolf = async (tour, cacheKey) => {
            const cached = sessionStorage.getItem(cacheKey);
            if (cached) {
                try { const { t, d } = JSON.parse(cached); if (Date.now() - t < CACHE_TTL) return d; } catch(e) {}
            }
            try {
                const res = await fetchWithRetry('/api/golf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tour: tour })
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                const result = { c: [], s: [], lst: { title: 'Geen data', res: [] } };

                const events = data?.events || [];
                const now = new Date();
                result.c = events
                    .filter(e => new Date(e.date) >= new Date(now.getTime() - 86400000))
                    .slice(0, 10)
                    .map(e => ({
                        r: e.shortName || e.name || '',
                        d: fmtDate(e.date),
                        t: fmtTimeNL(e.date)
                    }));

                const completed = events.filter(e => {
                    const status = e.status?.type?.state || e.competitions?.[0]?.status?.type?.state || '';
                    return status === 'post' || new Date(e.date) < now;
                });
                const lastEvent = completed[completed.length - 1] || events[0];
                if (lastEvent) {
                    const competitors = lastEvent.competitions?.[0]?.competitors || [];
                    result.lst = {
                        title: lastEvent.shortName || lastEvent.name || '',
                        res: competitors.slice(0, 10).map((c, i) => ({
                            p: parseInt(c.status?.position?.id || c.order || i + 1),
                            n: c.athlete?.shortName?.split('. ').pop() || c.athlete?.lastName || '?',
                            time: c.linescores?.[0]?.displayValue || c.status?.displayValue || c.score?.displayValue || '-'
                        }))
                    };
                }

                if (data?.rankings?.length > 0) {
                    result.s = data.rankings.slice(0, 10).map((r, i) => ({
                        p: i + 1,
                        n: r.athlete?.shortName?.split('. ').pop() || r.athlete?.lastName || '?',
                        fl: getFlag(r.athlete?.flag?.alt || ''),
                        pt: r.stat?.displayValue || r.points || '-'
                    }));
                } else if (lastEvent?.competitions?.[0]?.competitors) {
                    result.s = lastEvent.competitions[0].competitors.slice(0, 10).map((c, i) => ({
                        p: parseInt(c.status?.position?.id || i + 1),
                        n: c.athlete?.shortName?.split('. ').pop() || c.athlete?.lastName || '?',
                        fl: getFlag(c.athlete?.flag?.alt || ''),
                        pt: c.score?.displayValue || c.statistics?.[0]?.displayValue || '-'
                    }));
                }

                try { sessionStorage.setItem(cacheKey, JSON.stringify({ t: Date.now(), d: result })); } catch(e) {}
                return result;
            } catch (e) {
                console.error(`Golf ${tour} API fout:`, e);
                const cached = sessionStorage.getItem(cacheKey);
                if (cached) { try { return JSON.parse(cached).d; } catch(e) {} }
                return FALLBACK_GOLF;
            }
        };

        const loadGolf = async () => {
            const [pga, dp] = await Promise.all([
                fetchGolf('pga', 'sports_golf_pga_v3'),
                fetchGolf('eur', 'sports_golf_dp_v3')
            ]);
            setGolfPga(pga);
            setGolfDp(dp);
        };
        loadGolf();
        const interval = setInterval(loadGolf, CACHE_TTL);
        return () => clearInterval(interval);
    }, []);

    const gData = golfTour === 'PGA' ? golfPga : golfDp;
    const match = (s) => s.toLowerCase().includes(search.toLowerCase());

    const fF1c = f1Data.c.filter(x => !search || match(x.r));
    const fF1s = f1Data.s.filter(x => !search || match(x.n));
    const fF1lstRes = f1Data.lst.res.filter(x => !search || match(x.n));
    const f1LstMatch = fF1lstRes.length > 0 || match(f1Data.lst.title); 

    const fGc = gData.c.filter(x => !search || match(x.r));
    const fGs = gData.s.filter(x => !search || match(x.n));
    const fGlstRes = gData.lst.res.filter(x => !search || match(x.n));
    const gLstMatch = fGlstRes.length > 0 || match(gData.lst.title);

    const MoreBtn = ({ e, setE, t1, e1 }) => (
        <button onClick={() => setE(!e)} className="w-full mt-2 bg-gray-50 hover:bg-gray-100 border text-gray-500 text-[9px] font-bold py-1.5 rounded uppercase transition shadow-sm">
            {e ? (lang==='nl'?'Minder tonen':'Show less') : (lang==='nl'?t1:e1)}
        </button>
    );

    return (
        <div className="widget h-[450px]">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2 text-gray-500">
                    <Ico.Trp/><h3 className="text-[10px] font-black uppercase tracking-widest">Sport</h3>
                    {sportsLoading && <span className="text-[9px] text-blue-500 animate-pulse font-bold">‚è≥ live laden...</span>}
                </div>
                <input type="text" placeholder={lang==='nl'?"Zoek (bijv. Verstappen)":"Search..."} value={search} onChange={e=>setSearch(e.target.value)} className="w-1/2 px-2 py-1 text-[10px] border rounded outline-none focus:border-blue-500 shadow-sm" />
            </div>
            <div className="flex border-b bg-white shrink-0">
                {[ {id:'cal', l:T[lang].cal}, {id:'lst', l:T[lang].lst}, {id:'std', l:T[lang].std} ].map(t => <button key={t.id} onClick={() => setTab(t.id)} className={`tab-btn ${tab === t.id ? 'active' : ''}`}>{t.l}</button>)}
            </div>
            <div className="p-4 flex-1 overflow-y-auto space-y-6 bg-white hide-scroll">
                
                {((tab === 'cal' && fF1c.length>0) || (tab === 'std' && fF1s.length>0) || (tab === 'lst' && f1LstMatch)) && (
                <div>
                    <div className="flex items-center gap-2 mb-2 border-b border-gray-100 pb-1"><Ico.F1/><span className="text-[10px] font-black uppercase text-[#0073b1]">F1</span></div>
                    <div className="space-y-1">
                        {tab === 'cal' && fF1c.slice(0, eF1C ? 10 : 3).map(r => <div key={r.r} className="flex justify-between items-center text-xs p-2 bg-gray-50 rounded border"><div className="flex flex-col"><span className="font-bold">{r.r}</span><span className="text-[9px] font-black text-gray-400 mt-0.5">{r.d}</span></div><span className="font-mono text-blue-600 font-bold">{r.t}</span></div>)}
                        {tab === 'cal' && fF1c.length > 3 && <MoreBtn e={eF1C} setE={setEF1C} t1="Toon 10 events" e1="Show 10 events" />}
                        
                        {tab === 'std' && fF1s.slice(0, eF1S ? 10 : 3).map((s,i) => <div key={s.n} className="flex justify-between items-center text-xs p-2 border-b"><div className="flex gap-3 items-center"><span className="font-black w-4">{s.p===1?'ü•á':s.p===2?'ü•à':s.p===3?'ü•â':s.p}</span><span className="text-base">{s.fl}</span><span className="font-bold">{s.n.toUpperCase()}</span></div><span className="bg-gray-800 text-white px-2 py-0.5 rounded font-mono font-bold text-[9px]">{s.pt}</span></div>)}
                        {tab === 'std' && fF1s.length > 3 && <MoreBtn e={eF1S} setE={setEF1S} t1="Volledige stand" e1="Full standings" />}

                        {tab === 'lst' && f1LstMatch && (
                            <div className="flex flex-col gap-1">
                                <div className="bg-blue-50 text-blue-800 font-bold text-center py-1.5 rounded uppercase text-[9px] mb-1">{f1Data.lst.title}</div>
                                {fF1lstRes.slice(0, eF1L ? 10 : 3).map((r, i) => (
                                    <div key={r.n} className={`flex justify-between items-center text-xs p-2 border-b ${r.p===1?'bg-yellow-50 border-yellow-300 rounded':''}`}>
                                        <div className="flex gap-3 items-center">
                                            <span className="font-black w-4">{r.p===1?'ü•á':r.p===2?'ü•à':r.p===3?'ü•â':r.p}</span>
                                            <span className="font-bold">{r.n.toUpperCase()}</span>
                                        </div>
                                        <span className="text-gray-500 font-mono text-[9px]">{r.time}</span>
                                    </div>
                                ))}
                                {fF1lstRes.length > 3 && <MoreBtn e={eF1L} setE={setEF1L} t1="Volledige uitslag" e1="Full results" />}
                            </div>
                        )}
                    </div>
                </div>
                )}

                {((tab === 'cal' && fGc.length>0) || (tab === 'std' && fGs.length>0) || (tab === 'lst' && gLstMatch)) && (
                <div>
                    <div className="flex items-center justify-between mb-2 border-b border-gray-100 pb-1">
                        <div className="flex items-center gap-2"><Ico.Glf/><span className="text-[10px] font-black uppercase text-[#0073b1]">GOLF</span></div>
                        <div className="flex gap-1 bg-gray-100 p-0.5 rounded">
                            <button onClick={()=>setGolfTour('PGA')} className={`px-2 py-0.5 text-[8px] font-bold rounded uppercase ${golfTour==='PGA'?'bg-white shadow-sm text-blue-700':'text-gray-500'}`}>PGA</button>
                            <button onClick={()=>setGolfTour('DP')} className={`px-2 py-0.5 text-[8px] font-bold rounded uppercase ${golfTour==='DP'?'bg-white shadow-sm text-blue-700':'text-gray-500'}`}>DP</button>
                        </div>
                    </div>
                    <div className="space-y-1">
                        {tab === 'cal' && fGc.slice(0, eGC ? 10 : 3).map(r => <div key={r.r} className="flex justify-between items-center text-xs p-2 bg-gray-50 rounded border"><div className="flex flex-col"><span className="font-bold">{r.r}</span><span className="text-[9px] font-black text-gray-400 mt-0.5">{r.d}</span></div><span className="font-mono text-blue-600 font-bold">{r.t}</span></div>)}
                        {tab === 'cal' && fGc.length > 3 && <MoreBtn e={eGC} setE={setEGC} t1="Toon 10 events" e1="Show 10 events" />}
                        
                        {tab === 'std' && fGs.slice(0, eGS ? 10 : 3).map((s,i) => <div key={s.n} className="flex justify-between items-center text-xs p-2 border-b"><div className="flex gap-3 items-center"><span className="font-black w-4">{s.p===1?'ü•á':s.p===2?'ü•à':s.p===3?'ü•â':s.p}</span><span className="text-base">{s.fl}</span><span className="font-bold">{s.n.toUpperCase()}</span></div><span className="bg-gray-800 text-white px-2 py-0.5 rounded font-mono font-bold text-[9px]">{s.pt}</span></div>)}
                        {tab === 'std' && fGs.length > 3 && <MoreBtn e={eGS} setE={setEGS} t1="Volledige stand" e1="Full standings" />}

                        {tab === 'lst' && gLstMatch && (
                            <div className="flex flex-col gap-1">
                                <div className="bg-green-50 text-green-800 font-bold text-center py-1.5 rounded uppercase text-[9px] mb-1">{gData.lst.title}</div>
                                {fGlstRes.slice(0, eGL ? 10 : 3).map((r, i) => (
                                    <div key={r.n} className={`flex justify-between items-center text-xs p-2 border-b ${r.p===1?'bg-green-100 border-green-300 rounded':''}`}>
                                        <div className="flex gap-3 items-center">
                                            <span className="font-black w-4">{r.p===1?'ü•á':r.p===2?'ü•à':r.p===3?'ü•â':r.p}</span>
                                            <span className="font-bold">{r.n.toUpperCase()}</span>
                                        </div>
                                        <span className="text-gray-500 font-mono text-[9px]">{r.time}</span>
                                    </div>
                                ))}
                                {fGlstRes.length > 3 && <MoreBtn e={eGL} setE={setEGL} t1="Volledige uitslag" e1="Full results" />}
                            </div>
                        )}
                    </div>
                </div>
                )}
                
                {search && fF1c.length===0 && fF1s.length===0 && !f1LstMatch && fGc.length===0 && fGs.length===0 && !gLstMatch && (
                    <div className="text-center text-gray-400 text-[10px] font-bold py-10 uppercase">Geen resultaten voor '{search}'</div>
                )}
            </div>
        </div>
    );
}

function SparkWidget({ lang }) {
    const [tab, setTab] = useState('dagvraag');
    const [dailyData, setDailyData] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [apiError, setApiError] = useState('');
    const [iqPick, setIqPick] = useState(null);

    const todayStr = new Date().toLocaleDateString('nl-NL');

    const UI = {
        nl: {
            title: 'DENKTANK', btnNew: 'Nieuw', tReflect: 'DagVraag', tIq: 'IQ', tFact: 'Feiten',
            loading: 'Data ophalen...', subReflect: 'Reflectie', subFact: 'Wist je dat?',
            correct: 'üéâ Correct!', wrong: '‚ùå Fout!', genHover: 'Genereer direct een nieuwe set'
        },
        en: {
            title: 'THINK TANK', btnNew: 'New', tReflect: 'Daily', tIq: 'IQ', tFact: 'Facts',
            loading: 'Fetching data...', subReflect: 'Reflection', subFact: 'Did you know?',
            correct: 'üéâ Correct!', wrong: '‚ùå Incorrect!', genHover: 'Generate a new set immediately'
        }
    };
    const t = UI[lang] || UI.nl;

    const fetchDailySpark = async (forceNew = false) => {
        setIsLoading(true); setApiError('');
        const cacheKey = `spark_daily_v6_${lang}`;

        if (!forceNew) {
            const cached = S.load(cacheKey, null);
            if (cached && cached.date === todayStr && cached.data) {
                setDailyData(cached.data); setIsLoading(false); return;
            }
        }

        const groqKey = S.load('api_keys_dyn', []).find(a => a.name.toLowerCase().includes('groq'))?.val;
        if (!groqKey) {
            setApiError('No Groq API key.'); setDailyData(getFallbackData(lang)); setIsLoading(false); return;
        }

        try {
            let iQ = "What is 15% of 120?", iC = "18", iI = ["12", "15", "20"];
            try {
                const resI = await fetch('https://opentdb.com/api.php?amount=1&category=19&type=multiple');
                const datI = await resI.json();
                if (datI.results && datI.results.length > 0) {
                    const dec = (str) => { const txt = document.createElement("textarea"); txt.innerHTML = str; return txt.value; };
                    iQ = dec(datI.results[0].question); iC = dec(datI.results[0].correct_answer); iI = datI.results[0].incorrect_answers.map(dec);
                }
            } catch(e) {}

            let fText = "Bananas grow pointing upwards towards the sun.";
            try {
                const resF = await fetch('https://uselessfacts.jsph.pl/api/v2/facts/random');
                const datF = await resF.json(); fText = datF.text;
            } catch(e) {}

            const targetLang = lang === 'nl' ? 'Nederlands' : 'English';
            const factPrefix = lang === 'nl' ? 'Wist je dat ' : 'Did you know ';
            
            const prompt = `Je bent de strikte data-vertaler voor een dashboard. Doeltaal: ${targetLang}.
            TAAK 1: Bedenk een prikkelende, diepgaande persoonlijke reflectievraag.
            TAAK 2: Vertaal dit feit naar het ${targetLang}: "${fText}". Begin de zin met EXACT "${factPrefix}".
            TAAK 3: Beoordeel deze wiskundige IQ-vraag: "${iQ}". Het antwoord is "${iC}", de foute opties zijn "${iI.join(', ')}".
            BELANGRIJKE REGELS VOOR TAAK 3:
            - Als de vraag imperiale eenheden bevat, NEGEER DE VRAAG DAN VOLLEDIG. Verzin in de plaats daarvan ZELF een universele logische getallenreeks.
            - Zorg dat de vraag in vlekkeloos en natuurlijk ${targetLang} is geschreven. Gebruik metrisch systeem.
            - Maak een array van 4 opties, hussel ze, en geef de index (0-3) van de juiste. 
            - Schrijf 1 heldere zin wiskundige uitleg in het ${targetLang}.
            LET OP: Gebruik NOOIT dubbele aanhalingstekens binnenin je zinnen (gebruik enkele ').
            Geef UITSLUITEND dit JSON object terug:
            { "dagvraag": "...", "feit": "...", "iq": {"q": "...", "opts": ["...","...","...","..."], "a": 0, "uitleg": "..."} }`;

            const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST', headers: { 'Authorization': `Bearer ${groqKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: 'llama-3.3-70b-versatile', messages: [{ role: 'user', content: prompt }], temperature: 0.2, max_tokens: 600 })
            });
            
            const data = await res.json();
            if (data.choices && data.choices[0]) {
                const content = data.choices[0].message.content;
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    setDailyData(parsed);
                    if (!forceNew) S.save(cacheKey, { date: todayStr, data: parsed });
                    setApiError('');
                } else { throw new Error("Ongeldig JSON formaat"); }
            }
        } catch (e) {
            console.error("DenkTank AI Error:", e);
            if (!dailyData) setDailyData(getFallbackData(lang));
            setApiError('Fallback mode.');
        }
        setIsLoading(false); setIqPick(null);
    };

    useEffect(() => { fetchDailySpark(); }, [todayStr, lang]);

    const getFallbackData = (currentLang) => {
        if (currentLang === 'en') {
            return {
                dagvraag: "What small decision has had a massive impact on your life?",
                iq: { q: "What number follows in this sequence: 2, 6, 12, 20, 30, ...?", opts: ["38", "40", "42", "44"], a: 2, uitleg: "The difference increases by 2 each time. The next step is 30 + 12 = 42." },
                feit: "Did you know that octopuses have three hearts and their blood is blue?"
            };
        }
        return {
            dagvraag: "Welke kleine beslissing heeft ooit een grote impact op je leven gehad?",
            iq: { q: "Welk getal volgt in deze reeks: 2, 6, 12, 20, 30, ...?", opts: ["38", "40", "42", "44"], a: 2, uitleg: "De toename stijgt steeds met 2 (+4, +6, +8). De volgende stap is dus 30 + 12 = 42." },
            feit: "Wist je dat octopussen drie harten hebben en dat hun bloed blauw is?"
        };
    };

    const renderQuiz = (quizData, pickState, setPickState) => (
        <div className="flex flex-col w-full">
            <h4 className="text-[13px] md:text-sm font-bold text-center text-gray-800 mb-6 leading-snug">{quizData?.q}</h4>
            <div className="grid grid-cols-2 gap-2 w-full">
                {quizData?.opts.map((opt, i) => {
                    let btnClass = "bg-white border border-gray-200 text-gray-700 hover:border-[#0073b1] hover:bg-blue-50";
                    if (pickState !== null) {
                        if (i === quizData.a) btnClass = "bg-green-50 border border-green-400 text-green-800 font-bold shadow-sm";
                        else if (i === pickState) btnClass = "bg-red-50 border border-red-300 text-red-800";
                        else btnClass = "bg-gray-50 border border-gray-100 text-gray-400 opacity-50";
                    }
                    return (
                        <button key={i} onClick={() => setPickState(i)} disabled={pickState !== null} className={`px-3 py-2.5 rounded text-[11px] md:text-xs transition-all duration-200 text-center ${btnClass}`}>
                            {opt}
                        </button>
                    );
                })}
            </div>
            {pickState !== null && (
                <div className={`mt-4 p-3 rounded border text-xs leading-relaxed animate-fade-in ${pickState === quizData.a ? 'bg-green-50/50 border-green-100 text-green-900' : 'bg-red-50/50 border-red-100 text-red-900'}`}>
                    <span className={`font-black uppercase tracking-wider block mb-1 ${pickState === quizData.a ? 'text-green-600' : 'text-red-600'}`}>{pickState === quizData.a ? t.correct : t.wrong}</span>
                    <span className="text-gray-700">{quizData.uitleg}</span>
                </div>
            )}
        </div>
    );

    return (
        <div className="widget h-[450px] flex flex-col bg-white">
            <div className="p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2 text-gray-600 font-black tracking-widest text-[11px] uppercase">
                    <span className="text-lg leading-none grayscale opacity-80">üí°</span> {t.title}
                </div>
                <div className="flex items-center gap-2">
                    {apiError && <span className="text-[8px] text-red-500 font-bold bg-white px-2 py-0.5 rounded border border-red-100 hidden sm:inline-block">{apiError}</span>}
                    <button onClick={() => fetchDailySpark(true)} disabled={isLoading} className="px-2.5 py-1.5 bg-white border border-gray-200 text-[#0073b1] hover:bg-[#0073b1] hover:text-white hover:border-[#0073b1] text-[9px] font-bold uppercase rounded transition shadow-sm flex items-center gap-1 disabled:opacity-50" title={t.genHover}>
                        <span className={isLoading ? "animate-spin inline-block" : ""}>‚Üª</span> {t.btnNew}
                    </button>
                </div>
            </div>
            <div className="flex border-b border-gray-200 bg-white shrink-0">
                <button onClick={() => setTab('dagvraag')} className={`tab-btn ${tab === 'dagvraag' ? 'active' : ''}`}>{t.tReflect}</button>
                <button onClick={() => setTab('iq')} className={`tab-btn ${tab === 'iq' ? 'active' : ''}`}>{t.tIq}</button>
                <button onClick={() => setTab('feiten')} className={`tab-btn ${tab === 'feiten' ? 'active' : ''}`}>{t.tFact}</button>
            </div>
            <div className="flex-1 overflow-y-auto p-5 bg-white hide-scroll relative flex flex-col">
                {isLoading ? (
                    <div className="flex flex-col items-center justify-center h-full space-y-4 my-auto">
                        <div className="w-8 h-8 border-4 border-gray-100 border-t-[#0073b1] rounded-full animate-spin"></div>
                        <span className="text-xs font-bold text-gray-400 uppercase tracking-widest animate-pulse">{t.loading}</span>
                    </div>
                ) : (
                    <>
                        {tab === 'dagvraag' && (
                            <div className="flex flex-col flex-1 items-center justify-center text-center px-2">
                                <h4 className="text-[10px] font-black text-[#0073b1] uppercase tracking-widest mb-6">{t.subReflect}</h4>
                                <p className="text-lg md:text-xl font-bold text-gray-800 leading-snug">"{dailyData?.dagvraag}"</p>
                            </div>
                        )}
                        {tab === 'iq' && (
                            <div className="flex flex-col flex-1 justify-center items-center w-full max-w-md mx-auto">
                                {renderQuiz(dailyData?.iq, iqPick, setIqPick)}
                            </div>
                        )}
                        {tab === 'feiten' && (
                            <div className="flex flex-col flex-1 items-center justify-center text-center px-4">
                                <h4 className="text-[10px] font-black text-[#0073b1] uppercase tracking-widest mb-6">{t.subFact}</h4>
                                <p className="text-sm md:text-base font-bold text-gray-800 leading-relaxed">{dailyData?.feit}</p>
                            </div>
                        )}
                    </>
                )}
            </div>
        </div>
    );
}

function Settings({ isOpen, onClose, layout, setLayout }) {
    const [bvKeys, setBvKeys] = useState(S.load('bitvavo_keys', {pub: '', sec: ''}));
    const [apis, setApis] = useState(S.load('api_keys_dyn', [{name: 'Groq', val: ''}]));
    const [icals, setIcals] = useState(S.load('icals_dyn', [{name: 'Ryan', val: ''}, {name: 'Yaron', val: ''}, {name: 'Michael', val: ''}, {name: 'Fam-Sch', val: ''}]));
    const [aiUrl, setAiUrl] = useState(S.load('ai_chat_url', ''));
    const [dragIdx, setDragIdx] = useState(null);
    const [isSaving, setIsSaving] = useState(false);

    const handleDragStart = (e, idx) => { setDragIdx(idx); e.dataTransfer.effectAllowed = "move"; };
    const handleDrop = (e, idx) => { e.preventDefault(); if (dragIdx === null || dragIdx === idx) return; const n = [...layout]; const item = n.splice(dragIdx, 1)[0]; n.splice(idx, 0, item); setLayout(n); S.save('layout_v9', n); setDragIdx(null); };
    const move = (idx, dir) => { if((dir===-1 && idx===0) || (dir===1 && idx===layout.length-1)) return; const n = [...layout]; const temp = n[idx]; n[idx] = n[idx+dir]; n[idx+dir] = temp; setLayout(n); S.save('layout_v9', n); };

    const saveAll = async () => { 
        setIsSaving(true);
        S.save('bitvavo_keys', bvKeys); 
        S.save('api_keys_dyn', apis); 
        S.save('icals_dyn', icals); 
        S.save('ai_chat_url', aiUrl); 
        S.save('layout_v9', layout);
        
        const cloudSettings = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('d_')) { cloudSettings[key.substring(2)] = JSON.parse(localStorage.getItem(key)); }
        }

        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: ALLOWED_EMAIL, settings: cloudSettings })
            });
            const dbData = await res.json();
            if (!res.ok || dbData.error) { alert("FOUT BIJ OPSLAAN: " + (dbData.error || res.statusText)); setIsSaving(false); return; }
        } catch(e) { alert("NETWERK FOUT BIJ OPSLAAN: " + e.message); setIsSaving(false); return; }

        setIsSaving(false); onClose(); window.location.reload(); 
    };

    return (
        <div className={`settings-panel p-6 md:p-8 flex flex-col ${isOpen ? 'open' : ''}`}>
            <div className="flex justify-between items-center mb-8 border-b pb-4"><h2 className="text-2xl font-black uppercase">Configuratie</h2><button onClick={onClose} className="text-3xl text-gray-400 hover:text-gray-800 transition">&times;</button></div>
            <div className="space-y-8 flex-1">
                <section>
                    <h3 className="text-[10px] font-black text-blue-600 uppercase mb-4">Dashboard Indeling (Drag & Drop)</h3>
                    <div className="space-y-1">
                        {layout.map((w, i) => (
                            <div key={w} draggable onDragStart={(e)=>handleDragStart(e, i)} onDragOver={(e)=>e.preventDefault()} onDrop={(e)=>handleDrop(e, i)} className="flex justify-between items-center bg-white p-3 border rounded shadow-sm cursor-move hover:border-blue-400 transition">
                                <div className="flex items-center gap-3"><Ico.Drag /><span className="text-xs font-bold uppercase">{w}</span></div>
                                <div className="flex gap-2"><button onClick={()=>move(i, -1)} className="text-gray-400 hover:text-blue-600"><Ico.Up/></button><button onClick={()=>move(i, 1)} className="text-gray-400 hover:text-blue-600"><Ico.Dn/></button></div>
                            </div>
                        ))}
                    </div>
                </section>

                <section>
                    <h3 className="text-[10px] font-black text-blue-600 uppercase mb-4">Bitvavo Koppeling (Live)</h3>
                    <div className="space-y-2">
                        <input type="text" placeholder="Bitvavo API Key" value={bvKeys.pub} onChange={e=>setBvKeys({...bvKeys, pub: e.target.value})} className="w-full p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                        <input type="password" placeholder="Bitvavo API Secret" value={bvKeys.sec} onChange={e=>setBvKeys({...bvKeys, sec: e.target.value})} className="w-full p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                    </div>
                </section>

                <section>
                    <h3 className="text-[10px] font-black text-blue-600 uppercase mb-4">Outlook Koppeling</h3>
                    <input type="text" placeholder="Microsoft Application (Client) ID" defaultValue={S.load('ms_client_id', '')} onChange={e => S.save('ms_client_id', e.target.value)} className="w-full p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                    <p className="text-[8px] text-gray-400 mt-1">Azure Portal ‚Üí App registrations ‚Üí Application (client) ID</p>
                </section>

                <section>
                    <h3 className="text-[10px] font-black text-blue-600 uppercase mb-4">Gmail Koppeling</h3>
                    <input type="text" placeholder="Google OAuth Client ID" defaultValue={S.load('gmail_client_id', '')} onChange={e => S.save('gmail_client_id', e.target.value)} className="w-full p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                    <p className="text-[8px] text-gray-400 mt-1">Google Cloud Console ‚Üí Credentials ‚Üí OAuth 2.0 Client ID</p>
                </section>

                <section>
                    <div className="flex justify-between items-center mb-4"><h3 className="text-[10px] font-black text-blue-600 uppercase">Overige API Keys</h3><button onClick={()=>setApis([...apis, {name:'', val:''}])} className="bg-blue-100 text-blue-700 px-2 rounded font-bold">+</button></div>
                    {apis.map((a, i) => (
                        <div key={i} className="flex gap-2 mb-2">
                            <input placeholder="Naam (bijv. Groq)" value={a.name} onChange={e=>{const n=[...apis]; n[i].name=e.target.value; setApis(n);}} className="w-1/3 p-2.5 border rounded text-xs font-bold bg-gray-50 outline-none focus:border-blue-500" />
                            <input type="password" placeholder="API Key..." value={a.val} onChange={e=>{const n=[...apis]; n[i].val=e.target.value; setApis(n);}} className="flex-1 p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                            <button onClick={()=>{const n=apis.filter((_,idx)=>idx!==i); setApis(n);}} className="text-red-400 hover:text-red-600 font-bold px-1">&times;</button>
                        </div>
                    ))}
                </section>

                <section>
                    <div className="flex justify-between items-center mb-4"><h3 className="text-[10px] font-black text-blue-600 uppercase">Live iCal Links (.ics)</h3><button onClick={()=>setIcals([...icals, {name:'', val:''}])} className="bg-blue-100 text-blue-700 px-2 rounded font-bold">+</button></div>
                    {icals.map((c, i) => (
                        <div key={i} className="flex gap-2 mb-2">
                            <input placeholder="Naam (bijv. Werk)" value={c.name} onChange={e=>{const n=[...icals]; n[i].name=e.target.value; setIcals(n);}} className="w-1/3 p-2.5 border rounded text-xs font-bold bg-gray-50 outline-none focus:border-blue-500" />
                            <input type="text" placeholder="https://..." value={c.val} onChange={e=>{const n=[...icals]; n[i].val=e.target.value; setIcals(n);}} className="flex-1 p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                            <button onClick={()=>{const n=icals.filter((_,idx)=>idx!==i); setIcals(n);}} className="text-red-400 hover:text-red-600 font-bold px-1">&times;</button>
                        </div>
                    ))}
                </section>

                <section className="bg-gray-50 p-4 rounded border border-gray-200">
                    <h3 className="text-[10px] font-black text-gray-800 uppercase mb-3">Systeem & AI Beheer</h3>
                    <label className="text-[9px] font-bold text-gray-500 uppercase block mb-1">AI Chat URL (Voor updates)</label>
                    <div className="flex gap-2">
                        <input type="text" placeholder="Link van AI chat..." value={aiUrl} onChange={e=>setAiUrl(e.target.value)} className="flex-1 p-3 border rounded text-xs font-mono bg-white shadow-sm outline-none focus:border-blue-500" />
                        <a href={aiUrl || '#'} target="_blank" className="bg-blue-600 text-white px-4 rounded flex items-center justify-center font-bold text-xs hover:bg-blue-700 transition">Open</a>
                    </div>
                </section>
            </div>
            
            <div className="mt-8 shrink-0">
                <button onClick={saveAll} disabled={isSaving} className="w-full bg-[#1a1a1a] text-white py-4 text-[10px] font-black uppercase rounded shadow-lg hover:bg-black transition disabled:opacity-50">
                    {isSaving ? 'BEZIG MET CLOUD SYNC...' : 'OPSLAAN & HERLADEN (CLOUD SYNC)'}
                </button>
                <button onClick={() => { S.remove('auth_status'); window.location.reload(); }} className="mt-4 w-full bg-red-500/10 text-red-500 py-3 text-[10px] font-black uppercase rounded hover:bg-red-500 hover:text-white transition flex items-center justify-center gap-2">
                    Uitloggen <Ico.Lock />
                </button>
            </div>
        </div>
    );
}

function EmailWidget({ lang }) {
    const [accounts, setAccounts] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [activeAction, setActiveAction] = useState({ id: null, type: null });
    const [replyText, setReplyText] = useState('');
    const [destinations, setDestinations] = useState([]);
    const [selectedMail, setSelectedMail] = useState(null);
    const [mailBody, setMailBody] = useState('');
    const [bodyLoading, setBodyLoading] = useState(false);
    const [initializing, setInitializing] = useState(true);

    const [gmailAccounts, setGmailAccounts] = useState([]);
    const [activeTab, setActiveTab] = useState('outlook');
    const [gmailLoading, setGmailLoading] = useState(false);
    
    const gmailClientId = S.load('gmail_client_id', GOOGLE_CLIENT_ID);
    const msClientId = S.load('ms_client_id', '');
    const msalRef = useRef(null);

    const initMsal = async () => {
        if (!window.msal) { setError('MSAL script niet geladen'); return null; }
        if (!msClientId) { setError('Configureer Client ID in instellingen'); return null; }
        if (!msalRef.current) {
            msalRef.current = new window.msal.PublicClientApplication({
                auth: { clientId: msClientId, authority: "https://login.microsoftonline.com/common" },
                cache: { cacheLocation: "localStorage" }
            });
            await msalRef.current.initialize();
        }
        return msalRef.current;
    };

    const acquireTokenForAccount = async (msalAccount) => {
        const instance = await initMsal();
        if (!instance) { return null; }
        try {
            const r = await instance.acquireTokenSilent({ scopes: ["Mail.ReadWrite","Mail.Send"], account: msalAccount });
            return r.accessToken;
        } catch (e) {
            try {
                const r = await instance.acquireTokenPopup({ scopes: ["Mail.ReadWrite","Mail.Send"], account: msalAccount });
                return r.accessToken;
            } catch (err) { return null; }
        }
    };

    const accountLabel = (msalAccount) => {
        if (!msalAccount) { return '?'; }
        const email = msalAccount.username || '';
        const local = email.split('@')[0];
        const pretty = local.replace(/[._-]/g, '-').split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('-');
        return pretty.length > 12 ? pretty.slice(0, 12) : pretty;
    };

    useEffect(() => {
        let isMounted = true;
        const autoConnect = async () => {
            if (isMounted) { setInitializing(true); }
            const timer = setTimeout(() => { 
                if (isMounted) { setInitializing(false); } 
            }, 2000); 

            try {
                const instance = await initMsal();
                if (!instance) { return; }
                const cached = instance.getAllAccounts();
                if (cached.length === 0) { return; }

                const loaded = [];
                for (let i = 0; i < cached.length; i++) {
                    const c = cached[i];
                    const token = await acquireTokenForAccount(c);
                    loaded.push({ msalAccount: c, token: token, emails: [], label: accountLabel(c) });
                }
                
                if (isMounted) { setAccounts(loaded); }
                
                loaded.forEach((a, i) => { 
                    if (a.token) { fetchMailsForAccount(a.token, i, a.label); } 
                });
            } catch (error) {
                console.error(error);
            } finally {
                clearTimeout(timer);
                if (isMounted) { setInitializing(false); }
            }
        };
        autoConnect();
        return () => { isMounted = false; };
    }, []);

    const addAccount = async () => {
        try {
            setError('');
            const instance = await initMsal();
            if (!instance) { return; }
            await instance.handleRedirectPromise();
            const r = await instance.loginPopup({ scopes: ["Mail.ReadWrite","Mail.Send"], prompt: "select_account" });
            
            setAccounts(prev => {
                const exists = prev.some(a => a.msalAccount.username.toLowerCase() === r.account.username.toLowerCase());
                if (exists) { setError('Account al toegevoegd'); return prev; }
                const label = accountLabel(r.account);
                const newArr = [...prev, { msalAccount: r.account, token: r.accessToken, emails: [], label: label }];
                fetchMailsForAccount(r.accessToken, newArr.length - 1, label);
                return newArr;
            });
        } catch (e) {
            console.error('Add account error:', e);
            if (e.errorCode === 'interaction_in_progress') {
                setError('Wacht tot vorige actie klaar is');
            } else {
                setError('Account toevoegen mislukt');
            }
        }
    };

    const graphFetch = async (url, token, accountIdx, options = {}) => {
        const res = await fetch(`https://graph.microsoft.com/v1.0${url}`, {
            ...options,
            headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json', ...(options.headers||{}) }
        });
        if (res.status === 401) {
            const acct = accounts[accountIdx];
            if (acct) {
                const newToken = await acquireTokenForAccount(acct.msalAccount);
                if (newToken) {
                    setAccounts(prev => {
                        return prev.map((a, i) => {
                            if (i === accountIdx) { return { ...a, token: newToken }; }
                            return a;
                        });
                    });
                    return fetch(`https://graph.microsoft.com/v1.0${url}`, {
                        ...options,
                        headers: { Authorization: `Bearer ${newToken}`, 'Content-Type': 'application/json', ...(options.headers||{}) }
                    });
                }
            }
            setError('Sessie verlopen'); return null;
        }
        return res;
    };

    const fetchMailsForAccount = async (token, idx, label) => {
        setLoading(true);
        const timer = setTimeout(() => { setLoading(false); }, 2000);
        try {
            const controller = new AbortController();
            setTimeout(() => { controller.abort(); }, 2000);
            
            const res = await graphFetch('/me/mailFolders/inbox/messages?$orderby=receivedDateTime desc&$top=50&$select=subject,sender,bodyPreview,receivedDateTime,webLink,inferenceClassification', token, idx, { signal: controller.signal });
            if (!res || !res.ok) { return; }
            
            const data = await res.json();
            const rawMails = data.value || [];
            const emails = rawMails.filter(m => m.inferenceClassification === 'focused').slice(0, 20).map(m => {
                return {
                    id: m.id, accountIdx: idx, accountLabel: label,
                    subject: m.subject || '(geen onderwerp)',
                    fromStr: m.sender?.emailAddress?.name || m.sender?.emailAddress?.address || 'Onbekend',
                    snippet: m.bodyPreview || '',
                    date: m.receivedDateTime, webLink: m.webLink || ''
                };
            });
            
            setAccounts(prev => {
                return prev.map((a, i) => {
                    if (i === idx) { return { ...a, emails: emails }; }
                    return a;
                });
            });
        } catch (error) {
            console.error(error);
        } finally {
            clearTimeout(timer);
            setLoading(false);
        }
    };

    // Sla gekoppelde Gmail-adressen op zodat ze automatisch herverbinden
    const GMAIL_STORAGE_KEY = 'gmail_linked_accounts';
    const saveLinkedGmails = (emailList) => { try { localStorage.setItem(GMAIL_STORAGE_KEY, JSON.stringify(emailList)); } catch(e){} };
    const loadLinkedGmails = () => { try { return JSON.parse(localStorage.getItem(GMAIL_STORAGE_KEY) || '[]'); } catch(e){ return []; } };

    const connectGmail = (selectAccount = false, hintEmail = null) => {
        if (!gmailClientId) { setError('Configureer Gmail Client ID in instellingen'); return; }
        const client = window.google.accounts.oauth2.initTokenClient({
            client_id: gmailClientId,
            scope: 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/gmail.modify https://www.googleapis.com/auth/gmail.send',
            prompt: selectAccount ? 'select_account' : '',
            login_hint: hintEmail || '',
            callback: async (tokenResponse) => {
                if (tokenResponse.error) { return; }
                const token = tokenResponse.access_token;
                try {
                    const profileRes = await fetch('https://www.googleapis.com/gmail/v1/users/me/profile', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    const profile = await profileRes.json();
                    const email = profile.emailAddress || 'Gmail';
                    const label = email.split('@')[0].replace(/[._-]/g, '-').split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('-').slice(0, 12);

                    setGmailAccounts(prev => {
                        const exists = prev.findIndex(a => a.email === email);
                        let newList;
                        if (exists >= 0) {
                            const updated = [...prev];
                            updated[exists] = { ...updated[exists], token: token };
                            fetchGmail(token, exists, label, updated);
                            newList = updated;
                        } else {
                            newList = [...prev, { email: email, token: token, emails: [], label: label }];
                            fetchGmail(token, newList.length - 1, label, newList);
                        }
                        // Sla alle gekoppelde emails op
                        saveLinkedGmails(newList.map(a => a.email));
                        return newList;
                    });
                } catch (err) { setError('Gmail profiel ophalen mislukt'); }
            }
        });
        client.requestAccessToken({ prompt: selectAccount ? 'select_account' : '' });
    };

    const fetchGmail = async (token, idx, label, currentAccounts) => {
        setGmailLoading(true);
        const timer = setTimeout(() => { setGmailLoading(false); }, 2000);
        try {
            const controller = new AbortController();
            setTimeout(() => { controller.abort(); }, 2000);
            
            const res = await fetch('https://www.googleapis.com/gmail/v1/users/me/messages?maxResults=20&labelIds=INBOX&q=category:primary', {
                headers: { Authorization: `Bearer ${token}` }, signal: controller.signal
            });
            if (!res.ok) { throw new Error(`HTTP ${res.status}`); }
            const data = await res.json();
            const messages = data.messages || [];

            const details = await Promise.all(messages.slice(0, 20).map(async m => {
                const r = await fetch(`https://www.googleapis.com/gmail/v1/users/me/messages/${m.id}?format=metadata&metadataHeaders=Subject&metadataHeaders=From&metadataHeaders=Date`, {
                    headers: { Authorization: `Bearer ${token}` }, signal: controller.signal
                }).catch(() => null);
                return (r && r.ok) ? r.json() : null;
            }));

            const emails = details.filter(Boolean).map(m => {
                const headers = m.payload?.headers || [];
                const getH = (name) => {
                    const found = headers.find(h => h.name.toLowerCase() === name.toLowerCase());
                    return found ? found.value : '';
                };
                return {
                    id: m.id, accountIdx: idx, accountLabel: label, source: 'gmail',
                    subject: getH('Subject') || '(geen onderwerp)',
                    fromStr: getH('From').replace(/<.*>/, '').trim() || 'Onbekend',
                    snippet: m.snippet || '',
                    date: new Date(parseInt(m.internalDate)).toISOString(),
                    threadId: m.threadId
                };
            });

            setGmailAccounts(prev => {
                return prev.map((a, i) => {
                    if (i === idx) { return { ...a, emails: emails }; }
                    return a;
                });
            });
        } catch (error) {
            console.error('Gmail fetch:', error);
        } finally {
            clearTimeout(timer);
            setGmailLoading(false);
        }
    };

    useEffect(() => {
        if (gmailClientId && gmailAccounts.length === 0 && !initializing) {
            connectGmail(false);
        }
    }, [initializing]);

    const openGmailMail = async (mail) => {
        setSelectedMail(mail); setMailBody(''); setBodyLoading(true);
        setActiveAction({ id: null, type: null }); setReplyText('');
        const token = gmailAccounts[mail.accountIdx]?.token;
        try {
            const res = await fetch(`https://www.googleapis.com/gmail/v1/users/me/messages/${mail.id}?format=full`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await res.json();
            const part = data.payload?.parts?.find(p => p.mimeType === 'text/html') || data.payload?.parts?.find(p => p.mimeType === 'text/plain') || data.payload;
            const encoded = part?.body?.data || '';
            const decoded = encoded ? atob(encoded.replace(/-/g, '+').replace(/_/g, '/')) : 'Geen inhoud';
            setMailBody(decoded);
        } catch (err) { setMailBody('Kon mail niet laden'); }
        setBodyLoading(false);
    };

    const deleteGmail = async (mail) => {
        const token = gmailAccounts[mail.accountIdx]?.token;
        setGmailAccounts(prev => {
            return prev.map((a, i) => {
                if (i === mail.accountIdx) { return { ...a, emails: a.emails.filter(m => m.id !== mail.id) }; }
                return a;
            });
        });
        try { await fetch(`https://www.googleapis.com/gmail/v1/users/me/messages/${mail.id}/trash`, { method: 'POST', headers: { Authorization: `Bearer ${token}` } }); } catch (err) {}
    };

    const mergedEmails = React.useMemo(() => {
        const all = [];
        if (activeTab === 'outlook') {
            accounts.forEach(a => a.emails.forEach(m => all.push({...m, source:'outlook'})));
        } else {
            gmailAccounts.forEach(a => a.emails.forEach(m => all.push(m)));
        }
        return all.sort((a,b) => new Date(b.date) - new Date(a.date));
    }, [accounts, gmailAccounts, activeTab]);

    const tokenForMail = (mail) => {
        const acct = accounts[mail?.accountIdx];
        return acct ? acct.token : null;
    };

    const openMail = async (mail) => {
        setSelectedMail(mail); setMailBody(''); setBodyLoading(true);
        setActiveAction({ id:null, type:null }); setReplyText('');
        try {
            const res = await graphFetch(`/me/messages/${mail.id}?$select=body`, tokenForMail(mail), mail.accountIdx);
            if (!res) { return; }
            const data = await res.json();
            setMailBody(data.body?.content || 'Geen inhoud');
        } catch (err) { setMailBody('Kon mail niet laden'); }
        setBodyLoading(false);
    };

    const removeMailFromUI = (mail) => {
        setAccounts(prev => {
            return prev.map((a, i) => {
                if (i === mail.accountIdx) { return { ...a, emails: a.emails.filter(m => m.id !== mail.id) }; }
                return a;
            });
        });
        setSelectedMail(null); setActiveAction({id:null,type:null});
    };

    const deleteMail = async (mail) => {
        removeMailFromUI(mail);
        try { await graphFetch(`/me/messages/${mail.id}`, tokenForMail(mail), mail.accountIdx, { method:'DELETE' }); } catch (err) {}
    };

    const moveMail = async (mail, folderId) => {
        removeMailFromUI(mail);
        try { await graphFetch(`/me/messages/${mail.id}/move`, tokenForMail(mail), mail.accountIdx, { method:'POST', body:JSON.stringify({destinationId:folderId}) }); } catch (err) {}
    };

    const loadFolders = async (mail) => {
        setDestinations([]);
        try {
            const res = await graphFetch('/me/mailFolders?$top=20', tokenForMail(mail), mail.accountIdx);
            if (!res) { return; }
            const data = await res.json();
            setDestinations((data.value||[]).map(f => { return {id:f.id, name:f.displayName}; }));
        } catch (err) {}
    };

    const sendReply = async (mail) => {
        if (!replyText.trim()) { return; }
        try {
            await graphFetch(`/me/messages/${mail.id}/reply`, tokenForMail(mail), mail.accountIdx, {
                method:'POST', body:JSON.stringify({message:{body:{contentType:"Text",content:`${replyText}\n\n\nGroeten, Michael`}}})
            });
            setActiveAction({id:null,type:null}); setReplyText(''); setError('');
        } catch (err) { setError('Versturen mislukt'); }
    };

    const forwardMail = async (mail) => {
        if (!replyText.trim()) { return; }
        const parts = replyText.split(',').map(s=>s.trim()).filter(p=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p));
        if (!parts.length) { setError('Voer een geldig e-mailadres in'); return; }
        try {
            await graphFetch(`/me/messages/${mail.id}/forward`, tokenForMail(mail), mail.accountIdx, {
                method:'POST', body:JSON.stringify({ toRecipients:parts.map(a=>{ return {emailAddress:{address:a}}; }), comment:'\n\nGroeten, Michael' })
            });
            setActiveAction({id:null,type:null}); setReplyText(''); setError('');
        } catch (err) { setError('Doorsturen mislukt'); }
    };

    const toggleAction = (id, type) => {
        if (activeAction.id === id && activeAction.type === type) { 
            setActiveAction({id:null,type:null}); 
        } else { 
            setActiveAction({id,type}); 
            setReplyText(''); 
            if (type === 'move') { loadFolders(selectedMail); }
        }
    };

    const MailRow = ({ mail }) => {
        return (
            <div className="relative overflow-hidden border-b border-gray-100">
                <div className="relative bg-white">
                    <div className="px-4 py-3 cursor-pointer hover:bg-gray-50/60 transition" onClick={() => { if(mail.source === 'gmail'){ openGmailMail(mail); } else { openMail(mail); } }}>
                        <div className="flex justify-between items-start gap-2">
                            <span className="text-[12px] font-semibold text-gray-900 truncate flex-1" style={{fontFamily:'Inter,system-ui,sans-serif'}}>{mail.fromStr}</span>
                            <div className="text-right shrink-0">
                                <div className="text-[9px] font-bold text-red-400">{mail.accountLabel}</div>
                                <div className="text-[9px] text-gray-400">{new Date(mail.date).toLocaleString('nl-NL',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})}</div>
                            </div>
                        </div>
                        <div className="text-[11px] text-blue-700 font-medium truncate mt-0.5" style={{fontFamily:'Inter,system-ui,sans-serif'}}>{mail.subject}</div>
                        <div className="text-[10px] text-gray-400 truncate mt-0.5">{mail.snippet}</div>
                    </div>
                </div>
            </div>
        );
    };

    return (
        <div className="widget h-[500px] flex flex-col bg-white">
            <div className="shrink-0 px-4 py-3 bg-gray-50 border-b flex items-center justify-between">
                <div className="flex items-center gap-2">
                    {selectedMail && (
                        <button onClick={() => { setSelectedMail(null); setActiveAction({id:null,type:null}); }} className="p-1 rounded hover:bg-gray-200 transition">
                            <svg className="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7"/></svg>
                        </button>
                    )}
                    <Ico.Mail />
                    <span className="text-[11px] font-black tracking-widest uppercase">Mail</span>
                </div>
                {error && <span className="text-[9px] text-red-500 font-bold truncate max-w-[200px]">{error}</span>}
            </div>

            {!selectedMail && (
                <div className="shrink-0 border-b">
                    <div className="flex">
                        <button className={`tab-btn flex-1 ${activeTab==='outlook'?'active':''}`} onClick={()=>{setActiveTab('outlook');}}>OUTLOOK</button>
                        <button className={`tab-btn flex-1 ${activeTab==='gmail'?'active':''}`} onClick={()=>{setActiveTab('gmail');}}>GMAIL</button>
                    </div>
                    <div className="flex items-center px-4 py-1.5 gap-2 bg-gray-50/50">
                        {(activeTab==='outlook'?accounts:gmailAccounts).map((a,i) => (
                            <span key={i} className="text-[8px] font-bold bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full" title={a.msalAccount?.username||a.email||''}>
                                {a.label}
                            </span>
                        ))}
                        <button onClick={()=>{ activeTab==='outlook' ? addAccount() : connectGmail(true); }} className="ml-auto w-5 h-5 flex items-center justify-center rounded-full bg-blue-50 text-blue-500 hover:bg-blue-100 transition" title="Account toevoegen">
                            <svg className="w-3 h-3" fill="none" stroke="currentColor" strokeWidth="2.5" viewBox="0 0 24 24"><path strokeLinecap="round" d="M12 5v14m-7-7h14"/></svg>
                        </button>
                    </div>
                </div>
            )}

            <div className="flex-1 overflow-y-auto hide-scroll">
                {selectedMail ? (
                    <div className="flex flex-col h-full">
                        <div className="shrink-0 p-3 border-b bg-gray-50/50">
                            <h3 className="text-[12px] font-bold text-gray-800 leading-snug mb-1">{selectedMail.subject}</h3>
                            <div className="text-[9px] text-gray-500">Van: {selectedMail.fromStr} ‚Ä¢ {selectedMail.accountLabel} ‚Ä¢ {new Date(selectedMail.date).toLocaleString('nl-NL',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})}</div>
                            <div className="flex gap-1 mt-2">
                                <button onClick={() => toggleAction(selectedMail.id,'reply')} className={`text-[8px] font-bold px-2 py-1 rounded transition ${activeAction.type==='reply'?'bg-blue-600 text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>Beantwoorden</button>
                                <button onClick={() => toggleAction(selectedMail.id,'forward')} className={`text-[8px] font-bold px-2 py-1 rounded transition ${activeAction.type==='forward'?'bg-blue-600 text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>Doorsturen</button>
                                <button onClick={() => toggleAction(selectedMail.id,'move')} className={`text-[8px] font-bold px-2 py-1 rounded transition ${activeAction.type==='move'?'bg-blue-600 text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>Verplaatsen</button>
                                <button onClick={() => { if(mail.source === 'gmail') { deleteGmail(selectedMail); } else { deleteMail(selectedMail); } }} className="text-[8px] font-bold px-2 py-1 rounded bg-red-50 text-red-500 hover:bg-red-100 transition">Verwijderen</button>
                            </div>
                            {activeAction.type==='reply' && (
                                <div className="mt-2 flex gap-1">
                                    <input value={replyText} onChange={e=>{setReplyText(e.target.value);}} placeholder="Typ antwoord..." className="flex-1 text-[10px] border rounded px-2 py-1 outline-none focus:border-blue-400" onKeyDown={e=>{ if (e.key==='Enter') { sendReply(selectedMail); } }} />
                                    <button onClick={()=>{sendReply(selectedMail);}} className="bg-blue-600 text-white text-[8px] font-bold px-3 rounded hover:bg-blue-700">Stuur</button>
                                </div>
                            )}
                            {activeAction.type==='forward' && (
                                <div className="mt-2 flex gap-1">
                                    <input value={replyText} onChange={e=>{setReplyText(e.target.value);}} placeholder="email@voorbeeld.nl" className="flex-1 text-[10px] border rounded px-2 py-1 outline-none focus:border-blue-400" onKeyDown={e=>{ if (e.key==='Enter') { forwardMail(selectedMail); } }} />
                                    <button onClick={()=>{forwardMail(selectedMail);}} className="bg-blue-600 text-white text-[8px] font-bold px-3 rounded hover:bg-blue-700">Stuur</button>
                                </div>
                            )}
                            {activeAction.type==='move' && (
                                <div className="mt-2">
                                    {destinations.length===0 ? <span className="text-[9px] text-gray-400 animate-pulse">Laden...</span> : (
                                        <select onChange={e=>{if(e.target.value){moveMail(selectedMail,e.target.value);}}} defaultValue="" className="w-full p-2 border rounded text-[10px] bg-white outline-none focus:border-blue-400">
                                            <option value="" disabled>Kies map...</option>
                                            {destinations.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}
                                        </select>
                                    )}
                                </div>
                            )}
                        </div>
                        <div className="flex-1 overflow-y-auto px-3 py-2">
                            {bodyLoading ? <span className="text-[10px] text-blue-600 font-bold animate-pulse">Laden...</span>
                            : <div className="text-[10px] text-gray-700 leading-relaxed mail-body" dangerouslySetInnerHTML={{__html:mailBody}} />}
                        </div>
                    </div>
                ) : (
                    <>
                        {initializing && (
                            <div className="flex items-center justify-center h-full">
                                <span className="text-[10px] font-bold text-blue-600 uppercase animate-pulse">Verbinden...</span>
                            </div>
                        )}
                        {!initializing && accounts.length===0 && gmailAccounts.length===0 && (
                            <div className="flex items-center justify-center h-full">
                                <span className="text-[10px] text-gray-400">Geen accounts ‚Äî klik + om toe te voegen</span>
                            </div>
                        )}
                        {!initializing && (loading || gmailLoading) && mergedEmails.length===0 && (
                            <div className="flex items-center justify-center h-full">
                                <span className="text-[10px] font-bold text-blue-600 uppercase animate-pulse">Synchroniseren...</span>
                            </div>
                        )}
                        {!initializing && !(loading || gmailLoading) && mergedEmails.length===0 && (accounts.length>0 || gmailAccounts.length>0) && (
                            <div className="flex items-center justify-center h-full">
                                <span className="text-[10px] font-bold text-gray-400 uppercase">Geen nieuwe mails</span>
                            </div>
                        )}
                        {!initializing && mergedEmails.map(mail => (
                            <MailRow key={`${mail.accountIdx}-${mail.id}`} mail={mail} />
                        ))}
                    </>
                )}
            </div>
        </div>
    );
}

function App() {
    const [isAuth, setIsAuth] = useState(S.load('auth_status', false));
    const [isSyncing, setIsSyncing] = useState(false);
    
    const [settingsOpen, setSettingsOpen] = useState(false);
    const [lang, setLang] = useState('nl');
    
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    
    const defaultLayout = ['ai', 'crypto', 'agenda', 'news', 'spark', 'radar', 'sports', 'email'];
    const [layout, setLayout] = useState(() => S.load('layout_v9', defaultLayout));

    useEffect(() => {
        const doSync = async () => {
            if (isAuth) {
                setIsSyncing(true);
                try {
                    const res = await fetch(`/api/settings?email=${ALLOWED_EMAIL}&t=${Date.now()}`, { cache: 'no-store' });
                    if(res.ok) {
                        let cloudData = await res.json();
                        if (typeof cloudData === 'string') { try { cloudData = JSON.parse(cloudData); } catch(e) {} }
                        if (cloudData && typeof cloudData === 'object' && Object.keys(cloudData).length > 0) {
                            Object.keys(cloudData).forEach(k => S.save(k, cloudData[k]));
                        }
                    }
                } catch(e) { console.error("Auto-sync mislukt", e); }
                
                setLang(S.load('lang', 'nl'));
                setLayout(S.load('layout_v9', defaultLayout));
                setIsSyncing(false); 
            }
        };
        doSync();
    }, [isAuth]);

    useEffect(() => {
        if (!isAuth && window.google) {
            window.google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse });
            window.google.accounts.id.renderButton(document.getElementById("google-btn"), { theme: "filled_blue", size: "large", shape: "pill" });
        }
    }, [isAuth]);

    const handleCredentialResponse = async (response) => {
        try {
            const payload = JSON.parse(atob(response.credential.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
            if(payload.email.toLowerCase() === ALLOWED_EMAIL.toLowerCase()) { 
                S.save('auth_status', true);
                setIsAuth(true); 
            } else { 
                alert("Toegang geweigerd! Dit account heeft geen permissie."); 
            }
        } catch(e) { console.error("Login failed"); }
    };

    if (!isAuth || isSyncing) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center bg-[#000a14] text-white">
                <div className="bg-white/10 p-10 rounded-2xl border border-white/10 shadow-2xl flex flex-col items-center backdrop-blur-md">
                    <Ico.Lock />
                    <h1 className="text-2xl font-black mt-4 mb-2 tracking-widest uppercase">Secured Access</h1>
                    <p className="text-xs text-gray-400 mb-8">{isSyncing ? 'Synchroniseren met cloud database...' : 'Personal Dashboard ver. 5.6'}</p>
                    {!isSyncing && <div id="google-btn"></div>}
                </div>
            </div>
        );
    }

    const widgets = { 
        ai: <div className="col-span-12 lg:col-span-8"><WidgetErrorBoundary name="AI Chat"><AIWidget lang={lang} /></WidgetErrorBoundary></div>, 
        crypto: <div className="col-span-12 lg:col-span-4"><WidgetErrorBoundary name="Crypto"><CryptoWidget lang={lang} /></WidgetErrorBoundary></div>, 
        agenda: <div className="col-span-12 lg:col-span-4"><WidgetErrorBoundary name="Agenda"><AgendaWidget lang={lang} /></WidgetErrorBoundary></div>, 
        news: <div className="col-span-12 lg:col-span-8"><WidgetErrorBoundary name="Nieuws"><NewsWidget lang={lang} /></WidgetErrorBoundary></div>, 
        spark: <div className="col-span-12 lg:col-span-4"><WidgetErrorBoundary name="Spark"><SparkWidget lang={lang} /></WidgetErrorBoundary></div>,
        radar: <div className="col-span-12 lg:col-span-4"><WidgetErrorBoundary name="Beurs Radar"><RadarWidget lang={lang} /></WidgetErrorBoundary></div>, 
        sports: <div className="col-span-12 lg:col-span-4"><WidgetErrorBoundary name="Sport"><SportsWidget lang={lang} /></WidgetErrorBoundary></div>,
        email: <div className="col-span-12 lg:col-span-4"><WidgetErrorBoundary name="Email"><EmailWidget lang={lang} /></WidgetErrorBoundary></div>
    };

    const hour = new Date().getHours();
    let greetingNL = 'Goedenavond'; let greetingEN = 'Good evening';
    if (hour >= 6 && hour < 12) { greetingNL = 'Goedemorgen'; greetingEN = 'Good morning'; } 
    else if (hour >= 12 && hour < 18) { greetingNL = 'Goedemiddag'; greetingEN = 'Good afternoon'; }
    const dynamicGreeting = lang === 'nl' ? greetingNL : greetingEN;

    return (
        <div className="flex flex-col min-h-screen">
            <WeatherBar lang={lang} />
            <header className="px-6 md:px-10 py-5 max-w-[1600px] mx-auto w-full flex justify-between items-center border-b border-white/10 mb-6">
                <div>
                    <h1 className="text-xl md:text-2xl font-black text-white tracking-tight drop-shadow-md leading-none">
                        {dynamicGreeting} Michael
                    </h1>
                </div>
                <div className="flex gap-2 md:gap-3 items-center">
                    {isStandalone && (
                        <button onClick={() => window.location.reload()} className="w-10 h-10 flex items-center justify-center bg-white/10 text-white rounded hover:bg-white/20 transition" title="Ververs Dashboard">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        </button>
                    )}
                    <button onClick={() => {const nL=lang==='nl'?'en':'nl'; setLang(nL); S.save('lang', nL)}} className="h-10 px-4 flex items-center justify-center bg-white/10 text-white rounded hover:bg-white/20 transition font-bold text-xs uppercase tracking-widest">
                        {lang === 'nl' ? 'NL / EN' : 'EN / NL'}
                    </button>
                    <button onClick={() => setSettingsOpen(true)} className="w-10 h-10 flex items-center justify-center bg-white/10 text-white rounded hover:bg-white/20 transition">
                        <Ico.Set />
                    </button>
                </div>
            </header>
            <main className="px-6 md:px-10 pb-16 max-w-[1600px] mx-auto w-full">
                <div className="grid grid-cols-12 gap-6 md:gap-8">
                    {layout.map(w => <React.Fragment key={w}>{widgets[w]}</React.Fragment>)}
                </div>
            </main>
            <Settings isOpen={settingsOpen} onClose={() => setSettingsOpen(false)} layout={layout} setLayout={setLayout} />
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>

</html>






