<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Dashboard - Michael</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --p-blue: #0073b1; --bg: linear-gradient(135deg, #001a33 0%, #000a14 100%); }
        body { background: var(--bg); min-height: 100vh; font-family: 'Inter', sans-serif; margin: 0; color: #1a1a1a; }
        .widget { background: rgba(255,255,255,0.98); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .settings-panel { position: fixed; right: 0; top: 0; height: 100vh; width: 100%; max-width: 480px; background: white; z-index: 100; box-shadow: -10px 0 30px rgba(0,0,0,0.5); transform: translateX(100%); transition: 0.3s ease; overflow-y: auto; }
        .settings-panel.open { transform: translateX(0); }
        .sparkline-bg { position: absolute; bottom: 0; left: 0; right: 0; height: 40px; opacity: 0.08; background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 30" xmlns="http://www.w3.org/2000/svg"><path d="M0 30 L10 20 L20 25 L30 15 L40 18 L50 5 L60 10 L70 2 L80 12 L90 5 L100 0 L100 30 Z" fill="%230073b1"/></svg>'); background-size: cover; background-position: bottom; pointer-events: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

// ----- BEVEILIGINGS INSTELLINGEN -----
const GOOGLE_CLIENT_ID = "196901777247-3ak09abjpa3dm5908a5f8m08d4o7gqj8.apps.googleusercontent.com";
const ALLOWED_EMAIL = "diabaas3@gmail.com"; //
// -------------------------------------

const S = {
    load: (k, d) => { try { const v = localStorage.getItem('d_'+k); return v ? JSON.parse(v) : d; } catch(e) { return d; } },
    save: (k, v) => localStorage.setItem('d_'+k, JSON.stringify(v)),
    remove: (k) => localStorage.removeItem('d_'+k)
};

const Ico = {
    Set: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
    Lock: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/></svg>,
    Cry: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
};

function AgendaWidget() {
    const rawCals = S.load('icals_dyn', [{name: 'Ryan', val: ''}, {name: 'Yaron', val: ''}, {name: 'Micha√´l', val: ''}, {name: 'Ex-vrouw', val: ''}]);
    const cals = rawCals.map(c => c.name).filter(Boolean);
    const [d, setD] = useState(new Date().toISOString().split('T')[0]); 
    const [f, setF] = useState(cals);
    const [searchTerm, setSearchTerm] = useState('');
    const [items, setItems] = useState([]);
    const [jumpDate, setJumpDate] = useState({ day: new Date().getDate(), month: new Date().getMonth() + 1, year: new Date().getFullYear() });

    const getFullDateString = (dateStr) => {
        const date = new Date(dateStr);
        const dayName = date.toLocaleDateString('nl-NL', { weekday: 'short' });
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        return `${dayName} ${date.toLocaleDateString('nl-NL', options)}`;
    };

    const handleJump = () => {
        const newDate = new Date(jumpDate.year, jumpDate.month - 1, jumpDate.day);
        if (!isNaN(newDate)) setD(newDate.toISOString().split('T')[0]);
    };

    const goToday = () => {
        const today = new Date();
        setD(today.toISOString().split('T')[0]);
        setJumpDate({ day: today.getDate(), month: today.getMonth() + 1, year: today.getFullYear() });
    };

    useEffect(() => {
        const fetchCals = async () => {
            let allEvs = [];
            for(let c of rawCals) {
                if(!c.val) continue;
                try {
                    const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(c.val)}`);
                    const txt = await res.text();
                    let cur = {}; const lines = txt.split(/\r?\n/);
                    for(let l of lines) {
                        if(l.startsWith('BEGIN:VEVENT')) cur = {};
                        else if(l.startsWith('SUMMARY:')) cur.t = l.substring(8);
                        else if(l.startsWith('DTSTART')) { 
                            const m = l.match(/:(\d{4})(\d{2})(\d{2})T?(\d{2})?(\d{2})?/); 
                            if(m) { cur.date = `${m[1]}-${m[2]}-${m[3]}`; cur.time = m[4] ? `${m[4]}:${m[5]}` : '00:00'; } 
                        }
                        else if(l.startsWith('END:VEVENT') && cur.t && cur.date) allEvs.push({...cur, p: c.name, source: c.name === 'Micha√´l' ? 'Outlook' : 'Magister'});
                    }
                } catch(e) { console.error(e); }
            }
            if(allEvs.length === 0) allEvs = [
                { t: 'Wiskunde', p: 'Ryan', date: '2026-02-19', time: '09:00', source: 'Magister' },
                { t: 'Meeting met team', p: 'Micha√´l', date: '2026-02-19', time: '14:00', source: 'Outlook' },
                { t: 'Wiskunde toets', p: 'Ryan', date: '2026-02-19', time: '15:30', source: 'Magister' }
            ];
            setItems(allEvs);
        };
        fetchCals();
    }, [JSON.stringify(rawCals)]);

    const filteredItems = items.filter(i => f.includes(i.p) && i.date === d && i.t.toLowerCase().includes(searchTerm.toLowerCase())).sort((a,b) => a.time.localeCompare(b.time));

    return (
        <div className="widget h-full border-slate-100 border shadow-2xl bg-white rounded-3xl overflow-hidden">
            <div className="p-6 flex justify-between items-center bg-white">
                <div className="flex items-center gap-3">
                    <span className="text-3xl">üóìÔ∏è</span>
                    <h3 className="text-2xl font-black text-slate-800 tracking-tight">Familie Agenda</h3>
                </div>
                <button onClick={goToday} className="bg-[#0073b1] text-white px-5 py-2 rounded-xl text-sm font-black flex items-center gap-2 hover:opacity-90 transition">
                    Vandaag
                </button>
            </div>

            <div className="px-6 pb-4">
                <div className="bg-blue-50/50 p-5 rounded-2xl border border-blue-100 mb-4">
                    <p className="text-blue-600 font-black text-[11px] mb-3 uppercase tracking-widest">Ga naar datum:</p>
                    <div className="flex gap-3 items-end">
                        <div className="flex-1"><label className="text-[10px] text-slate-400 font-bold block mb-1">Dag</label><input type="number" value={jumpDate.day} onChange={e=>setJumpDate({...jumpDate, day: e.target.value})} className="w-full border-none p-2 rounded-xl text-center font-bold text-lg bg-white shadow-sm" /></div>
                        <div className="flex-1"><label className="text-[10px] text-slate-400 font-bold block mb-1">Maand</label><input type="number" value={jumpDate.month} onChange={e=>setJumpDate({...jumpDate, month: e.target.value})} className="w-full border-none p-2 rounded-xl text-center font-bold text-lg bg-white shadow-sm" /></div>
                        <div className="flex-1"><label className="text-[10px] text-slate-400 font-bold block mb-1">Jaar</label><input type="number" value={jumpDate.year} onChange={e=>setJumpDate({...jumpDate, year: e.target.value})} className="w-full border-none p-2 rounded-xl text-center font-bold text-lg bg-white shadow-sm" /></div>
                        <button onClick={handleJump} className="bg-[#0073b1] text-white p-2 rounded-xl w-14 h-12 flex items-center justify-center font-bold shadow-lg"> ‚Üí </button>
                    </div>
                </div>

                <div className="flex items-center justify-between text-[#0073b1] font-black text-lg mb-4 px-2">
                    <button onClick={() => {const nd=new Date(d); nd.setDate(nd.getDate()-1); setD(nd.toISOString().split('T')[0])}} className="text-2xl opacity-50">‚Äπ</button>
                    <span className="capitalize">{getFullDateString(d)}</span>
                    <button onClick={() => {const nd=new Date(d); nd.setDate(nd.getDate()+1); setD(nd.toISOString().split('T')[0])}} className="text-2xl opacity-50">‚Ä∫</button>
                </div>

                <div className="relative mb-4">
                    <span className="absolute left-4 top-3.5 text-blue-400">üîç</span>
                    <input type="text" placeholder="Zoek... (voetbal, Ryan)" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-11 pr-4 py-3.5 border-slate-100 border-2 rounded-2xl outline-none focus:border-blue-400 bg-slate-50/30 font-medium" />
                </div>

                <div className="flex gap-2 overflow-x-auto pb-4 hide-scroll">
                    {['Ryan', 'Yaron', 'Micha√´l', 'Ex-vrouw'].map((name, i) => {
                        const active = f.includes(name);
                        const colors = ['border-red-400 text-red-600 bg-red-50', 'border-blue-400 text-blue-600 bg-blue-50', 'border-green-400 text-green-600 bg-green-50', 'border-purple-400 text-purple-600 bg-purple-50'];
                        return <button key={name} onClick={() => setF(active ? f.filter(x => x !== name) : [...f, name])} className={`px-5 py-2 rounded-full border-2 font-black text-xs whitespace-nowrap transition-all ${active ? colors[i] : 'border-slate-100 text-slate-300 opacity-60'}`}>{name}</button>;
                    })}
                </div>

                <div className="space-y-4 max-h-[300px] overflow-y-auto pr-2">
                    {filteredItems.map((i, idx) => (
                        <div key={idx} className="flex items-center gap-4 py-1">
                            <div className={`w-1.5 h-12 rounded-full ${i.p==='Ryan'?'bg-red-400':i.p==='Yaron'?'bg-blue-400':i.p==='Micha√´l'?'bg-green-400':'bg-purple-400'}`}></div>
                            <div className="flex-1">
                                <h4 className="font-bold text-slate-800 text-base">{i.t}</h4>
                                <p className="text-slate-400 text-xs font-bold uppercase tracking-tight">{i.time} ¬∑ {i.p}</p>
                            </div>
                            <span className={`px-3 py-1 rounded-lg text-[9px] font-black uppercase ${i.source==='Magister'?'bg-red-50 text-red-400':'bg-green-50 text-green-400'}`}>{i.source}</span>
                        </div>
                    ))}
                </div>

                <div className="mt-8 pt-6 border-t border-slate-100">
                    <p className="text-[11px] font-black text-slate-400 mb-4 flex items-center gap-2 uppercase tracking-widest">üè† Schooltijden vandaag</p>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-red-50/50 p-4 rounded-2xl border border-red-100">
                            <p className="text-red-500 font-black text-xs mb-1 uppercase">Ryan</p>
                            <p className="text-slate-700 font-black text-sm">8:10 ‚Äì 16:30</p>
                        </div>
                        <div className="bg-blue-50/50 p-4 rounded-2xl border border-blue-100">
                            <p className="text-blue-500 font-black text-xs mb-1 uppercase">Yaron</p>
                            <p className="text-slate-700 font-black text-sm">9:45 ‚Äì 12:30</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}

function CryptoWidget() {
    const [portfolio, setPortfolio] = useState([]);
    const [total, setTotal] = useState(0);
    const [loading, setLoading] = useState(true);
    const [err, setErr] = useState('');

    useEffect(() => {
        const fetchBitvavo = async () => {
            const bvKeys = S.load('bitvavo_keys', {pub: '', sec: ''});
            if(!bvKeys.pub || !bvKeys.sec) { setErr('Vul API keys in bij instellingen.'); setLoading(false); return; }
            try {
                const res = await fetch('/api/bitvavo', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ key: bvKeys.pub, secret: bvKeys.sec }) });
                const data = await res.json();
                if(data.error) throw new Error(data.error);
                let calcTotal = 0;
                const combined = data.balances.map(b => {
                    const amount = parseFloat(b.available) + parseFloat(b.inOrder);
                    if(b.symbol === 'EUR') { calcTotal += amount; return { sym: 'EUR', amount, price: 1, val: amount }; }
                    const priceObj = data.prices.find(p => p.market === `${b.symbol}-EUR`);
                    const price = priceObj ? parseFloat(priceObj.price) : 0;
                    const val = amount * price; calcTotal += val;
                    return { sym: b.symbol, amount, price, val };
                }).sort((a,b) => b.val - a.val);
                setPortfolio(combined); setTotal(calcTotal);
            } catch (error) { setErr(error.message); }
            setLoading(false);
        };
        fetchBitvavo();
    }, []);

    return (
        <div className="widget h-full min-h-[450px] p-6 bg-white">
            <div className="flex items-center gap-2 mb-6 text-slate-500">
                <Ico.Cry/><h3 className="text-[10px] font-black uppercase tracking-widest">Live Bitvavo Portfolio</h3>
            </div>
            <div className="mb-6">
                <span className="text-[10px] font-bold text-slate-400 block mb-1 uppercase tracking-tighter">Totale Waarde (EUR)</span>
                <div className="text-4xl font-black text-slate-800 tracking-tighter">
                    {loading ? '...' : err ? 'Error' : `‚Ç¨${total.toLocaleString('nl-NL', {maximumFractionDigits:0})}`}
                </div>
            </div>
            <div className="space-y-3 overflow-y-auto flex-1 pr-2 hide-scroll">
                {portfolio.map((c, i) => (
                    <div key={i} className="relative p-4 border border-slate-100 rounded-2xl flex justify-between items-center bg-slate-50/30 group overflow-hidden">
                        <div className="sparkline-bg"></div>
                        <div className="relative z-10"><span className="font-black text-sm block text-slate-800">{c.sym}</span><span className="text-[10px] text-slate-400 font-bold">{c.amount.toFixed(2)} units</span></div>
                        <div className="text-right relative z-10"><span className="font-black text-sm block text-slate-800">‚Ç¨{c.val.toLocaleString('nl-NL',{maximumFractionDigits:0})}</span><span className="text-[9px] text-slate-400 font-bold">‚Ç¨{c.price.toLocaleString('nl-NL')}</span></div>
                    </div>
                ))}
            </div>
        </div>
    );
}

function Settings({ isOpen, onClose, layout, setLayout }) {
    const [bvKeys, setBvKeys] = useState(S.load('bitvavo_keys', {pub: '', sec: ''}));
    const [icals, setIcals] = useState(S.load('icals_dyn', [{name: 'Ryan', val: ''}, {name: 'Yaron', val: ''}, {name: 'Micha√´l', val: ''}, {name: 'Ex-vrouw', val: ''}]));
    const saveAll = () => { S.save('bitvavo_keys', bvKeys); S.save('icals_dyn', icals); onClose(); window.location.reload(); };

    return (
        <div className={`settings-panel p-8 ${isOpen ? 'open' : ''}`}>
            <div className="flex justify-between items-center mb-8 border-b pb-4"><h2 className="text-2xl font-black uppercase tracking-tighter">Instellingen</h2><button onClick={onClose} className="text-3xl text-slate-300 hover:text-slate-800 transition">√ó</button></div>
            <div className="space-y-8">
                <section>
                    <h3 className="text-[11px] font-black text-blue-600 uppercase mb-4 tracking-widest">Bitvavo API (Live)</h3>
                    <input type="text" placeholder="API Key" value={bvKeys.pub} onChange={e=>setBvKeys({...bvKeys, pub: e.target.value})} className="w-full p-3 border rounded-xl mb-2 text-xs font-mono bg-slate-50 outline-none focus:ring-2 ring-blue-100" />
                    <input type="password" placeholder="API Secret" value={bvKeys.sec} onChange={e=>setBvKeys({...bvKeys, sec: e.target.value})} className="w-full p-3 border rounded-xl text-xs font-mono bg-slate-50 outline-none focus:ring-2 ring-blue-100" />
                </section>
                <section>
                    <h3 className="text-[11px] font-black text-blue-600 uppercase mb-4 tracking-widest">iCal Agendalinks (.ics)</h3>
                    {icals.map((c, i) => (
                        <div key={i} className="flex gap-2 mb-3">
                            <input placeholder="Naam" value={c.name} onChange={e=>{const n=[...icals]; n[i].name=e.target.value; setIcals(n);}} className="w-1/4 p-3 border rounded-xl text-xs font-bold bg-slate-50" />
                            <input placeholder="https://..." value={c.val} onChange={e=>{const n=[...icals]; n[i].val=e.target.value; setIcals(n);}} className="flex-1 p-3 border rounded-xl text-xs font-mono bg-slate-50" />
                        </div>
                    ))}
                </section>
            </div>
            <button onClick={saveAll} className="mt-10 w-full bg-slate-900 text-white py-4 text-xs font-black uppercase rounded-2xl shadow-xl hover:bg-black transition">Opslaan & Herladen</button>
        </div>
    );
}

function App() {
    const [isAuth, setIsAuth] = useState(S.load('auth_status', false));
    const [settingsOpen, setSettingsOpen] = useState(false);
    
    useEffect(() => {
        if (!isAuth && window.google) {
            window.google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse });
            window.google.accounts.id.renderButton(document.getElementById("google-btn"), { theme: "filled_blue", size: "large", shape: "pill" });
        }
    }, [isAuth]);

    const handleCredentialResponse = (response) => {
        const payload = JSON.parse(atob(response.credential.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
        if(payload.email.toLowerCase() === ALLOWED_EMAIL.toLowerCase()) { setIsAuth(true); S.save('auth_status', true); } 
        else { alert("Geen toegang!"); }
    };

    if (!isAuth) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-[#000a14]">
                <div className="bg-white/5 p-12 rounded-3xl border border-white/10 shadow-2xl flex flex-col items-center backdrop-blur-xl">
                    <Ico.Lock /><h1 className="text-2xl font-black mt-6 mb-8 text-white tracking-widest uppercase text-center">Michael Dashboard<br/><span className="text-[10px] opacity-40">Beveiligde Toegang</span></h1>
                    <div id="google-btn"></div>
                </div>
            </div>
        );
    }

    return (
        <div className="flex flex-col min-h-screen pb-20">
            <header className="px-6 py-10 max-w-[1600px] mx-auto w-full flex justify-between items-end border-b border-white/10 mb-10">
                <div><h1 className="text-3xl font-black text-white tracking-tighter uppercase leading-none">Michael Dashboard</h1><p className="text-blue-400 text-[10px] font-black uppercase tracking-[0.5em] mt-3">Live Intelligence System</p></div>
                <div className="flex gap-3">
                    <button onClick={() => {setIsAuth(false); S.remove('auth_status'); window.location.reload();}} className="p-3 bg-red-500/10 text-red-500 rounded-2xl hover:bg-red-500/20 transition backdrop-blur-sm"><Ico.Lock /></button>
                    <button onClick={() => setSettingsOpen(true)} className="p-3 bg-white/10 text-white rounded-2xl hover:bg-white/20 transition"><Ico.Set /></button>
                </div>
            </header>
            <main className="px-6 max-w-[1600px] mx-auto w-full grid grid-cols-12 gap-8">
                <div className="col-span-12 lg:col-span-8"><AgendaWidget /></div>
                <div className="col-span-12 lg:col-span-4"><CryptoWidget /></div>
            </main>
            <Settings isOpen={settingsOpen} onClose={() => setSettingsOpen(false)} />
        </div>
    );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>