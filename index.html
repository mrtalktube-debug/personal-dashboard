<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Dashboard - Michael</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/NLqKzZ4C/nieuw-schaap-logo1.png">

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --p-blue: #0073b1; --bg: linear-gradient(135deg, #001a33 0%, #000a14 100%); }
        body { background: var(--bg); min-height: 100vh; font-family: 'Inter', sans-serif; margin: 0; color: #1a1a1a; }
        .widget { background: rgba(255,255,255,0.98); border-radius: 6px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .tab-btn { font-size: 0.65rem; font-weight: 800; padding: 10px; color: #666; border-bottom: 2px solid transparent; text-transform: uppercase; flex: 1; transition: 0.2s; text-align: center; cursor: pointer; }
        .tab-btn.active { color: var(--p-blue); border-bottom-color: var(--p-blue); background: rgba(0,115,177,0.05); }
        .border-r-thick { border-right: 2px solid #1a1a1a !important; }
        .border-b-thick { border-bottom: 2px solid #1a1a1a !important; }
        .settings-panel { position: fixed; right: 0; top: 0; height: 100vh; width: 100%; max-width: 480px; background: white; z-index: 100; box-shadow: -10px 0 30px rgba(0,0,0,0.5); transform: translateX(100%); transition: 0.3s ease; overflow-y: auto; }
        .settings-panel.open { transform: translateX(0); }
        .sparkline-bg { position: absolute; bottom: 0; left: 0; right: 0; height: 40px; opacity: 0.08; background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 100 30" xmlns="http://www.w3.org/2000/svg"><path d="M0 30 L10 20 L20 25 L30 15 L40 18 L50 5 L60 10 L70 2 L80 12 L90 5 L100 0 L100 30 Z" fill="%230073b1"/></svg>'); background-size: cover; background-position: bottom; pointer-events: none; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--p-blue); border-radius: 4px; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .ai-transition { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useMemo } = React;

const GOOGLE_CLIENT_ID = "196901777247-3ak09abjpa3dm5908a5f8m08d4o7gqj8.apps.googleusercontent.com";
const ALLOWED_EMAIL = "diabaas3@gmail.com"; 

const S = {
    load: (k, d) => { try { const v = localStorage.getItem('d_'+k); return v ? JSON.parse(v) : d; } catch(e) { return d; } },
    save: (k, v) => localStorage.setItem('d_'+k, JSON.stringify(v)),
    remove: (k) => localStorage.removeItem('d_'+k)
};

const emitCmd = (type, payload) => window.dispatchEvent(new CustomEvent('dashCmd', { detail: { type, payload } }));
const fmtDate = (dStr) => { const p = dStr.split('-'); return p.length===3 ? `${p[2]}-${p[1]}-${p[0]}` : dStr; };

const T = {
    nl: { port: 'Portfolio', ag: 'Agenda', nws: 'Nieuws', rad: 'Investeringen', deal: 'Pepper Deals', rec: 'Recepten', lang: 'Talen', day: 'DAG', wk: 'WEEK', src: 'BRON', blk: 'BLOCK', cal: 'Kalender', std: 'Stand', lst: 'Laatste', new: 'Nieuw Spel' },
    en: { port: 'Portfolio', ag: 'Schedule', nws: 'News', rad: 'Investments', deal: 'Deals', rec: 'Recipes', lang: 'Languages', day: 'DAY', wk: 'WEEK', src: 'SOURCE', blk: 'BLOCK', cal: 'Calendar', std: 'Standings', lst: 'Latest', new: 'New Game' }
};

const Ico = {
    Set: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>,
    Wea: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>,
    Loc: () => <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
    Bot: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>,
    Cry: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>,
    Cal: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>,
    Nws: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>,
    Rad: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>,
    Tag: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>,
    F1: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/></svg>,
    Glf: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path strokeWidth="2" d="M12 18a6 6 0 100-12 6 6 0 000 12z"/></svg>,
    Trp: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 4v2a4 4 0 01-8 0V4m12 4v2a4 4 0 01-1 2.652M4 8v2a4 4 0 001 2.652M12 20v-4m0 0V11m0 5h-4m4 0h4" /></svg>,
    Clip: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>,
    Up: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M5 15l7-7 7 7"/></svg>,
    Dn: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" d="M19 9l-7 7-7-7"/></svg>,
    Drag: () => <svg className="w-4 h-4 text-gray-400 cursor-move" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 8h16M4 16h16" /></svg>,
    Lock: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/></svg>
};

function WeatherBar({ lang }) {
    const [c, setC] = useState(S.load('wcity', 'Zoetermeer'));
    const [w, setW] = useState(null);
    const [locLoading, setLocLoading] = useState(false);
    const [autoGps, setAutoGps] = useState(S.load('auto_gps', true));
    
    const [isEditing, setIsEditing] = useState(false);
    const [editVal, setEditVal] = useState('');

    useEffect(() => { 
        const h = (e) => { 
            if(e.detail.type === 'SET_CITY') { 
                setC(e.detail.payload); 
                S.save('wcity', e.detail.payload);
                setAutoGps(false); 
                S.save('auto_gps', false);
            }
        }; 
        window.addEventListener('dashCmd', h); 
        return () => window.removeEventListener('dashCmd', h); 
    }, []);

    const handleLocate = (silent = false) => {
        if(!navigator.geolocation) {
            if(!silent) alert('Geolocatie wordt niet ondersteund door je browser.');
            return;
        }
        setLocLoading(true);
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const { latitude, longitude } = pos.coords;
            try {
                const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=${lang}`);
                const data = await res.json();
                const newCity = data.city || data.locality || 'Huidige Locatie';
                setC(newCity);
                S.save('wcity', newCity);
                setAutoGps(true);
                S.save('auto_gps', true);
            } catch(e) { console.error("Locatiefout:", e); }
            setLocLoading(false);
        }, () => {
            if(!silent) alert('Toegang tot locatie geweigerd.');
            setLocLoading(false); setAutoGps(false); S.save('auto_gps', false);
        });
    };

    useEffect(() => { if (autoGps) handleLocate(true); }, []);
    
    useEffect(() => {
        if (!c) return;
        fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(c)}&format=json&limit=1`)
        .then(r=>r.json())
        .then(d=>{
            if(d && d.length > 0){
                const { lat, lon, name } = d[0];
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,precipitation,weather_code&hourly=precipitation_probability&timezone=auto`)
                .then(r=>r.json()).then(wd => { 
                    const ch=new Date().getHours(); 
                    let rf=null; 
                    for(let i=ch; i<ch+12; i++) { 
                        if(wd.hourly && wd.hourly.precipitation_probability[i]>30){rf=i-ch;break;} 
                    } 
                    setW({ t: Math.round(wd.current.temperature_2m), f: Math.round(wd.current.apparent_temperature), code: wd.current.weather_code || wd.current.weathercode, rain: rf, name: name }); 
                });
            } else {
                setW(prev => ({ ...prev, name: "Niet gevonden" }));
            }
        }).catch(() => setW(prev => ({ ...prev, name: "Error" })));
    }, [c, lang]);

    const WxIco = ({ code }) => {
        if (code === undefined || code === null) return <Ico.Wea />; 
        // 0: Helder (Zon)
        if (code === 0) return <svg className="w-4 h-4 shrink-0 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" strokeWidth="2"/><path strokeWidth="2" strokeLinecap="round" d="M12 2v2m0 16v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M2 12h2m16 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>; 
        // 1, 2: Deels bewolkt (Zon + Wolk)
        if (code === 1 || code === 2) return <svg className="w-4 h-4 shrink-0 text-yellow-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="17" cy="7" r="3"></circle><path d="M17 2v2M22 7h-2M13.5 10.5l-1.5-1.5M20.5 3.5l-1.5 1.5M10.4 14.6a4.5 4.5 0 1 0 7.4-4.2A5.5 5.5 0 0 0 3 15.5 4.5 4.5 0 0 0 7.5 20h8"></path></svg>;
        // 3: Bewolkt (Wolk)
        if (code === 3) return <svg className="w-4 h-4 shrink-0 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/></svg>; 
        // 45, 48: Mist
        if (code === 45 || code === 48) return <svg className="w-4 h-4 shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" d="M4 8h16M4 12h16M4 16h16"/></svg>;
        // 51-57: Lichte regen / Motregen
        if (code >= 51 && code <= 57) return <svg className="w-4 h-4 shrink-0 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M16 13v8m-4-6v8m-4-6v8m9-10.9A5 5 0 107.1 8a6 6 0 1010.9 3.1z"/></svg>;
        // 61-67, 80-82: Regen
        if ((code >= 61 && code <= 67) || (code >= 80 && code <= 82)) return <svg className="w-4 h-4 shrink-0 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M16 13v8m-4-6v8m-4-6v8m9-10.9A5 5 0 107.1 8a6 6 0 1010.9 3.1z"/></svg>; 
        // 71-77, 85, 86: Sneeuw
        if ((code >= 71 && code <= 77) || code === 85 || code === 86) return <svg className="w-4 h-4 shrink-0 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M12 2v20m5.5-15.5l-11 11m0-11l11 11"/></svg>; 
        // 95-99: Onweer
        if (code >= 95) return <svg className="w-4 h-4 shrink-0 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>; 
        return <Ico.Wea />; 
    };

    const saveCity = (val) => {
        if(val && val.trim() !== "") {
            setC(val.trim()); S.save('wcity', val.trim()); setAutoGps(false); S.save('auto_gps', false);
        }
        setIsEditing(false);
    };

    return (
        <div className="bg-white/5 px-2 md:px-10 py-2.5 border-b border-white/10 flex items-center text-white text-xs font-bold uppercase tracking-widest overflow-hidden w-full">
            <div className="flex gap-2 sm:gap-4 items-center shrink-0 w-full">
                
                <div className="flex items-center gap-1.5 shrink-0 bg-black/20 px-2 py-1.5 rounded-lg border border-white/5 max-w-[45%]">
                    <div 
                        className="flex items-center gap-1.5 cursor-pointer hover:text-blue-300 transition flex-1 min-w-0" 
                        onClick={() => { setIsEditing(true); setEditVal(''); }}
                    >
                        <WxIco code={w?.code} />
                        {isEditing ? (
                            <input 
                                autoFocus
                                type="text" 
                                placeholder={c}
                                value={editVal} 
                                onChange={e=>setEditVal(e.target.value)} 
                                onBlur={() => saveCity(editVal)}
                                onKeyDown={e => e.key === 'Enter' && saveCity(editVal)}
                                className="bg-transparent border-b border-blue-400 outline-none w-full text-white text-xs p-0 m-0 placeholder-white/30"
                            />
                        ) : (
                            <span className="truncate block">{w?.name || c}</span>
                        )}
                    </div>
                    <div className="w-px h-3 bg-white/20 mx-0.5 shrink-0"></div>
                    <button onClick={() => handleLocate(false)} className={`p-1 bg-white/10 rounded hover:bg-white/20 transition shrink-0 ${locLoading ? 'animate-pulse text-blue-300' : autoGps ? 'text-blue-400' : 'text-gray-400'}`} title="Gebruik huidige locatie (GPS)">
                        <Ico.Loc />
                    </button>
                </div>
                
                <div className="flex gap-1.5 items-center shrink-0 bg-black/20 px-2 py-1.5 rounded-lg border border-white/5">
                    <span className="text-sm md:text-base">{w?.t !== undefined ? `${w.t}¬∞C` : '...'}</span>
                    <span className="opacity-40 font-normal">|</span>
                    <span className="opacity-70 text-[10px] whitespace-nowrap">
                        <span className="hidden sm:inline">{lang==='nl'?'Gevoel: ':'Feels: '}</span>
                        {w?.f !== undefined ? `${w.f}¬∞C` : '...'}
                    </span>
                </div>
                
                {w?.rain !== null && w?.rain !== undefined && w.rain <= 1 && (
                    <div className="bg-[#0073b1]/40 border border-[#0073b1]/50 px-2 py-1.5 rounded-lg flex items-center gap-1.5 shrink-0 ml-auto">
                        <span className="w-2 h-2 bg-blue-300 rounded-full animate-pulse shrink-0"></span>
                        <span className="hidden sm:inline">
                            {w.rain === 0 ? (lang==='nl'?"Nu regen":"Raining") : (lang==='nl'?`Regen over ${w.rain}u`:`Rain in ${w.rain}h`)}
                        </span>
                        <span className="sm:hidden text-[10px]">
                            {w.rain === 0 ? "Regen" : `${w.rain}U`}
                        </span>
                    </div>
                )}
            </div>
        </div>
    );
}

function AIWidget({ lang }) {
    const [msg, setMsg] = useState('');
    const [loading, setLoading] = useState(false);
    const [attachedFile, setAttachedFile] = useState(null);
    const fileRef = useRef(null);
    const chatContainerRef = useRef(null);
    const lastUserMsgRef = useRef(null);
    const prevHistLen = useRef(0);

    const defaultHist = []; 
    
    const [sessions, setSessions] = useState(() => {
        try { return S.load('michael_sessions', []); } catch(e) { return []; }
    });
    const [activeSession, setActiveSession] = useState(null);
    const [hist, setHist] = useState(() => {
        try {
            const saved = S.load('ai_hist', null);
            if(saved && Array.isArray(saved) && saved.length > 0) {
                if(saved[0]?.t?.includes('Gemini') || saved[0]?.t?.includes('OpenRouter') || saved[0]?.t?.includes('Spark') || saved[0]?.t?.includes('MICHAEL AI')) return defaultHist;
                return saved;
            }
            return defaultHist;
        } catch(e) { return defaultHist; }
    });

    const [view, setView] = useState('chat');
    const [exp, setExp] = useState(false);

    const syncToCloud = () => {
        const cloudSettings = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('d_')) {
                cloudSettings[key.substring(2)] = JSON.parse(localStorage.getItem(key));
            }
        }
        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: ALLOWED_EMAIL, settings: cloudSettings })
        }).catch(()=>{});
    };

    useEffect(() => {
        if (exp && hist.length > prevHistLen.current) {
            setTimeout(() => {
                if (chatContainerRef.current && lastUserMsgRef.current) {
                    const container = chatContainerRef.current;
                    const target = lastUserMsgRef.current;
                    container.scrollTo({ top: target.offsetTop - container.offsetTop - 16, behavior: 'smooth' });
                }
            }, 100);
        }
        prevHistLen.current = hist.length;
    }, [hist.length, exp]);

    const handleFile = (e) => {
        const file = e.target.files[0]; if(!file) return;
        const isImg = file.type.startsWith('image/');
        const reader = new FileReader();
        reader.onload = (ev) => setAttachedFile({name: file.name, type: isImg?'image':'text', content: ev.target.result});
        if(isImg) reader.readAsDataURL(file); else reader.readAsText(file);
    };

    const deleteMsg = (idx, e) => {
        e.stopPropagation();
        const n = hist.filter((_,i)=>i!==idx);
        setHist(n); S.save('ai_hist', n.map(m=>({r:m.r, t:m.t})));
        syncToCloud();
    };

    const saveCurrentSession = () => {
        if(hist.length <= 1) return;
        const title = hist.find(m=>m.r==='usr')?.t?.slice(0,40) || 'Chat';
        const session = {id: Date.now(), title, date: new Date().toLocaleDateString('nl-NL'), msgs: hist.map(m=>({r:m.r, t:m.t}))};
        const updated = [session, ...sessions].slice(0, 20);
        setSessions(updated); S.save('michael_sessions', updated);
        syncToCloud();
    };
    const newChat = () => {
        saveCurrentSession();
        setHist(defaultHist); S.save('ai_hist', defaultHist);
        setActiveSession(null); setView('chat');
        syncToCloud();
    };
    const loadSession = (session) => {
        saveCurrentSession();
        setHist(session.msgs); S.save('ai_hist', session.msgs);
        setActiveSession(session.id); setView('chat');
    };
    const deleteSession = (id, e) => {
        e.stopPropagation();
        const updated = sessions.filter(s=>s.id!==id);
        setSessions(updated); S.save('michael_sessions', updated);
        syncToCloud();
    };

    const tryDashboardCommand = (input) => {
        const low = input.toLowerCase().replace(/[?!.,'"]/g, '');
        
        if(/\b(weer|weather|temperatuur|graden|locatie)\b/.test(low)) {
            let city = null;
            const match = low.match(/(?:naar|in|op|voor|van|to|for|at|of)\s+([a-z√†-√ø\s-]+)/i);
            if (match && match[1]) { city = match[1].replace(/\b(de|het|een|the|a|locatie|location)\b/gi, '').trim(); } 
            else { city = low.replace(/\b(pas|het|weer|aan|verander|toon|laat|zien|huidige|locatie|temperatuur|graden|wat|is|hoe|van|de|een)\b/gi, '').trim(); }
            if (city && city.length >= 2) {
                const cleanCity = city.split(/\s+/).filter(Boolean).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                emitCmd('SET_CITY', cleanCity);
                return lang === 'nl' ? `‚úÖ Weerlocatie aangepast naar **${cleanCity}**.` : `‚úÖ Weather location set to **${cleanCity}**.`;
            }
            return null;
        }
        if(/\b(agenda|schedule|kalender|calendar)\b/.test(low)) {
            const m = low.match(/(?:van|voor|of|for)\s+([a-z√†-√ø]+)/i);
            if(m) { emitCmd('SET_AGENDA', m[1].trim()); return lang==='nl'?`‚úÖ Agenda gefilterd op ${m[1].trim()}.`:`‚úÖ Schedule filtered for ${m[1].trim()}.`; }
        }
        if(/\b(nieuws|news)\b/.test(low)) {
            const m = low.match(/(?:over|about|van|of)\s+([a-z√†-√ø0-9\s]+)/i);
            if(m) { emitCmd('SET_NEWS', m[1].trim()); return lang==='nl'?`‚úÖ Nieuws gefilterd op ${m[1].trim()}.`:`‚úÖ News filtered for ${m[1].trim()}.`; }
        }
        if(/\b(sport|resultat|f1|formula|voetbal|football|race)\b/.test(low)) {
            const m = low.match(/(?:van|for|over|about)\s+([a-z√†-√ø0-9\s]+)/i);
            const q = m ? m[1].trim() : 'verstappen';
            emitCmd('SET_SPORTS', q);
            return lang==='nl'?`‚úÖ Sport gefilterd op ${q}.`:`‚úÖ Sports filtered for ${q}.`;
        }
        return null;
    };

    const send = async () => {
        if(!msg.trim() && !attachedFile) return;
        let displayMsg = msg.trim();
        if(attachedFile) displayMsg = `[Bijgevoegd: ${attachedFile.name}]\n${displayMsg}`;
        
        const n = [...hist, {r:'usr', t: displayMsg, file: attachedFile}];
        setHist(n); S.save('ai_hist', n.map(m=>({r:m.r, t:m.t})));
        setMsg(''); setAttachedFile(null); 
        if(fileRef.current) fileRef.current.value = '';

        const cmdResult = tryDashboardCommand(displayMsg);
        if(cmdResult) {
            setTimeout(() => {
                const r = [...n, {r:'ai', t: cmdResult}];
                setHist(r); S.save('ai_hist', r.map(m=>({r:m.r, t:m.t})));
                syncToCloud();
            }, 400);
            return;
        }

        const groqKey = S.load('api_keys_dyn', []).find(a => a.name.toLowerCase().includes('groq'))?.val;
        if(!groqKey) {
            setTimeout(() => {
                const r = [...n, {r:'ai', t: lang==='nl'?'‚ö†Ô∏è Geen Groq key gevonden. Ga naar Instellingen ‚Üí API Keys ‚Üí voeg een key toe met naam **Groq**.':'‚ö†Ô∏è No Groq key found.'}];
                setHist(r); S.save('ai_hist', r.map(m=>({r:m.r, t:m.t})));
                syncToCloud();
            }, 400);
            return;
        }

        setLoading(true);
        const system = {role:'system', content: lang==='nl'
            ? 'Je bent een snelle en behulpzame AI-assistent in een persoonlijk dashboard. Antwoord beknopt en direct in het Nederlands. Vermijd onnodige introducties.'
            : 'You are a fast AI assistant in a personal dashboard. Answer concisely.'
        };
        const recent = n.slice(-8).map(m => {
            if(m.r==='usr' && m.file?.type==='text') return {role:'user', content:`Bestand ${m.file.name}:\n${m.file.content.slice(0,3000)}\n\n${m.t.replace(/\[Bijgevoegd:.*?\]\n/,'')}`};
            if(m.r==='usr' && m.file?.type==='image') return {role:'user', content:[
                {type:'text', text: m.t.replace(/\[Bijgevoegd:.*?\]\n/,'') || 'Beschrijf deze afbeelding.'},
                {type:'image_url', image_url:{url: m.file.content}}
            ]};
            return {role: m.r==='usr'?'user':'assistant', content: m.t};
        });

        try {
            let useModel = attachedFile?.type === 'image' ? 'llama-3.2-11b-vision-preview' : 'llama-3.3-70b-versatile';
            const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method:'POST',
                headers:{'Authorization':`Bearer ${groqKey}`, 'Content-Type':'application/json'},
                body: JSON.stringify({model: useModel, messages: [system, ...recent], temperature: 0.7, max_tokens: 2048})
            });
            const data = await res.json();
            if(data.choices?.[0]?.message?.content) {
                const r = [...n, {r:'ai', t: data.choices[0].message.content}];
                setHist(r); S.save('ai_hist', r.map(m=>({r:m.r, t:m.t})));
                syncToCloud();
            } else if(data.error) {
                const r = [...n, {r:'ai', t: `‚ö†Ô∏è API Error: ${data.error.message}`}];
                setHist(r); S.save('ai_hist', r.map(m=>({r:m.r, t:m.t})));
                syncToCloud();
            }
        } catch(e) {
            const r = [...n, {r:'ai', t:'‚ö†Ô∏è Netwerkfout. Check je verbinding.'}];
            setHist(r); S.save('ai_hist', r.map(m=>({r:m.r, t:m.t})));
            syncToCloud();
        }
        setLoading(false);
    };

    const lastUserIdx = hist.map(m=>m.r).lastIndexOf('usr');

    return (
        <div className={`widget ai-transition relative ${exp?'h-[450px]':'h-[72px]'} flex flex-col overflow-hidden`}>
            <div className="p-4 bg-white border-b flex justify-between items-center cursor-pointer shrink-0 z-20" onClick={()=>setExp(true)}>
                <div className="flex items-center gap-2">
                    <img src="https://i.postimg.cc/NLqKzZ4C/nieuw-schaap-logo1.png" alt="AI Logo" className="w-8 h-8 object-contain mix-blend-multiply" />
                </div>
                {exp ? (
                    <div className="flex items-center gap-2">
                        <button onClick={e=>{e.stopPropagation();setView(view==='history'?'chat':'history')}} className={`px-2.5 py-1 rounded-full text-[9px] font-bold transition ${view==='history'?'bg-blue-100 text-blue-700':'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>
                            {view==='history'?'‚Üê Chat':'üìã Historie'}
                        </button>
                        {view==='chat' && <button onClick={e=>{e.stopPropagation();newChat()}} className="px-2.5 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-[9px] font-bold text-gray-500 transition">+ Nieuw</button>}
                        <button onClick={e=>{e.stopPropagation();setExp(false)}} className="text-gray-400 hover:text-gray-800 transition font-bold text-lg ml-1">√ó</button>
                    </div>
                ) : <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Openen ‚ñº</div>}
            </div>

            {exp && view === 'chat' && (
                <>
                    <div ref={chatContainerRef} className="flex-1 overflow-y-auto p-4 space-y-4 hide-scroll relative" style={{overscrollBehavior:'contain'}}>
                        {hist.map((m,i) => {
                            const isAi = m.r === 'ai';
                            return (
                                <div key={i} ref={i === lastUserIdx ? lastUserMsgRef : null} className={`flex flex-col ${isAi?'items-start':'items-end'} group relative`}>
                                    <div className="flex items-start gap-1.5 max-w-[95%]">
                                        {!isAi && <button onClick={(e)=>deleteMsg(i, e)} className="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition mt-2 text-[10px]">‚úï</button>}
                                        <div className={`px-4 py-2.5 rounded-2xl text-[13.5px] leading-relaxed shadow-sm whitespace-pre-wrap transition ${isAi?'bg-[#f0f4f9] text-gray-800 rounded-bl-sm':'bg-[#0b57d0] text-white rounded-br-sm'}`}>
                                            {m.t.includes('[Bijgevoegd:') && <div className="text-[10px] opacity-60 mb-1.5 pb-1 border-b border-current/20 italic">üìé {m.t.split('\n')[0].replace('[Bijgevoegd: ','').replace(']','')}</div>}
                                            {m.t.replace(/\[Bijgevoegd:.*?\]\n/,'')}
                                        </div>
                                        {isAi && <button onClick={(e)=>deleteMsg(i, e)} className="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition mt-2 text-[10px]">‚úï</button>}
                                    </div>
                                </div>
                            );
                        })}
                        {loading && (
                            <div className="flex items-start">
                                <div className="bg-[#f0f4f9] px-4 py-3 rounded-2xl rounded-bl-sm shadow-sm">
                                    <div className="flex gap-1.5"><span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay:'0ms'}}/><span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay:'150ms'}}/><span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay:'300ms'}}/></div>
                                </div>
                            </div>
                        )}
                        <div className="h-4"></div>
                    </div>
                    
                    <div className="p-3 bg-white border-t shrink-0 z-20">
                        {attachedFile && (
                            <div className="flex items-center gap-2 bg-blue-50 border border-blue-100 text-blue-700 text-[10px] font-bold px-3 py-1.5 rounded-lg w-fit mb-2 shadow-sm">
                                üìé {attachedFile.name}
                                <button onClick={()=>setAttachedFile(null)} className="hover:text-red-500 ml-1">√ó</button>
                            </div>
                        )}
                        <div className="flex items-center gap-2 bg-[#f0f4f9] rounded-full p-1.5 pl-3 border border-transparent focus-within:border-gray-300 transition shadow-inner">
                            <input type="file" ref={fileRef} accept="image/*,text/*,.pdf,.csv,.json" onChange={handleFile} className="hidden"/>
                            <button onClick={()=>fileRef.current.click()} className="text-gray-400 hover:text-gray-800 transition p-0.5" title="Bestand of Foto toevoegen">
                                <Ico.Clip/>
                            </button>
                            <input value={msg} onChange={e=>setMsg(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}}} placeholder={lang==='nl'?'Vraag of commando...':'Question or command...'} className="flex-1 bg-transparent text-[13px] outline-none px-2 text-gray-800 placeholder-gray-400" disabled={loading}/>
                            
                            <div className="flex items-center gap-1 bg-white rounded-full p-1 shadow-sm border border-gray-100 pr-1 pl-1">
                                <button onClick={send} disabled={loading || (!msg.trim() && !attachedFile)} className={`flex items-center justify-center w-8 h-8 rounded-full transition shrink-0 ${msg.trim()||attachedFile?'bg-[#0b57d0] text-white shadow-md hover:bg-blue-800':'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>
                                    <svg className="w-4 h-4 ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </>
            )}

            {exp && view === 'history' && (
                <div className="flex-1 overflow-y-auto p-4 space-y-2 hide-scroll">
                    {sessions.length === 0 ? (
                        <div className="flex-1 flex items-center justify-center text-gray-400 text-xs font-bold h-full">
                            {lang==='nl'?'Nog geen opgeslagen chats.':'No saved chats yet.'}
                        </div>
                    ) : sessions.map(s => (
                        <div key={s.id} onClick={()=>loadSession(s)} className={`p-3 rounded-lg border cursor-pointer transition hover:border-gray-300 hover:bg-gray-50 ${activeSession===s.id?'border-gray-400 bg-gray-50':'border-gray-100 bg-white'}`}>
                            <div className="flex justify-between items-start">
                                <div className="flex-1 min-w-0">
                                    <div className="text-xs font-bold text-gray-800 truncate">{s.title}</div>
                                    <div className="text-[10px] text-gray-400 mt-0.5">{s.date} ¬∑ {s.msgs.length} berichten</div>
                                </div>
                                <button onClick={e=>deleteSession(s.id, e)} className="text-gray-300 hover:text-red-500 transition text-xs ml-2 shrink-0">‚úï</button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

function CryptoWidget({ lang }) {
    const [valuta, setValuta] = useState('EUR'); 
    const [exRate, setExRate] = useState(1);
    const [portfolio, setPortfolio] = useState([]);
    const [totalEur, setTotalEur] = useState(0);
    const [loading, setLoading] = useState(true);
    const [err, setErr] = useState('');

    useEffect(() => {
        if(valuta === 'USD') {
            fetch('https://open.er-api.com/v6/latest/EUR')
                .then(r=>r.json()).then(d => setExRate(d.rates.USD))
                .catch(() => setExRate(1.08)); 
        } else {
            setExRate(1);
        }
    }, [valuta]);

    useEffect(() => {
        const fetchBitvavo = async () => {
            const bvKeys = S.load('bitvavo_keys', {pub: '', sec: ''});
            if(!bvKeys || !bvKeys.pub || !bvKeys.sec) {
                setErr(lang==='nl'?'Vul je Bitvavo keys in via Instellingen':'Enter Bitvavo keys in Settings');
                setLoading(false); return;
            }
            try {
                const res = await fetch('/api/bitvavo', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key: bvKeys.pub, secret: bvKeys.sec })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error);

                let calcTotal = 0;
                let combined = data.balances.map(b => {
                    const amount = parseFloat(b.available) + parseFloat(b.inOrder);
                    if(b.symbol === 'EUR') { 
                        calcTotal += amount; 
                        return { sym: 'EUR', amount, price: 1, val: amount, tr: {d: 0, w: 0, m: 0, y: 0, sparkline: ''} }; 
                    }
                    const priceObj = data.prices.find(p => p.market === `${b.symbol}-EUR`);
                    const price = priceObj ? parseFloat(priceObj.price) : 0;
                    const val = amount * price;
                    calcTotal += val;
                    return { sym: b.symbol, amount, price, val, tr: {d: 0, w: 0, m: 0, y: 0, sparkline: ''} };
                }).filter(b => b.val > 0).sort((a,b) => b.val - a.val);

                setPortfolio(combined); 
                setTotalEur(calcTotal); 
                setErr('');

                try {
                    const t24Res = await fetch('https://api.bitvavo.com/v2/ticker/24h');
                    const t24Data = await t24Res.json();
                    
                    combined = combined.map(coin => {
                        if(coin.sym === 'EUR') return coin;
                        const t = t24Data.find(x => x.market === `${coin.sym}-EUR`);
                        if(t && parseFloat(t.open) > 0) {
                            coin.tr.d = ((parseFloat(t.last) - parseFloat(t.open)) / parseFloat(t.open)) * 100;
                        }
                        return coin;
                    });
                    setPortfolio([...combined]);

                    combined.forEach(async (coin) => {
                        if(coin.sym === 'EUR') return;
                        try {
                            const cRes = await fetch(`https://api.bitvavo.com/v2/${coin.sym}-EUR/candles?interval=1d&limit=366`);
                            const candles = await cRes.json();
                            
                            const hRes = await fetch(`https://api.bitvavo.com/v2/${coin.sym}-EUR/candles?interval=1h&limit=24`);
                            const hCandles = await hRes.json();

                            setPortfolio(prev => {
                                const nw = [...prev];
                                const matchIdx = nw.findIndex(x => x.sym === coin.sym);
                                if(matchIdx > -1) {
                                    if(Array.isArray(candles) && candles.length > 0) {
                                        const curPrice = parseFloat(candles[0][4]);
                                        const getTr = (d) => candles.length > d ? ((curPrice - parseFloat(candles[d][4])) / parseFloat(candles[d][4])) * 100 : 0;
                                        nw[matchIdx].tr.w = getTr(7);
                                        nw[matchIdx].tr.m = getTr(30);
                                        nw[matchIdx].tr.y = getTr(365);
                                    }
                                    if(Array.isArray(hCandles) && hCandles.length > 0) {
                                        const closes = hCandles.map(c => parseFloat(c[4])).reverse();
                                        const min = Math.min(...closes);
                                        const max = Math.max(...closes);
                                        const range = max - min || 1;
                                        nw[matchIdx].tr.sparkline = closes.map((v, idx) => {
                                            const x = (idx / (closes.length - 1)) * 40;
                                            const y = 20 - (((v - min) / range) * 20);
                                            return `${x},${y}`;
                                        }).join(' ');
                                    }
                                }
                                return nw;
                            });
                        } catch(e) {}
                    });
                } catch (e) { console.error("Trends ophalen mislukt:", e); }

            } catch (error) { setErr(error.message); }
            setLoading(false);
        };
        fetchBitvavo();
    }, [lang]);
    
    const sym = valuta === 'EUR' ? '‚Ç¨' : '$';
    const displayTotal = totalEur * exRate;
    const totalTrend = portfolio.reduce((acc, c) => acc + (c.tr.d * (c.val / (totalEur || 1))), 0);
    const totalColor = totalTrend >= 0 ? 'text-green-600' : 'text-red-600';

    return (
        <div className="widget h-[450px] flex flex-col">
            <div className="p-4 bg-gray-50 border-b flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2 text-gray-500"><Ico.Cry/><h3 className="text-[10px] font-black uppercase tracking-widest">Live Bitvavo</h3></div>
                <div className="flex gap-1 bg-gray-200 p-1 rounded">
                    {['EUR', 'USD'].map(v => (
                        <button key={v} onClick={()=>setValuta(v)} className={`px-2 py-0.5 text-[8px] font-bold rounded uppercase ${valuta===v?'bg-white shadow-sm text-blue-700':'text-gray-500'}`}>{v}</button>
                    ))}
                </div>
            </div>
            <div className="p-5 flex-1 flex flex-col bg-white overflow-hidden">
                <div className="mb-4 shrink-0 flex justify-between items-start">
                    <div>
                        <span className="text-[10px] font-bold text-gray-400 block mb-1">TOTAAL WALLET</span>
                        <div className={`text-3xl font-black tracking-tight ${loading || err ? 'text-gray-900' : totalColor}`}>
                            {loading ? '...' : err ? 'Error' : `${sym} ${displayTotal.toLocaleString('nl-NL', {maximumFractionDigits:0})}`}
                        </div>
                    </div>
                </div>
                
                {loading ? <div className="flex-1 flex justify-center items-center text-xs font-bold text-blue-500 animate-pulse">Syncing met Bitvavo API...</div> : 
                 err ? <div className="flex-1 text-[10px] text-red-500 font-bold p-4 bg-red-50 rounded border border-red-100 flex items-center justify-center text-center">{err}</div> :
                 (
                    <div className="space-y-3 overflow-y-auto flex-1 hide-scroll pr-1 pb-2">
                        {portfolio.map((c, i) => {
                            const isPos = c.tr.d >= 0;
                            const bgClass = isPos ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                            const P = ({v}) => <span className={v>=0?'text-green-600':'text-red-600'}>{v>0?'+':''}{(v || 0).toFixed(2)}%</span>;
                            
                            const displayVal = c.val * exRate;
                            const displayPrice = c.price * exRate;
                            const displayUnits = c.amount > 100 ? c.amount.toLocaleString('nl-NL', {maximumFractionDigits: 2}) : c.amount.toLocaleString('nl-NL', {maximumFractionDigits: 6});
                            
                            const defaultSpark = isPos ? "0,20 8,10 16,15 24,5 32,8 40,0" : "0,0 8,10 16,5 24,15 32,12 40,20";

                            return (
                                <div key={i} className={`relative p-3 border rounded-lg flex flex-col shadow-sm transition overflow-hidden ${bgClass}`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="w-1/3">
                                            <span className="font-black text-lg block text-gray-900 leading-none">{c.sym}</span>
                                            <span className="text-[10px] text-gray-600 font-medium mt-1 block">{displayUnits} units</span>
                                        </div>
                                        <div className="w-1/3 flex flex-col items-center justify-center gap-1">
                                            <svg viewBox="0 0 40 20" className="w-10 h-4 overflow-visible">
                                                <polyline points={c.tr.sparkline || defaultSpark} fill="none" stroke={isPos ? '#16a34a' : '#dc2626'} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
                                            </svg>
                                            <span className={`text-xs font-black ${isPos ? 'text-green-600' : 'text-red-600'}`}>{isPos?'+':''}{(c.tr.d || 0).toFixed(2)}%</span>
                                        </div>
                                        <div className="w-1/3 text-right">
                                            <span className={`font-bold text-lg block leading-none ${isPos ? 'text-green-600' : 'text-red-600'}`}>{sym}{displayPrice.toLocaleString('nl-NL', {maximumFractionDigits: displayPrice < 1 ? 4 : 2})}</span>
                                            <span className="text-[10px] text-gray-500 font-mono mt-1 block">Waarde: {sym}{displayVal.toLocaleString('nl-NL',{maximumFractionDigits:0})}</span>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center pt-2 mt-1 border-t border-black/10 text-[9px] font-black uppercase tracking-tighter">
                                        <div>1W: <P v={c.tr.w}/></div>
                                        <div>1M: <P v={c.tr.m}/></div>
                                        <div>1J: <P v={c.tr.y}/></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>
        </div>
    );
}

function AgendaWidget({ lang }) {
    const rawCals = S.load('icals_dyn', [{name: 'Agenda', val: ''}]);
    const cals = (Array.isArray(rawCals)?rawCals:[]).map(c=>c?.name).filter(Boolean);
    
    const getLocalYYYYMMDD = (dateObj) => { return `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`; };
    const todayStr = getLocalYYYYMMDD(new Date());

    const [view, setView] = useState('dag'); 
    const [d, setD] = useState(todayStr); 
    const [f, setF] = useState(cals);
    const [items, setItems] = useState([]);
    const [loading, setLoading] = useState(true);
    const [groupBy, setGroupBy] = useState('person'); 
    
    const getDayStr = (dStr) => { const days = ['zo', 'ma', 'di', 'wo', 'do', 'vr', 'za']; return days[new Date(dStr||todayStr).getDay()]; };

    useEffect(() => { const h = (e) => { if(e.detail.type === 'SET_AGENDA') { const target = cals.find(c => (c||'').toLowerCase().includes((e.detail.payload||'').toLowerCase())); if(target) setF([target]); }}; window.addEventListener('dashCmd', h); return () => window.removeEventListener('dashCmd', h); }, [cals]);
    useEffect(() => { setF(cals); }, [JSON.stringify(cals)]);

    useEffect(() => {
        const fetchCals = async () => {
            setLoading(true);
            let allEvs = [];
            const parseICalDate = (line) => {
                const parts = (line||'').split(':'); if (parts.length < 2) return null;
                const params = parts[0]; const val = parts[parts.length - 1].trim();
                const isUTC = val.endsWith('Z'); const m = val.match(/(\d{4})(\d{2})(\d{2})(?:T(\d{2})(\d{2})(\d{2})?Z?)?/);
                if (!m) return null;
                const year = parseInt(m[1]); const month = parseInt(m[2]) - 1; const day = parseInt(m[3]);
                const hour = m[4] ? parseInt(m[4]) : 0; const min = m[5] ? parseInt(m[5]) : 0; const sec = m[6] ? parseInt(m[6]) : 0;
                const isAllDay = !m[4];
                let dateObj = isUTC ? new Date(Date.UTC(year, month, day, hour, min, sec)) : new Date(year, month, day, hour, min, sec);
                return { date: getLocalYYYYMMDD(dateObj), time: isAllDay ? 'Hele dag' : dateObj.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' }), dateObj, isAllDay };
            };

            for (let c of (Array.isArray(rawCals)?rawCals:[])) {
                if (!c?.val) continue;
                try {
                    const res = await fetch('/api/ical', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: c.val }) });
                    let txt = '';
                    if (res.ok) { if ((res.headers.get('content-type') || '').includes('application/json')) throw new Error('Proxy fout'); txt = await res.text(); } 
                    else throw new Error(`HTTP ${res.status}`);
                    if (!txt || !txt.includes('BEGIN:VCALENDAR')) throw new Error("Geen kalender data");

                    let cur = {}; let rrule = null; const lines = txt.split(/\r?\n/);
                    for (let k = 0; k < lines.length; k++) {
                        let l = lines[k];
                        while (k + 1 < lines.length && (lines[k+1].startsWith(' ') || lines[k+1].startsWith('\t'))) { k++; l += lines[k].substring(1); }
                        if (l.startsWith('BEGIN:VEVENT')) { cur = {}; rrule = null; }
                        else if (l.startsWith('SUMMARY')) { const idx = l.indexOf(':'); if (idx !== -1) cur.t = l.substring(idx + 1).replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, ' ').replace(/\\/g, ''); }
                        else if (l.startsWith('DTSTART')) { const parsed = parseICalDate(l); if (parsed) { cur.date = parsed.date; cur.time = parsed.time; cur.dateObj = parsed.dateObj; } }
                        else if (l.startsWith('DTEND')) { const parsed = parseICalDate(l); if (parsed && !parsed.isAllDay) cur.endTime = parsed.time; }
                        else if (l.startsWith('RRULE:')) { rrule = l; }
                        else if (l.startsWith('END:VEVENT') && cur.t && cur.date) {
                            if (rrule && cur.dateObj) {
                                const expanded = [];
                                const params = {}; rrule.replace('RRULE:', '').split(';').forEach(p => { const [k, v] = p.split('='); params[k] = v; });
                                const freq = params.FREQ; const count = params.COUNT ? parseInt(params.COUNT) : 200;
                                const untilMatch = params.UNTIL ? params.UNTIL.match(/(\d{4})(\d{2})(\d{2})/) : null;
                                const until = untilMatch ? new Date(parseInt(untilMatch[1]), parseInt(untilMatch[2])-1, parseInt(untilMatch[3]), 23, 59, 59) : null;
                                const interval = params.INTERVAL ? parseInt(params.INTERVAL) : 1;
                                const now = new Date(); const rangeStart = new Date(now); rangeStart.setDate(rangeStart.getDate() - 7); 
                                const rangeEnd = new Date(now); rangeEnd.setDate(rangeEnd.getDate() + 60); 
                                let current = new Date(cur.dateObj); let generated = 0;
                                for (let i = 0; i < 500 && generated < count; i++) {
                                    if (until && current > until) break; if (current > rangeEnd) break;
                                    if (current >= rangeStart) { expanded.push({ t: cur.t, p: c.name, time: cur.time, endTime: cur.endTime, date: getLocalYYYYMMDD(current) }); }
                                    generated++;
                                    if (freq === 'DAILY') current.setDate(current.getDate() + interval);
                                    else if (freq === 'WEEKLY') current.setDate(current.getDate() + (7 * interval));
                                    else if (freq === 'MONTHLY') current.setMonth(current.getMonth() + interval);
                                    else if (freq === 'YEARLY') current.setFullYear(current.getFullYear() + interval);
                                    else break; 
                                }
                                allEvs.push(...expanded);
                            } else {
                                allEvs.push({ t: cur.t, p: c.name, date: cur.date, time: cur.time, endTime: cur.endTime });
                            }
                        }
                    }
                } catch (e) { allEvs.push({ t: `‚ö† ${c.name} fout`, p: c.name, date: d, time: '00:00' }); }
            }
            if (allEvs.length === 0) allEvs = [{ t: 'Geen afspraken', p: cals[0] || 'Systeem', date: d, time: '00:00' }];
            setItems(allEvs); setLoading(false);
        };
        fetchCals();
    }, [JSON.stringify(rawCals)]);

    const getColorHex = (name) => {
        if (!name) return '#9ca3af'; 
        const n = String(name).toLowerCase();
        if (n.includes('ryan')) return '#ef4444'; 
        if (n.includes('yaron')) return '#3b82f6'; 
        if (n.includes('michael')) return '#22c55e'; 
        if (n.includes('fam')) return '#f97316'; 
        return '#a855f7'; 
    };

    const safeD = d || todayStr;
    const tEnd = new Date(safeD); tEnd.setDate(tEnd.getDate() + 6); const dEnd = getLocalYYYYMMDD(tEnd);
    
    const getWeekNumber = (dateStr) => { const date = new Date(dateStr); date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay()||7)); return Math.ceil(( ( (date - new Date(Date.UTC(date.getUTCFullYear(),0,1))) / 86400000) + 1)/7); };
    
    const filteredItems = (Array.isArray(items)?items:[]).filter(i => (f||[]).includes(i?.p) && (view === 'dag' ? i?.date === safeD : (i?.date >= safeD && i?.date <= dEnd))).sort((a,b) => {
        if(a.date !== b.date) return String(a.date||'').localeCompare(String(b.date||''));
        const tA = (a.time === 'Hele dag' || !a.time) ? '00:00' : String(a.time); const tB = (b.time === 'Hele dag' || !b.time) ? '00:00' : String(b.time); return tA.localeCompare(tB);
    });

    const getSelectedDaySummary = (name) => {
        const evs = (Array.isArray(items)?items:[]).filter(e => e.date === safeD && (e.p || '').toLowerCase().includes((name||'').toLowerCase()) && e.time !== 'Hele dag');
        if (evs.length === 0) return null;
        const times = []; evs.forEach(e => { if(e.time) times.push(e.time); if(e.endTime) times.push(e.endTime); });
        const sorted = times.sort(); return `${name.toUpperCase()}: ${sorted[0]} - ${sorted[sorted.length - 1]}`;
    };
    
    const sumRyan = getSelectedDaySummary('Ryan'); 
    const sumYaron = getSelectedDaySummary('Yaron');

    const navDateText = view === 'dag' 
        ? `${getDayStr(safeD).toUpperCase()} ${fmtDate(safeD).slice(0,5)}` 
        : `${fmtDate(safeD).slice(0,5)} / ${fmtDate(dEnd).slice(0,5)}`;

    return (
        <div className="widget h-[450px] flex flex-col">
            <div className="p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center shrink-0 flex-wrap gap-2">
                <div className="flex items-center gap-2 text-gray-500 font-black tracking-widest text-[10px] uppercase">
                    <Ico.Cal/> {T[lang].ag}
                </div>
                <div className="flex items-center gap-2">
                    <button onClick={()=>setGroupBy(groupBy==='time'?'person':'time')} className="px-3 py-1.5 bg-white border border-gray-200 shadow-sm text-[9px] font-bold rounded uppercase text-gray-600 hover:text-blue-600 transition">
                        {groupBy === 'time' ? 'Groepeer' : 'Sorteer'}
                    </button>
                    <div className="flex bg-gray-200 p-1 rounded relative z-10">
                        <button onClick={(e)=>{e.preventDefault(); setView('dag');}} className={`px-2 py-1 text-[9px] font-bold rounded ${view==='dag'?'bg-white shadow-sm text-blue-700':'text-gray-500'}`}>{T[lang].day}</button>
                        <button onClick={(e)=>{e.preventDefault(); setView('week');}} className={`px-2 py-1 text-[9px] font-bold rounded ${view==='week'?'bg-white shadow-sm text-blue-700':'text-gray-500'}`}>{T[lang].wk}</button>
                    </div>
                </div>
            </div>
            
            <div className="flex border-b border-gray-200 bg-white overflow-x-auto p-2.5 gap-2.5 hide-scroll shrink-0">
                {cals.map(p => {
                    const isActive = (f||[]).includes(p);
                    return (
                        <button 
                            key={p} 
                            onClick={()=>setF(pr=>pr.includes(p)?pr.filter(x=>x!==p):[...pr, p])} 
                            className={`px-3 py-1.5 text-[10px] font-bold rounded uppercase whitespace-nowrap border border-gray-200 border-l-[4px] transition-all ${isActive ? 'bg-[#f8fafc] text-gray-900 shadow-sm' : 'bg-gray-50 text-gray-400 opacity-70 hover:opacity-100'}`}
                            style={{ borderLeftColor: isActive ? getColorHex(p) : '#d1d5db' }}
                        >
                            {p}
                        </button>
                    );
                })}
            </div>
            
            <div className="p-2.5 flex border-b border-gray-200 bg-gray-50 items-center justify-between shrink-0 gap-2">
                <div 
                    className="relative flex items-center bg-white border border-gray-200 p-1.5 px-2 rounded shadow-sm hover:bg-gray-100 transition cursor-pointer shrink-0"
                    onClick={(e) => {
                        const input = e.currentTarget.querySelector('input');
                        if (input && typeof input.showPicker === 'function') input.showPicker();
                    }}
                >
                    <span className="text-xs pointer-events-none">üìÖ</span>
                    <span className="text-[10px] font-black text-gray-700 ml-1.5 pointer-events-none">{safeD.slice(8,10)}</span>
                    <input type="date" value={safeD} onChange={(e)=>setD(e.target.value)} className="absolute opacity-0 w-0 h-0" />
                </div>
                
                <div className="flex-1 flex items-center justify-between bg-white border border-gray-200 rounded shadow-sm px-1 overflow-hidden min-w-[140px] max-w-[220px]">
                    <button onClick={()=>{const nd=new Date(safeD);nd.setDate(nd.getDate()-(view==='week'?7:1));setD(getLocalYYYYMMDD(nd))}} className="px-3 py-1.5 hover:bg-gray-100 font-bold text-gray-500 transition">&lt;</button>
                    <span className="text-[10px] font-black text-center uppercase tracking-widest text-blue-600 whitespace-nowrap px-1">
                        WK {getWeekNumber(safeD)} <span className="opacity-30 text-gray-400">|</span> <span className="text-gray-700">{navDateText}</span>
                    </span>
                    <button onClick={()=>{const nd=new Date(safeD);nd.setDate(nd.getDate()+(view==='week'?7:1));setD(getLocalYYYYMMDD(nd))}} className="px-3 py-1.5 hover:bg-gray-100 font-bold text-gray-500 transition">&gt;</button>
                </div>

                <button onClick={() => setD(todayStr)} className="px-3 py-1.5 bg-white border border-gray-200 shadow-sm text-[9px] font-bold rounded uppercase text-blue-600 hover:text-blue-800 transition shrink-0">
                    Vandaag
                </button>
            </div>
            
            <div className="flex-1 p-4 bg-white overflow-y-auto content-start">
                {loading ? ( <div className="text-center text-xs font-bold text-blue-500 animate-pulse mt-10">Agenda synchroniseren...</div> ) : filteredItems.length > 0 ? (
                    groupBy === 'time' ? (
                        <div className="grid grid-cols-2 gap-3">
                            {filteredItems.map((i, idx) => (
                                <div key={idx} className="p-3 bg-white border border-gray-200 border-l-[4px] rounded-lg flex flex-col shadow-sm h-fit transition-shadow hover:shadow-md" style={{ borderLeftColor: getColorHex(i.p) }}>
                                    <span className="font-bold text-[12px] leading-tight text-gray-900 mb-2">{i.t||''}</span>
                                    <div className="flex justify-between items-center mt-auto">
                                        <span className="text-[9px] font-black text-gray-400 uppercase tracking-widest">{view==='week' ? `${getDayStr(i.date)} ${fmtDate(i.date).slice(0,5)} ` : ''}{i.p||''}</span>
                                        <span className="text-blue-600 font-bold font-mono text-[9px] bg-blue-50 px-1.5 py-0.5 rounded leading-tight text-right">{i.time||''}{i.endTime ? ` - ${i.endTime}` : ''}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {(f||[]).map(person => {
                                const personItems = filteredItems.filter(i => i.p === person);
                                if (personItems.length === 0) return null;
                                return (
                                    <div key={person} className="flex flex-col">
                                        <div className="text-[10px] font-black uppercase text-gray-800 bg-gray-50 border border-gray-200 border-l-[4px] rounded-sm px-3 py-1.5 mb-2 w-full" style={{ borderLeftColor: getColorHex(person) }}>
                                            {person}
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            {personItems.map((i, idx) => (
                                                <div key={idx} className="p-3 bg-white border border-gray-200 border-l-[4px] rounded-lg flex flex-col shadow-sm h-fit transition-shadow hover:shadow-md" style={{ borderLeftColor: getColorHex(person) }}>
                                                    <span className="font-bold text-[12px] leading-tight text-gray-900 mb-2">{i.t||''}</span>
                                                    <div className="flex justify-between items-center mt-auto">
                                                        <span className="text-[9px] font-black text-gray-400 uppercase">{view==='week' ? `${getDayStr(i.date)} ${fmtDate(i.date).slice(0,5)}` : ''}</span>
                                                        <span className="text-blue-600 font-bold font-mono text-[9px] bg-blue-50 px-1.5 py-0.5 rounded leading-tight text-right">{i.time||''}{i.endTime ? ` - ${i.endTime}` : ''}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )
                ) : ( <div className="col-span-2 text-center text-[10px] text-gray-400 mt-10 font-bold uppercase tracking-widest">Geen afspraken</div> )}
            </div>
            <div className="bg-gray-50 border-t border-gray-200 p-2 shrink-0 flex items-center justify-center min-h-[36px]">
                <div className="flex gap-6 text-[9px] font-black uppercase tracking-widest text-gray-600">{sumRyan && <span>üéí {sumRyan}</span>}{sumYaron && <span>üéí {sumYaron}</span>}</div>
            </div>
        </div>
    );
}

function NewsWidget({ lang }) {
    const [cols, setCols] = useState(S.load('newscats', ['Nieuws', 'Tech', 'Beurs'])); 
    const [manage, setManage] = useState(false);
    const [newsData, setNewsData] = useState({});
    const [search, setSearch] = useState('');
    const [blocked, setBlocked] = useState(S.load('news_blocked', []));
    const [newCol, setNewCol] = useState('');
    const [newBlock, setNewBlock] = useState('');
    const [dragCol, setDragCol] = useState(null);

    useEffect(() => {
        cols.forEach(cat => {
            const isUrl = cat.startsWith('http');
            const rssUrl = isUrl ? cat : `https://news.google.com/rss/search?q=${encodeURIComponent(cat)}&hl=${lang==='nl'?'nl':'en-US'}&gl=${lang==='nl'?'NL':'US'}`;
            fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`)
            .then(r=>r.json()).then(d => { if(d.items) setNewsData(p => ({...p, [cat]: d.items})); })
            .catch(e => console.error(e));
        });
    }, [cols, lang]);

    const addCol = () => { if(newCol && !cols.includes(newCol)) { const n = [...cols, newCol]; setCols(n); S.save('newscats', n); setNewCol(''); } };
    const removeCol = (c) => { const n = cols.filter(x => x !== c); setCols(n); S.save('newscats', n); };
    
    const addBlock = () => { if(newBlock && !blocked.includes(newBlock)) { const n = [...blocked, newBlock]; setBlocked(n); S.save('news_blocked', n); setNewBlock(''); } };
    const removeBlock = (b) => { const n = blocked.filter(x => x !== b); setBlocked(n); S.save('news_blocked', n); };

    const handleDragStart = (e, col) => { setDragCol(col); };
    const handleDrop = (e, col) => {
        if (!dragCol || dragCol === col) return;
        const newCols = [...cols];
        const dragIdx = newCols.indexOf(dragCol);
        const dropIdx = newCols.indexOf(col);
        newCols.splice(dragIdx, 1);
        newCols.splice(dropIdx, 0, dragCol);
        setCols(newCols);
        S.save('newscats', newCols);
        setDragCol(null);
    };

    const formatDate = (pubDate) => {
        if (!pubDate) return '';
        const parts = pubDate.split(' ');
        if(parts.length >= 2 && parts[0].includes('-') && parts[1].includes(':')) {
            const [y,m,d] = parts[0].split('-');
            const [h,min] = parts[1].split(':');
            return `${d}-${m}-${y} | ${h}:${min}`;
        }
        return pubDate;
    };

    return (
        <div className="widget h-[450px]">
            <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                <div className="flex items-center gap-2 text-gray-500">
                    <Ico.Nws/>
                    <h3 className="text-[10px] font-black uppercase tracking-widest">{T[lang].nws}</h3>
                </div>
                <div className="flex gap-2 w-1/2">
                    <input type="text" placeholder={lang==='nl'?"Zoek (bijv. trump, groenland)...":"Search..."} value={search} onChange={e=>setSearch(e.target.value)} className="w-full px-2 py-1 text-[10px] border rounded outline-none focus:border-blue-500 shadow-sm" />
                    <button onClick={()=>setManage(!manage)} className={`px-2 py-1 rounded text-[10px] font-bold ${manage ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}>{manage ? 'Klaar' : 'Beheer'}</button>
                </div>
            </div>
            
            {manage && (
                <div className="p-4 bg-gray-100 border-b flex flex-col gap-3 text-[10px]">
                    <div className="flex gap-2 items-center">
                        <span className="font-bold w-20">Nieuw Topic:</span>
                        <input value={newCol} onChange={e=>setNewCol(e.target.value)} onKeyPress={e=>e.key==='Enter'&&addCol()} className="flex-1 p-1.5 border rounded outline-none" placeholder="Onderwerp, domein of RSS link..." />
                        <button onClick={addCol} className="bg-blue-600 text-white px-3 py-1.5 rounded font-bold hover:bg-blue-700">+</button>
                    </div>
                    <div className="flex gap-2 items-center">
                        <span className="font-bold w-20 text-red-600">Vermijd:</span>
                        <input value={newBlock} onChange={e=>setNewBlock(e.target.value)} onKeyPress={e=>e.key==='Enter'&&addBlock()} className="flex-1 p-1.5 border rounded outline-none" placeholder="Te vermijden bron of woord..." />
                        <button onClick={addBlock} className="bg-red-600 text-white px-3 py-1.5 rounded font-bold hover:bg-red-700">+</button>
                    </div>
                    {blocked.length > 0 && (
                        <div className="flex flex-wrap gap-1 mt-1">
                            {blocked.map(b => <span key={b} className="bg-red-100 text-red-800 px-2 py-1 rounded font-bold flex items-center gap-1">{b} <button onClick={()=>removeBlock(b)} className="text-red-500 hover:text-red-900 ml-1">&times;</button></span>)}
                        </div>
                    )}
                    <span className="text-gray-500 italic mt-1">Slepen (Drag & Drop) is actief voor de kolommen hieronder.</span>
                </div>
            )}

            <div className="flex overflow-x-auto flex-1 bg-white hide-scroll">
                {cols.map(cat => {
                    let items = (newsData[cat] || []).filter(item => {
                        const text = (item.title + " " + (item.source || '') + " " + (item.description || '')).toLowerCase();
                        if (blocked.some(b => text.includes(b.toLowerCase()))) return false;
                        if (search) {
                            const terms = search.toLowerCase().split(',').map(t => t.trim()).filter(Boolean);
                            if (!terms.every(term => text.includes(term))) return false;
                        }
                        return true;
                    });

                    items.sort((a, b) => new Date(b.pubDate.replace(/-/g, '/')) - new Date(a.pubDate.replace(/-/g, '/')));

                    return (
                        <div key={cat} draggable={manage} onDragStart={(e)=>manage && handleDragStart(e, cat)} onDragOver={(e)=>manage && e.preventDefault()} onDrop={(e)=>manage && handleDrop(e, cat)} className={`min-w-[300px] w-[300px] border-r flex flex-col shrink-0 ${manage ? 'cursor-grab active:cursor-grabbing' : ''}`}>
                            <div className="flex justify-between items-center p-3 border-b bg-white sticky top-0">
                                <h4 className="text-[11px] font-black text-blue-600 uppercase truncate pr-2" title={cat}>{cat.startsWith('http') ? 'Custom Feed' : cat}</h4>
                                {manage&&<button onClick={()=>removeCol(cat)} className="text-red-400 font-bold hover:text-red-600 text-lg leading-none">&times;</button>}
                            </div>
                            <div className="space-y-4 p-4 overflow-y-auto flex-1 hide-scroll">
                                {items.slice(0, 15).map((item, i) => {
                                    let cleanDesc = item.description?.replace(/<[^>]+>/g, '').trim() || '';
                                    let sourceName = item.source || '';
                                    let displayTitle = item.title || '';
                                    
                                    const titleParts = displayTitle.split(' - ');
                                    if (titleParts.length > 1) {
                                        const possibleSource = titleParts.pop().trim();
                                        displayTitle = titleParts.join(' - ');
                                        if (!sourceName || sourceName === 'RSS' || sourceName === 'Nieuws') {
                                            sourceName = possibleSource;
                                        }
                                    }
                                    if (!sourceName || sourceName === 'RSS') sourceName = 'Nieuwsbron';

                                    const srcRegex = new RegExp(`[\\-\\|]?\\s*${sourceName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s*$`, 'i');
                                    cleanDesc = cleanDesc.replace(srcRegex, '').trim();

                                    return (
                                    <a href={item.link} target="_blank" key={i} className="block border-b pb-4 hover:bg-gray-50 transition p-1 rounded">
                                        <p className="text-xs font-bold leading-relaxed text-gray-800">{displayTitle}</p>
                                        {cleanDesc && <p className="text-[#1d4ed8] font-bold text-[10px] line-clamp-2 mt-1.5 leading-tight">{cleanDesc}</p>}
                                        <div className="flex justify-between items-center text-[9px] mt-2 uppercase font-black">
                                            <span className="text-[#c586c0]">{sourceName}</span>
                                            <span className="text-gray-400">{formatDate(item.pubDate)}</span>
                                        </div>
                                    </a>
                                )})}
                                {(!newsData[cat]) && <div className="text-xs text-gray-400 text-center mt-10 animate-pulse">Laden...</div>}
                                {(newsData[cat] && items.length === 0) && <div className="text-xs text-gray-400 text-center mt-10">Geen resultaten gevonden.</div>}
                            </div>
                        </div>
                    )
                })}
            </div>
        </div>
    );
}

function RadarWidget({ lang }) {
    const [assets, setAssets] = useState(S.load('inv_assets', ['ASML', 'NVDA', 'MSFT', 'GOOGL', 'AMZN', 'META', 'AAPL', 'NVO']));
    const [manage, setManage] = useState(false);
    const [newAsset, setNewAsset] = useState('');
    const [liveData, setLiveData] = useState({});
    const [loading, setLoading] = useState(true);
    const [tab, setTab] = useState('recs'); 
    const [recs, setRecs] = useState([]);
    const [recsLoading, setRecsLoading] = useState(true);

    useEffect(() => {
        const fetchStockData = async () => {
            try {
                const res = await fetch('/api/stocks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: assets })
                });
                const data = await res.json();
                if (Array.isArray(data)) {
                    const dataMap = {};
                    data.forEach(item => { if (item && item.name) dataMap[item.name] = item; });
                    setLiveData(dataMap);
                }
            } catch (e) { console.error("Beursfout:", e); }
            finally { setLoading(false); }
        };
        fetchStockData();
        const interval = setInterval(fetchStockData, 300000);
        return () => clearInterval(interval);
    }, [assets]);

    useEffect(() => {
        const fetchRecs = async () => {
            setRecsLoading(true);
            try {
                const res = await fetch('/api/stocks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'recommendations' })
                });
                const data = await res.json();
                if (Array.isArray(data)) {
                    setRecs(data);
                }
            } catch (e) { console.error("Aanbevelingen fout:", e); }
            finally { setRecsLoading(false); }
        };
        fetchRecs();
        const interval = setInterval(fetchRecs, 600000);
        return () => clearInterval(interval);
    }, []);

    const addAsset = () => { if(newAsset && !assets.includes(newAsset.toUpperCase().trim())) { const n = [...assets, newAsset.toUpperCase().trim()]; setAssets(n); S.save('inv_assets', n); setNewAsset(''); } };
    const removeAsset = (a) => { const n = assets.filter(x => x !== a); setAssets(n); S.save('inv_assets', n); };

    const P = ({v}) => <span className={v>=0?'text-green-600':'text-red-600'}>{v>0?'+':''}{(v||0).toFixed(2)}%</span>;

    const getScoreColor = (score) => {
        if (score >= 4.3) return 'bg-green-600 text-white';
        if (score >= 3.7) return 'bg-green-500 text-white';
        if (score >= 3.0) return 'bg-yellow-500 text-white';
        if (score >= 2.0) return 'bg-orange-500 text-white';
        return 'bg-red-500 text-white';
    };

    const getConsensusColor = (c) => {
        if (c === 'Strong Buy') return 'text-green-700 bg-green-50 border-green-200';
        if (c === 'Buy') return 'text-green-600 bg-green-50 border-green-100';
        if (c === 'Hold') return 'text-yellow-700 bg-yellow-50 border-yellow-200';
        if (c === 'Sell') return 'text-red-600 bg-red-50 border-red-100';
        return 'text-red-700 bg-red-50 border-red-200';
    };

    const getYahooUrl = (ticker, name) => {
        let t = ticker || name;
        if (t === 'ASML') t = 'ASML.AS';
        if (t === 'NVO') t = 'NOVOB.CO';
        return `https://finance.yahoo.com/quote/${t}`;
    };

    return (
        <div className="widget h-[450px] flex flex-col">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2 text-gray-500"><Ico.Rad/><h3 className="text-[10px] font-black uppercase tracking-widest">Live Beurs</h3></div>
                <div className="flex gap-2 items-center">
                    {tab === 'watch' && (
                        <button onClick={()=>setManage(!manage)} className={`px-2 py-1 rounded text-[10px] font-bold ${manage ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-600'}`}>{manage ? 'Klaar' : 'Beheer'}</button>
                    )}
                </div>
            </div>

            <div className="flex border-b bg-white shrink-0">
                <button onClick={()=>{setTab('recs');setManage(false)}} className={`tab-btn ${tab==='recs'?'active':''}`}>üìä TOP PICKS</button>
                <button onClick={()=>setTab('watch')} className={`tab-btn ${tab==='watch'?'active':''}`}>üëÅ WATCHLIST</button>
            </div>

            {manage && tab === 'watch' && (
                <div className="p-3 bg-gray-100 border-b flex gap-2 shrink-0">
                    <input value={newAsset} onChange={e=>setNewAsset(e.target.value)} onKeyPress={e=>e.key==='Enter'&&addAsset()} className="flex-1 p-1.5 border rounded text-[10px]" placeholder="Ticker (bijv. TSLA, AAPL)" />
                    <button onClick={addAsset} className="bg-blue-600 text-white px-3 rounded font-bold">+</button>
                </div>
            )}

            <div className="p-4 space-y-2 overflow-y-auto flex-1 bg-white hide-scroll">
                {tab === 'recs' && (
                    recsLoading ? (
                        <div className="text-center text-xs text-blue-500 animate-pulse mt-10">Analyst aanbevelingen laden...</div>
                    ) : recs.length === 0 ? (
                        <div className="text-center text-[10px] text-gray-400 mt-10">Geen aanbevelingen gevonden.</div>
                    ) : (
                        <>
                            <div className="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-2 text-center">
                                {recs.length} aandelen geanalyseerd ¬∑ gesorteerd op analyst score
                            </div>
                            {recs.map((r, i) => (
                                <div key={r.name} onClick={() => window.open(getYahooUrl(r.ticker, r.name), '_blank')} className={`p-3 border rounded-lg shadow-sm transition cursor-pointer hover:shadow-md ${r.tr.d >= 0 ? 'bg-green-50/50 border-green-100 hover:border-green-300' : 'bg-red-50/50 border-red-100 hover:border-red-300'}`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex items-center gap-2">
                                            <span className={`text-[9px] font-black px-1.5 py-0.5 rounded ${getScoreColor(r.score)}`}>
                                                {r.score.toFixed(1)}
                                            </span>
                                            <span className="font-black text-sm text-gray-900">{r.name}</span>
                                        </div>
                                        <div className="text-right">
                                            <span className="text-[10px] font-mono font-bold block">${r.price.toFixed(2)}</span>
                                            <span className={`text-[9px] font-bold ${r.tr.d >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                {r.tr.d >= 0 ? '+' : ''}{r.tr.d.toFixed(2)}%
                                            </span>
                                        </div>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className={`text-[9px] font-black px-2 py-0.5 rounded border ${getConsensusColor(r.consensus)}`}>
                                            {r.consensus}
                                        </span>
                                        <div className="flex items-center gap-1">
                                            <div className="flex h-2.5 w-20 rounded overflow-hidden">
                                                {r.detail.strongBuy > 0 && <div className="bg-green-700" style={{width: `${(r.detail.strongBuy/r.analysts)*100}%`}}></div>}
                                                {r.detail.buy > 0 && <div className="bg-green-400" style={{width: `${(r.detail.buy/r.analysts)*100}%`}}></div>}
                                                {r.detail.hold > 0 && <div className="bg-yellow-400" style={{width: `${(r.detail.hold/r.analysts)*100}%`}}></div>}
                                                {r.detail.sell > 0 && <div className="bg-orange-400" style={{width: `${(r.detail.sell/r.analysts)*100}%`}}></div>}
                                                {r.detail.strongSell > 0 && <div className="bg-red-500" style={{width: `${(r.detail.strongSell/r.analysts)*100}%`}}></div>}
                                            </div>
                                            <span className="text-[8px] font-bold text-gray-400">{r.buyPct}% buy ¬∑ {r.analysts} analysts</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </>
                    )
                )}

                {tab === 'watch' && (
                    loading && Object.keys(liveData).length === 0 ? (
                        <div className="text-center text-xs text-blue-500 animate-pulse mt-10">Koersen laden...</div>
                    ) : assets.map((a) => {
                        const data = liveData[a];
                        if (!data) return (
                            <div key={a} className="p-3 border rounded-lg bg-gray-50 flex justify-between items-center">
                                <span className="font-bold text-sm text-gray-400">{a}</span>
                                {manage ? <button onClick={(e)=>{e.stopPropagation(); removeAsset(a)}} className="text-red-500 font-bold text-lg">&times;</button> : 
                                <span className="text-[9px] text-gray-400">Niet gevonden</span>}
                            </div>
                        );
                        const isPos = data.tr.d >= 0;
                        return (
                            <div key={a} onClick={() => !manage && window.open(getYahooUrl(data.ticker, data.name), '_blank')} className={`p-3 border rounded-lg shadow-sm transition ${!manage ? 'cursor-pointer hover:shadow-md' : ''} ${isPos ? 'bg-green-50 border-green-200 hover:border-green-300' : 'bg-red-50 border-red-200 hover:border-red-300'}`}>
                                <div className="flex justify-between items-start mb-1">
                                    <span className="font-black text-sm text-gray-900">{a}</span>
                                    {manage ? <button onClick={(e)=>{e.stopPropagation(); removeAsset(a)}} className="text-red-500 font-bold text-lg">&times;</button> : 
                                    <span className="text-[10px] font-mono font-bold">{data.currency} {data.price.toFixed(2)}</span>}
                                </div>
                                <div className="flex justify-between items-center text-[9px] font-black uppercase tracking-tighter mt-2 border-t border-black/5 pt-2">
                                    <div>1D: <P v={data.tr.d}/></div>
                                    <div>1W: <P v={data.tr.w}/></div>
                                    <div>1M: <P v={data.tr.m}/></div>
                                    <div>1J: <P v={data.tr.y}/></div>
                                </div>
                            </div>
                        );
                    })
                )}
            </div>
        </div>
    );
}

function SportsWidget({ lang }) {
    const [tab, setTab] = useState('lst');
    const [search, setSearch] = useState('');
    const [golfTour, setGolfTour] = useState('PGA');

    const [eF1C, setEF1C] = useState(false);
    const [eF1S, setEF1S] = useState(false);
    const [eF1L, setEF1L] = useState(false);
    
    const [eGC, setEGC] = useState(false);
    const [eGS, setEGS] = useState(false);
    const [eGL, setEGL] = useState(false);

    const f1Data = { 
        c: [ { r: "GP Bahrein", d: "02 Mar", t: "16:00" }, { r: "GP Saudi Arabia", d: "09 Mar", t: "18:00" }, { r: "GP Australia", d: "24 Mar", t: "05:00" }, { r: "GP Japan", d: "07 Apr", t: "07:00" }, { r: "GP China", d: "21 Apr", t: "09:00" }, { r: "GP Miami", d: "05 May", t: "22:00" }, { r: "GP Emilia Romagna", d: "19 May", t: "15:00" }, { r: "GP Monaco", d: "26 May", t: "15:00" }, { r: "GP Canada", d: "09 Jun", t: "20:00" }, { r: "GP Spain", d: "23 Jun", t: "15:00" } ], 
        s: [ { p: 1, n: "Verstappen", fl: "üá≥üá±", pt: 25 }, { p: 2, n: "Norris", fl: "üá¨üáß", pt: 18 }, { p: 3, n: "Leclerc", fl: "üá≤üá®", pt: 15 }, { p: 4, n: "Sainz", fl: "üá™üá∏", pt: 12 }, { p: 5, n: "Russell", fl: "üá¨üáß", pt: 10 }, { p: 6, n: "Hamilton", fl: "üá¨üáß", pt: 8 }, { p: 7, n: "Piastri", fl: "üá¶üá∫", pt: 6 }, { p: 8, n: "Alonso", fl: "üá™üá∏", pt: 4 }, { p: 9, n: "Perez", fl: "üá≤üáΩ", pt: 2 }, { p: 10, n: "Stroll", fl: "üá®üá¶", pt: 1 } ], 
        lst: { title: 'GP Abu Dhabi', res: [ { p: 1, n: 'Verstappen', time: '1:27:02' }, { p: 2, n: 'Leclerc', time: '+17.9s' }, { p: 3, n: 'Russell', time: '+20.3s' }, { p: 4, n: 'Norris', time: '+22.7s' }, { p: 5, n: 'Piastri', time: '+31.4s' }, { p: 6, n: 'Sainz', time: '+33.1s' }, { p: 7, n: 'Hamilton', time: '+35.8s' }, { p: 8, n: 'Alonso', time: '+38.5s' }, { p: 9, n: 'Perez', time: '+40.1s' }, { p: 10, n: 'Stroll', time: '+45.0s' } ] } 
    };
    
    const golfPga = { 
        c: [ { r: "The Players", d: "14 Mar", t: "14:00 NL" }, { r: "The Masters", d: "10 Apr", t: "15:00 NL" }, { r: "RBC Heritage", d: "18 Apr", t: "14:00 NL" }, { r: "PGA Champ", d: "16 May", t: "14:00 NL" }, { r: "US Open", d: "13 Jun", t: "15:00 NL" }, { r: "Travelers Champ", d: "20 Jun", t: "14:00 NL" }, { r: "Scottish Open", d: "11 Jul", t: "09:00 NL" }, { r: "The Open", d: "18 Jul", t: "09:00 NL" }, { r: "FedEx St. Jude", d: "15 Aug", t: "14:00 NL" }, { r: "BMW Champ", d: "22 Aug", t: "14:00 NL" } ], 
        s: [ { p: 1, n: "Scheffler", fl: "üá∫üá∏", pt: "3200" }, { p: 2, n: "Kim", fl: "üá∞üá∑", pt: "2100" }, { p: 3, n: "McIlroy", fl: "üá¨üáß", pt: "1950" }, { p: 4, n: "Schauffele", fl: "üá∫üá∏", pt: "1800" }, { p: 5, n: "Rahm", fl: "üá∫üá∏", pt: "1700" }, { p: 6, n: "Clark", fl: "üá∫üá∏", pt: "1500" }, { p: 7, n: "Hovland", fl: "üá≥üá¥", pt: "1400" }, { p: 8, n: "Cantlay", fl: "üá∫üá∏", pt: "1350" }, { p: 9, n: "Aberg", fl: "üá≥üá¥", pt: "1300" }, { p: 10, n: "Harman", fl: "üá∫üá∏", pt: "1200" } ], 
        lst: { title: 'Arnold Palmer Inv.', res: [ { p: 1, n: 'Scheffler', time: '-15' }, { p: 2, n: 'Clark', time: '-14' }, { p: 3, n: 'Lowry', time: '-13' }, { p: 4, n: 'Zalatoris', time: '-12' }, { p: 5, n: 'Theegala', time: '-11' }, { p: 6, n: 'Burns', time: '-10' }, { p: 7, n: 'McIlroy', time: '-9' }, { p: 8, n: 'Kim', time: '-8' }, { p: 9, n: 'Schauffele', time: '-7' }, { p: 10, n: 'Hovland', time: '-6' } ] } 
    };
    
    const golfDp = { 
        c: [ { r: "Singapore Open", d: "21 Mar", t: "08:00 NL" }, { r: "Indian Open", d: "28 Mar", t: "09:00 NL" }, { r: "Korea Champ", d: "18 Apr", t: "08:00 NL" }, { r: "ISPS Handa", d: "25 Apr", t: "07:00 NL" }, { r: "China Open", d: "02 May", t: "06:00 NL" }, { r: "Soudal Open", d: "23 May", t: "10:00 NL" }, { r: "European Open", d: "30 May", t: "09:00 NL" }, { r: "KLM Open", d: "06 Jun", t: "09:00 NL" }, { r: "BMW Int", d: "20 Jun", t: "10:00 NL" }, { r: "Italian Open", d: "04 Jul", t: "09:00 NL" } ], 
        s: [ { p: 1, n: "McIlroy", fl: "üá¨üáß", pt: "2500" }, { p: 2, n: "Kim", fl: "üá∞üá∑", pt: "2100" }, { p: 3, n: "Fleetwood", fl: "üá¨üáß", pt: "1950" }, { p: 4, n: "Fox", fl: "üá¨üáß", pt: "1800" }, { p: 5, n: "Meronk", fl: "üáµüá±", pt: "1600" }, { p: 6, n: "MacIntyre", fl: "üá¨üáß", pt: "1500" }, { p: 7, n: "Olesen", fl: "üá¨üáß", pt: "1400" }, { p: 8, n: "Hojgaard", fl: "üá©üá∞", pt: "1350" }, { p: 9, n: "Campillo", fl: "üá™üá∏", pt: "1300" }, { p: 10, n: "Perez", fl: "üá´üá∑", pt: "1200" } ], 
        lst: { title: 'Dubai Desert Classic', res: [ { p: 1, n: 'McIlroy', time: '-14' }, { p: 2, n: 'Meronk', time: '-13' }, { p: 3, n: 'Kim', time: '-12' }, { p: 4, n: 'Scott', time: '-11' }, { p: 5, n: 'Fox', time: '-10' }, { p: 6, n: 'Fleetwood', time: '-9' }, { p: 7, n: 'MacIntyre', time: '-8' }, { p: 8, n: 'Olesen', time: '-7' }, { p: 9, n: 'Hojgaard', time: '-6' }, { p: 10, n: 'Perez', time: '-5' } ] } 
    };

    const gData = golfTour === 'PGA' ? golfPga : golfDp;
    const match = (s) => s.toLowerCase().includes(search.toLowerCase());

    const fF1c = f1Data.c.filter(x => !search || match(x.r));
    const fF1s = f1Data.s.filter(x => !search || match(x.n));
    const fF1lstRes = f1Data.lst.res.filter(x => !search || match(x.n));
    const f1LstMatch = fF1lstRes.length > 0 || match(f1Data.lst.title); 

    const fGc = gData.c.filter(x => !search || match(x.r));
    const fGs = gData.s.filter(x => !search || match(x.n));
    const fGlstRes = gData.lst.res.filter(x => !search || match(x.n));
    const gLstMatch = fGlstRes.length > 0 || match(gData.lst.title);

    const MoreBtn = ({ e, setE, t1, e1 }) => (
        <button onClick={() => setE(!e)} className="w-full mt-2 bg-gray-50 hover:bg-gray-100 border text-gray-500 text-[9px] font-bold py-1.5 rounded uppercase transition shadow-sm">
            {e ? (lang==='nl'?'Minder tonen':'Show less') : (lang==='nl'?t1:e1)}
        </button>
    );

    return (
        <div className="widget h-[450px]">
            <div className="p-4 border-b bg-gray-50 flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2 text-gray-500">
                    <Ico.Trp/><h3 className="text-[10px] font-black uppercase tracking-widest">Sport</h3>
                </div>
                <input type="text" placeholder={lang==='nl'?"Zoek (bijv. Verstappen)":"Search..."} value={search} onChange={e=>setSearch(e.target.value)} className="w-1/2 px-2 py-1 text-[10px] border rounded outline-none focus:border-blue-500 shadow-sm" />
            </div>
            <div className="flex border-b bg-white shrink-0">
                {[ {id:'cal', l:T[lang].cal}, {id:'lst', l:T[lang].lst}, {id:'std', l:T[lang].std} ].map(t => <button key={t.id} onClick={() => setTab(t.id)} className={`tab-btn ${tab === t.id ? 'active' : ''}`}>{t.l}</button>)}
            </div>
            <div className="p-4 flex-1 overflow-y-auto space-y-6 bg-white hide-scroll">
                
                {((tab === 'cal' && fF1c.length>0) || (tab === 'std' && fF1s.length>0) || (tab === 'lst' && f1LstMatch)) && (
                <div>
                    <div className="flex items-center gap-2 mb-2 border-b border-gray-100 pb-1"><Ico.F1/><span className="text-[10px] font-black uppercase text-[#0073b1]">F1</span></div>
                    <div className="space-y-1">
                        {tab === 'cal' && fF1c.slice(0, eF1C ? 10 : 3).map(r => <div key={r.r} className="flex justify-between items-center text-xs p-2 bg-gray-50 rounded border"><div className="flex flex-col"><span className="font-bold">{r.r}</span><span className="text-[9px] font-black text-gray-400 mt-0.5">{r.d}</span></div><span className="font-mono text-blue-600 font-bold">{r.t}</span></div>)}
                        {tab === 'cal' && fF1c.length > 3 && <MoreBtn e={eF1C} setE={setEF1C} t1="Toon 10 events" e1="Show 10 events" />}
                        
                        {tab === 'std' && fF1s.slice(0, eF1S ? 10 : 3).map((s,i) => <div key={s.n} className="flex justify-between items-center text-xs p-2 border-b"><div className="flex gap-3 items-center"><span className="font-black w-4">{s.p===1?'ü•á':s.p===2?'ü•à':s.p===3?'ü•â':s.p}</span><span className="text-base">{s.fl}</span><span className="font-bold">{s.n.toUpperCase()}</span></div><span className="bg-gray-800 text-white px-2 py-0.5 rounded font-mono font-bold text-[9px]">{s.pt}</span></div>)}
                        {tab === 'std' && fF1s.length > 3 && <MoreBtn e={eF1S} setE={setEF1S} t1="Volledige stand" e1="Full standings" />}

                        {tab === 'lst' && f1LstMatch && (
                            <div className="flex flex-col gap-1">
                                <div className="bg-blue-50 text-blue-800 font-bold text-center py-1.5 rounded uppercase text-[9px] mb-1">{f1Data.lst.title}</div>
                                {fF1lstRes.slice(0, eF1L ? 10 : 3).map((r, i) => (
                                    <div key={r.n} className={`flex justify-between items-center text-xs p-2 border-b ${r.p===1?'bg-yellow-50 border-yellow-300 rounded':''}`}>
                                        <div className="flex gap-3 items-center">
                                            <span className="font-black w-4">{r.p===1?'ü•á':r.p===2?'ü•à':r.p===3?'ü•â':r.p}</span>
                                            <span className="font-bold">{r.n.toUpperCase()}</span>
                                        </div>
                                        <span className="text-gray-500 font-mono text-[9px]">{r.time}</span>
                                    </div>
                                ))}
                                {fF1lstRes.length > 3 && <MoreBtn e={eF1L} setE={setEF1L} t1="Volledige uitslag" e1="Full results" />}
                            </div>
                        )}
                    </div>
                </div>
                )}

                {((tab === 'cal' && fGc.length>0) || (tab === 'std' && fGs.length>0) || (tab === 'lst' && gLstMatch)) && (
                <div>
                    <div className="flex items-center justify-between mb-2 border-b border-gray-100 pb-1">
                        <div className="flex items-center gap-2"><Ico.Glf/><span className="text-[10px] font-black uppercase text-[#0073b1]">GOLF</span></div>
                        <div className="flex gap-1 bg-gray-100 p-0.5 rounded">
                            <button onClick={()=>setGolfTour('PGA')} className={`px-2 py-0.5 text-[8px] font-bold rounded uppercase ${golfTour==='PGA'?'bg-white shadow-sm text-blue-700':'text-gray-500'}`}>PGA</button>
                            <button onClick={()=>setGolfTour('DP')} className={`px-2 py-0.5 text-[8px] font-bold rounded uppercase ${golfTour==='DP'?'bg-white shadow-sm text-blue-700':'text-gray-500'}`}>DP</button>
                        </div>
                    </div>
                    <div className="space-y-1">
                        {tab === 'cal' && fGc.slice(0, eGC ? 10 : 3).map(r => <div key={r.r} className="flex justify-between items-center text-xs p-2 bg-gray-50 rounded border"><div className="flex flex-col"><span className="font-bold">{r.r}</span><span className="text-[9px] font-black text-gray-400 mt-0.5">{r.d}</span></div><span className="font-mono text-blue-600 font-bold">{r.t}</span></div>)}
                        {tab === 'cal' && fGc.length > 3 && <MoreBtn e={eGC} setE={setEGC} t1="Toon 10 events" e1="Show 10 events" />}
                        
                        {tab === 'std' && fGs.slice(0, eGS ? 10 : 3).map((s,i) => <div key={s.n} className="flex justify-between items-center text-xs p-2 border-b"><div className="flex gap-3 items-center"><span className="font-black w-4">{s.p===1?'ü•á':s.p===2?'ü•à':s.p===3?'ü•â':s.p}</span><span className="text-base">{s.fl}</span><span className="font-bold">{s.n.toUpperCase()}</span></div><span className="bg-gray-800 text-white px-2 py-0.5 rounded font-mono font-bold text-[9px]">{s.pt}</span></div>)}
                        {tab === 'std' && fGs.length > 3 && <MoreBtn e={eGS} setE={setEGS} t1="Volledige stand" e1="Full standings" />}

                        {tab === 'lst' && gLstMatch && (
                            <div className="flex flex-col gap-1">
                                <div className="bg-green-50 text-green-800 font-bold text-center py-1.5 rounded uppercase text-[9px] mb-1">{gData.lst.title}</div>
                                {fGlstRes.slice(0, eGL ? 10 : 3).map((r, i) => (
                                    <div key={r.n} className={`flex justify-between items-center text-xs p-2 border-b ${r.p===1?'bg-green-100 border-green-300 rounded':''}`}>
                                        <div className="flex gap-3 items-center">
                                            <span className="font-black w-4">{r.p===1?'ü•á':r.p===2?'ü•à':r.p===3?'ü•â':r.p}</span>
                                            <span className="font-bold">{r.n.toUpperCase()}</span>
                                        </div>
                                        <span className="text-gray-500 font-mono text-[9px]">{r.time}</span>
                                    </div>
                                ))}
                                {fGlstRes.length > 3 && <MoreBtn e={eGL} setE={setEGL} t1="Volledige uitslag" e1="Full results" />}
                            </div>
                        )}
                    </div>
                </div>
                )}
                
                {search && fF1c.length===0 && fF1s.length===0 && !f1LstMatch && fGc.length===0 && fGs.length===0 && !gLstMatch && (
                    <div className="text-center text-gray-400 text-[10px] font-bold py-10 uppercase">Geen resultaten voor '{search}'</div>
                )}
            </div>
        </div>
    );
}

function Settings({ isOpen, onClose, layout, setLayout }) {
    const [bvKeys, setBvKeys] = useState(S.load('bitvavo_keys', {pub: '', sec: ''}));
    const [apis, setApis] = useState(S.load('api_keys_dyn', [{name: 'Groq', val: ''}]));
    const [icals, setIcals] = useState(S.load('icals_dyn', [{name: 'Ryan', val: ''}, {name: 'Yaron', val: ''}, {name: 'Michael', val: ''}, {name: 'Fam-Sch', val: ''}]));
    const [aiUrl, setAiUrl] = useState(S.load('ai_chat_url', ''));
    const [dragIdx, setDragIdx] = useState(null);
    const [isSaving, setIsSaving] = useState(false);

    const handleDragStart = (e, idx) => { setDragIdx(idx); e.dataTransfer.effectAllowed = "move"; };
    const handleDrop = (e, idx) => { e.preventDefault(); if (dragIdx === null || dragIdx === idx) return; const n = [...layout]; const item = n.splice(dragIdx, 1)[0]; n.splice(idx, 0, item); setLayout(n); S.save('layout_v7', n); setDragIdx(null); };
    const move = (idx, dir) => { if((dir===-1 && idx===0) || (dir===1 && idx===layout.length-1)) return; const n = [...layout]; const temp = n[idx]; n[idx] = n[idx+dir]; n[idx+dir] = temp; setLayout(n); S.save('layout_v7', n); };

    const saveAll = async () => { 
        setIsSaving(true);
        S.save('bitvavo_keys', bvKeys); 
        S.save('api_keys_dyn', apis); 
        S.save('icals_dyn', icals); 
        S.save('ai_chat_url', aiUrl); 
        S.save('layout_v7', layout);
        
        const cloudSettings = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('d_')) {
                cloudSettings[key.substring(2)] = JSON.parse(localStorage.getItem(key));
            }
        }

        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: ALLOWED_EMAIL, settings: cloudSettings })
            });
            const dbData = await res.json();
            
            if (!res.ok || dbData.error) {
                alert("FOUT BIJ OPSLAAN: " + (dbData.error || res.statusText));
                setIsSaving(false);
                return; 
            }
        } catch(e) { 
            alert("NETWERK FOUT BIJ OPSLAAN: " + e.message); 
            setIsSaving(false);
            return; 
        }

        setIsSaving(false);
        onClose(); 
        window.location.reload(); 
    };

    return (
        <div className={`settings-panel p-6 md:p-8 flex flex-col ${isOpen ? 'open' : ''}`}>
            <div className="flex justify-between items-center mb-8 border-b pb-4"><h2 className="text-2xl font-black uppercase">Configuratie</h2><button onClick={onClose} className="text-3xl text-gray-400 hover:text-gray-800 transition">&times;</button></div>
            <div className="space-y-8 flex-1">
                <section>
                    <h3 className="text-[10px] font-black text-blue-600 uppercase mb-4">Dashboard Indeling (Drag & Drop)</h3>
                    <div className="space-y-1">
                        {layout.map((w, i) => (
                            <div key={w} draggable onDragStart={(e)=>handleDragStart(e, i)} onDragOver={(e)=>e.preventDefault()} onDrop={(e)=>handleDrop(e, i)} className="flex justify-between items-center bg-white p-3 border rounded shadow-sm cursor-move hover:border-blue-400 transition">
                                <div className="flex items-center gap-3"><Ico.Drag /><span className="text-xs font-bold uppercase">{w}</span></div>
                                <div className="flex gap-2"><button onClick={()=>move(i, -1)} className="text-gray-400 hover:text-blue-600"><Ico.Up/></button><button onClick={()=>move(i, 1)} className="text-gray-400 hover:text-blue-600"><Ico.Dn/></button></div>
                            </div>
                        ))}
                    </div>
                </section>

                <section>
                    <h3 className="text-[10px] font-black text-blue-600 uppercase mb-4">Bitvavo Koppeling (Live)</h3>
                    <div className="space-y-2">
                        <input type="text" placeholder="Bitvavo API Key" value={bvKeys.pub} onChange={e=>setBvKeys({...bvKeys, pub: e.target.value})} className="w-full p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                        <input type="password" placeholder="Bitvavo API Secret" value={bvKeys.sec} onChange={e=>setBvKeys({...bvKeys, sec: e.target.value})} className="w-full p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                    </div>
                </section>

                <section>
                    <div className="flex justify-between items-center mb-4"><h3 className="text-[10px] font-black text-blue-600 uppercase">Overige API Keys</h3><button onClick={()=>setApis([...apis, {name:'', val:''}])} className="bg-blue-100 text-blue-700 px-2 rounded font-bold">+</button></div>
                    {apis.map((a, i) => (
                        <div key={i} className="flex gap-2 mb-2">
                            <input placeholder="Naam (bijv. Groq)" value={a.name} onChange={e=>{const n=[...apis]; n[i].name=e.target.value; setApis(n);}} className="w-1/3 p-2.5 border rounded text-xs font-bold bg-gray-50 outline-none focus:border-blue-500" />
                            <input type="password" placeholder="API Key..." value={a.val} onChange={e=>{const n=[...apis]; n[i].val=e.target.value; setApis(n);}} className="flex-1 p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                            <button onClick={()=>{const n=apis.filter((_,idx)=>idx!==i); setApis(n);}} className="text-red-400 hover:text-red-600 font-bold px-1">&times;</button>
                        </div>
                    ))}
                </section>

                <section>
                    <div className="flex justify-between items-center mb-4"><h3 className="text-[10px] font-black text-blue-600 uppercase">Live iCal Links (.ics)</h3><button onClick={()=>setIcals([...icals, {name:'', val:''}])} className="bg-blue-100 text-blue-700 px-2 rounded font-bold">+</button></div>
                    {icals.map((c, i) => (
                        <div key={i} className="flex gap-2 mb-2">
                            <input placeholder="Naam (bijv. Werk)" value={c.name} onChange={e=>{const n=[...icals]; n[i].name=e.target.value; setIcals(n);}} className="w-1/3 p-2.5 border rounded text-xs font-bold bg-gray-50 outline-none focus:border-blue-500" />
                            <input type="text" placeholder="https://..." value={c.val} onChange={e=>{const n=[...icals]; n[i].val=e.target.value; setIcals(n);}} className="flex-1 p-2.5 border rounded text-xs font-mono bg-gray-50 outline-none focus:border-blue-500" />
                            <button onClick={()=>{const n=icals.filter((_,idx)=>idx!==i); setIcals(n);}} className="text-red-400 hover:text-red-600 font-bold px-1">&times;</button>
                        </div>
                    ))}
                </section>

                <section className="bg-gray-50 p-4 rounded border border-gray-200">
                    <h3 className="text-[10px] font-black text-gray-800 uppercase mb-3">Systeem & AI Beheer</h3>
                    <label className="text-[9px] font-bold text-gray-500 uppercase block mb-1">AI Chat URL (Voor updates)</label>
                    <div className="flex gap-2">
                        <input type="text" placeholder="Link van AI chat..." value={aiUrl} onChange={e=>setAiUrl(e.target.value)} className="flex-1 p-3 border rounded text-xs font-mono bg-white shadow-sm outline-none focus:border-blue-500" />
                        <a href={aiUrl || '#'} target="_blank" className="bg-blue-600 text-white px-4 rounded flex items-center justify-center font-bold text-xs hover:bg-blue-700 transition">Open</a>
                    </div>
                </section>
            </div>
            
            <div className="mt-8 shrink-0">
                <button onClick={saveAll} disabled={isSaving} className="w-full bg-[#1a1a1a] text-white py-4 text-[10px] font-black uppercase rounded shadow-lg hover:bg-black transition disabled:opacity-50">
                    {isSaving ? 'BEZIG MET CLOUD SYNC...' : 'OPSLAAN & HERLADEN (CLOUD SYNC)'}
                </button>
                <button onClick={() => { S.remove('auth_status'); window.location.reload(); }} className="mt-4 w-full bg-red-500/10 text-red-500 py-3 text-[10px] font-black uppercase rounded hover:bg-red-500 hover:text-white transition flex items-center justify-center gap-2">
                    Uitloggen <Ico.Lock />
                </button>
            </div>
        </div>
    );
}

function App() {
    const [isAuth, setIsAuth] = useState(S.load('auth_status', false));
    const [isSyncing, setIsSyncing] = useState(false);
    
    const [settingsOpen, setSettingsOpen] = useState(false);
    const [lang, setLang] = useState('nl');
    
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    
    const defaultLayout = ['ai', 'crypto', 'agenda', 'news', 'radar', 'sports'];
    const [layout, setLayout] = useState(defaultLayout);

    useEffect(() => {
        const doSync = async () => {
            if (isAuth) {
                setIsSyncing(true);
                try {
                    const res = await fetch(`/api/settings?email=${ALLOWED_EMAIL}&t=${Date.now()}`, { cache: 'no-store' });
                    if(res.ok) {
                        let cloudData = await res.json();
                        
                        if (typeof cloudData === 'string') {
                            try { cloudData = JSON.parse(cloudData); } catch(e) {}
                        }

                        if (cloudData && typeof cloudData === 'object' && Object.keys(cloudData).length > 0) {
                            Object.keys(cloudData).forEach(k => S.save(k, cloudData[k]));
                        }
                    }
                } catch(e) { console.error("Auto-sync mislukt", e); }
                
                setLang(S.load('lang', 'nl'));
                setLayout(S.load('layout_v7', defaultLayout));
                setIsSyncing(false); 
            }
        };
        doSync();
    }, [isAuth]);

    useEffect(() => {
        if (!isAuth && window.google) {
            window.google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredentialResponse });
            window.google.accounts.id.renderButton(document.getElementById("google-btn"), { theme: "filled_blue", size: "large", shape: "pill" });
        }
    }, [isAuth]);

    const handleCredentialResponse = async (response) => {
        try {
            const payload = JSON.parse(atob(response.credential.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
            if(payload.email.toLowerCase() === ALLOWED_EMAIL.toLowerCase()) { 
                S.save('auth_status', true);
                setIsAuth(true); 
            } else { 
                alert("Toegang geweigerd! Dit account heeft geen permissie."); 
            }
        } catch(e) { console.error("Login failed"); }
    };

    if (!isAuth || isSyncing) {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center bg-[#000a14] text-white">
                <div className="bg-white/10 p-10 rounded-2xl border border-white/10 shadow-2xl flex flex-col items-center backdrop-blur-md">
                    <Ico.Lock />
                    <h1 className="text-2xl font-black mt-4 mb-2 tracking-widest uppercase">Secured Access</h1>
                    <p className="text-xs text-gray-400 mb-8">{isSyncing ? 'Synchroniseren met cloud database...' : 'Personal Dashboard ver. 4.2'}</p>
                    {!isSyncing && <div id="google-btn"></div>}
                </div>
            </div>
        );
    }

    const widgets = { 
        ai: <div className="col-span-12 lg:col-span-8"><AIWidget lang={lang} /></div>, 
        crypto: <div className="col-span-12 lg:col-span-4"><CryptoWidget lang={lang} /></div>, 
        agenda: <div className="col-span-12 lg:col-span-4"><AgendaWidget lang={lang} /></div>, 
        news: <div className="col-span-12 lg:col-span-8"><NewsWidget lang={lang} /></div>, 
        radar: <div className="col-span-12 lg:col-span-4"><RadarWidget lang={lang} /></div>, 
        sports: <div className="col-span-12 lg:col-span-4"><SportsWidget lang={lang} /></div> 
    };

    const hour = new Date().getHours();
    let greetingNL = 'Goedenavond'; let greetingEN = 'Good evening';
    if (hour >= 6 && hour < 12) { greetingNL = 'Goedemorgen'; greetingEN = 'Good morning'; } 
    else if (hour >= 12 && hour < 18) { greetingNL = 'Goedemiddag'; greetingEN = 'Good afternoon'; }
    const dynamicGreeting = lang === 'nl' ? greetingNL : greetingEN;

    return (
        <div className="flex flex-col min-h-screen">
            <WeatherBar lang={lang} />
            <header className="px-6 md:px-10 py-5 max-w-[1600px] mx-auto w-full flex justify-between items-center border-b border-white/10 mb-6">
                <div>
                    <h1 className="text-xl md:text-2xl font-black text-white tracking-tight drop-shadow-md leading-none">
                        {dynamicGreeting} Michael
                    </h1>
                </div>
                <div className="flex gap-2 md:gap-3 items-center">
                    {isStandalone && (
                        <button onClick={() => window.location.reload()} className="w-10 h-10 flex items-center justify-center bg-white/10 text-white rounded hover:bg-white/20 transition" title="Ververs Dashboard">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        </button>
                    )}
                    <button onClick={() => {const nL=lang==='nl'?'en':'nl'; setLang(nL); S.save('lang', nL)}} className="h-10 px-4 flex items-center justify-center bg-white/10 text-white rounded hover:bg-white/20 transition font-bold text-xs uppercase tracking-widest">
                        {lang === 'nl' ? 'NL / EN' : 'EN / NL'}
                    </button>
                    <button onClick={() => setSettingsOpen(true)} className="w-10 h-10 flex items-center justify-center bg-white/10 text-white rounded hover:bg-white/20 transition">
                        <Ico.Set />
                    </button>
                </div>
            </header>
            <main className="px-6 md:px-10 pb-16 max-w-[1600px] mx-auto w-full">
                <div className="grid grid-cols-12 gap-6 md:gap-8">
                    {layout.map(w => <React.Fragment key={w}>{widgets[w]}</React.Fragment>)}
                </div>
            </main>
            <Settings isOpen={settingsOpen} onClose={() => setSettingsOpen(false)} layout={layout} setLayout={setLayout} />
        </div>
    );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
